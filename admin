
<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Bear POS - Pro Badini (V3.2 Fixed)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --brand: #171717;
            --brand-hover: #404040;
            --dark: #000000;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #1f2937;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            --sidebar-w: 260px;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* --- PROFESSIONAL PRINT DESIGN (FIXED BADINI & LOGO) --- */
        #printable-area { display: none; }
        
        @media print {
            @page { margin: 0; size: auto; }
            body * { visibility: hidden; height: 0; overflow: hidden; margin: 0; padding: 0; }
            #printable-area, #printable-area * { visibility: visible; height: auto; overflow: visible; }
            #printable-area { 
                display: block; 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                background: white;
                color: black;
                z-index: 99999;
                padding: 0;
            }
            .sidebar, .modal-overlay, .top-bar, .no-print, .save-indicator, #pos-menu { display: none !important; }

            /* THERMAL RECEIPT STYLE (80mm Optimized - RTL) */
            .print-thermal-container {
                direction: rtl; /* RIGHT TO LEFT FOR KURDISH */
                page-break-inside: avoid;
                width: 100%;
                max-width: 78mm;
                margin: 0 auto;
                text-align: center;
                font-family: 'Tahoma', 'Arial', sans-serif; /* Better for Arabic Script */
                font-size: 14px;
                font-weight: 600;
                padding-bottom: 20px;
                color: #000;
            }
            
            .thermal-logo {
                max-width: 60%;
                height: auto;
                margin: 0 auto 5px auto;
                display: block;
                filter: grayscale(100%) contrast(150%); /* Optimize for thermal print */
            }

            .thermal-header h1 { margin: 5px 0 0 0; font-size: 1.6rem; font-weight: 800; }
            .thermal-header p { margin: 2px 0; font-size: 0.9rem; }
            
            .thermal-divider { 
                border-top: 2px dashed #000; 
                margin: 8px 0; 
                width: 100%;
            }

            .thermal-info {
                display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px;
            }

            .thermal-table { width: 100%; border-collapse: collapse; text-align: right; margin-top: 5px; }
            .thermal-table th { border-bottom: 2px solid #000; font-size: 0.9rem; padding-bottom: 5px; text-align: right; }
            .thermal-table td { padding: 6px 0; vertical-align: top; font-size: 1rem; }
            
            .row-item { text-align: right; width: 50%; font-weight: bold; }
            .row-qty { text-align: center; width: 15%; }
            .row-price { text-align: left; width: 35%; }

            .thermal-totals { margin-top: 15px; text-align: left; direction: ltr; /* Keeping numbers readable */ }
            .thermal-totals-rtl { margin-top: 15px; text-align: right; direction: rtl; }
            
            .total-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 1.1rem; }
            .grand-total { 
                font-size: 1.6rem; 
                font-weight: 900; 
                border-top: 3px solid #000; 
                border-bottom: 3px solid #000; 
                padding: 10px 0; 
                margin-top: 10px; 
            }

            .thermal-footer { margin-top: 20px; text-align: center; font-size: 0.9rem; font-weight: bold; }
            
            /* KITCHEN SPECIFIC */
            .kitchen-row { display: flex; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 5px; }
            .kitchen-qty { font-size: 1.6rem; font-weight: 900; border: 3px solid #000; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; margin-left: 10px; flex-shrink: 0; }
            .kitchen-item { font-size: 1.4rem; font-weight: 800; text-align: right; flex: 1; }
            .kitchen-note { display: block; font-size: 1rem; font-weight: bold; margin-right: 60px; margin-bottom: 8px; font-style: italic; }
            .kitchen-box { border: 3px solid #000; padding: 15px; border-radius: 5px; margin-top: 10px; }

            /* A4 REPORT STYLES - ENHANCED */
            .print-a4-container {
                width: 210mm;
                min-height: 297mm;
                margin: 0 auto;
                padding: 20mm;
                background: white;
                color: black;
                font-family: 'Segoe UI', sans-serif;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            
            .print-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 3px solid #000;
                padding-bottom: 20px;
                margin-bottom: 30px;
            }
            
            .print-summary-box {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 20px;
                margin: 30px 0;
            }
            
            .p-box {
                background: #f8fafc;
                border-radius: 15px;
                padding: 20px;
                text-align: center;
                border: 2px solid #e2e8f0;
                box-shadow: 0 4px 6px rgba(0,0,0,0.05);
                transition: transform 0.3s;
            }
            
            .p-box:hover {
                transform: translateY(-5px);
                box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            }
            
            .p-box h3 {
                font-size: 1.2rem;
                margin-bottom: 10px;
                color: #4b5563;
            }
            
            .p-box h2 {
                font-size: 2rem;
                margin: 10px 0;
            }
            
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                border-radius: 8px;
                overflow: hidden;
            }
            
            .print-table th {
                background: #1f2937;
                color: white;
                padding: 15px;
                text-align: right;
                font-weight: 600;
            }
            
            .print-table td {
                padding: 12px;
                border-bottom: 1px solid #e2e8f0;
                text-align: right;
            }
            
            .print-table tr:nth-child(even) {
                background: #f9fafb;
            }
            
            .print-table tr:hover {
                background: #f3f4f6;
            }
            
            .section-title {
                font-size: 1.4rem;
                margin-top: 40px;
                padding-bottom: 10px;
                border-bottom: 2px solid #e2e8f0;
                color: #1f2937;
                font-weight: 700;
            }
            
            .report-footer {
                margin-top: 60px;
                text-align: center;
                padding-top: 20px;
                border-top: 2px solid #e2e8f0;
                color: #6b7280;
                font-size: 0.9rem;
            }
        }

        /* UI ELEMENTS */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95);
            z-index: 9999; display: flex; justify-content: center; align-items: center; color: white;
            backdrop-filter: blur(10px);
        }
        .glass-card {
            background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(20px);
            padding: 40px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1);
            width: 500px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.8);
        }
        
        /* Company Profile Modal & Tabs */
        .profile-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; justify-content: center; align-items: center;
        }
        .profile-content {
            background: white; width: 95%; max-width: 1200px; height: 90vh;
            border-radius: 20px; padding: 0; display: flex; flex-direction: column;
            overflow: hidden; color: black; position: relative;
        }
        .profile-header {
            background: var(--brand); color: white; padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .profile-tabs { display: flex; background: #e5e7eb; padding: 5px; gap: 5px; }
        .tab-btn {
            flex: 1; padding: 15px; border: none; background: transparent; cursor: pointer;
            font-weight: bold; font-size: 1rem; border-radius: 5px; transition: 0.2s;
        }
        .tab-btn.active { background: white; color: var(--brand); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-content { display: none; flex: 1; overflow-y: auto; padding: 20px; background: #f9fafb; }
        .tab-content.active { display: block; }

        .pin-input {
            width: 100%; padding: 15px; text-align: center; font-size: 1.5rem; letter-spacing: 10px;
            border-radius: 12px; border: none; outline: none; margin-bottom: 20px;
            background: white; color: black;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-w); background: var(--dark); color: #9ca3af;
            display: flex; flex-direction: column; transition: 0.3s;
        }
        .sidebar-header { 
            padding: 30px; text-align: center; color: white; font-size: 1.5rem; 
            font-weight: bold; border-bottom: 1px solid #374151; letter-spacing: 1px;
        }
        .nav-item {
            padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px;
            transition: 0.2s; border-right: 4px solid transparent;
        }
        .nav-item:hover, .nav-item.active { background: #262626; color: white; border-right-color: white; }

        /* CONTENT */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        #connection-warning {
            background: #ff4757; color: white; text-align: center; padding: 5px; font-size: 0.9rem;
            display: none; animation: pulse 2s infinite; cursor: pointer;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .top-bar {
            height: 70px; background: var(--card); display: flex; align-items: center;
            justify-content: space-between; padding: 0 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 10;
        }
        .workspace { flex: 1; padding: 20px; overflow-y: auto; display: none; background: var(--bg); }
        .workspace.active { display: block; animation: fadeIn 0.3s ease; }

        /* COMPONENTS */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-right: 5px solid var(--brand); }
        .stat-card h3 { margin: 0; font-size: 0.9rem; opacity: 0.7; }
        .stat-card h1 { margin: 10px 0 0; font-size: 1.8rem; }

        .btn {
            padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer;
            font-weight: bold; transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-brand { background: var(--brand); color: white; }
        .btn-brand:hover { background: var(--brand-hover); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-dark { background: var(--dark); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 8px; }

        .card { background: var(--card); border-radius: 18px; padding: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-std, select.input-std { width: 100%; padding: 12px; border: 1.5px solid #e2e8f0; border-radius: 10px; margin-bottom: 10px; outline: none; transition: 0.2s; background: white; }
        
        /* IMPROVED PRODUCT FORM */
        .form-grid-layout {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;
        }
        .form-section {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 15px; padding: 15px;
            position: relative;
        }
        .form-section-title {
            position: absolute; top: -12px; right: 15px; background: white; padding: 0 10px;
            color: var(--brand); font-weight: bold; font-size: 0.9rem; border: 1px solid #e2e8f0; border-radius: 20px;
        }
        
        .radio-group { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom:10px; }
        .radio-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; }
        .radio-label input { width: 18px; height: 18px; accent-color: var(--brand); }

        /* ITEM SELECTION GRID */
        .item-select-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px; max-height: 250px; overflow-y: auto;
            border: 2px solid #e5e7eb; padding: 15px; border-radius: 12px; margin-bottom: 15px;
            background: #f9fafb;
        }
        .item-select-card {
            background: white; border: 2px solid transparent; border-radius: 10px;
            padding: 10px; text-align: center; cursor: pointer; transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .item-select-card:hover { transform: translateY(-3px); }
        .item-select-card.selected { border-color: var(--brand); background: #f3f4f6; position: relative; }

        /* POS UI */
        .pos-layout { display: flex; gap: 20px; height: calc(100vh - 110px); }
        .pos-menu { flex: 7; display: flex; flex-direction: column; overflow: hidden; }
        .pos-bill { flex: 3; background: var(--card); border-radius: 20px; display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.05); overflow: hidden; }
        
        .category-bar { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; white-space: nowrap; }
        .category-bar::-webkit-scrollbar { height: 5px; }
        
        .cat-btn {
            padding: 12px 25px; border-radius: 50px; border: 1px solid #e2e8f0; background: white;
            cursor: pointer; font-weight: bold; color: var(--text); transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .cat-btn.active, .cat-btn:hover { background: var(--brand); color: white; border-color: var(--brand); transform: translateY(-2px); }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; overflow-y: auto; padding: 5px; flex: 1; }
        .p-card {
            background: white; border-radius: 16px; padding: 20px 10px; text-align: center;
            cursor: pointer; transition: 0.2s; border: 2px solid transparent; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); height: 140px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .p-card:hover { border-color: var(--brand); transform: translateY(-3px); }
        .qty-badge { position: absolute; top: 10px; left: 10px; background: var(--dark); color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.8rem; }

        .bill-header { padding: 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; text-align: center; }
        .bill-items { flex: 1; overflow-y: auto; padding: 15px; }
        
        .bill-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; margin-bottom: 8px; background: #f8fafc; border-radius: 12px;
            border-right: 3px solid transparent; transition: 0.2s;
            flex-wrap: wrap;
        }
        .bill-row:hover { border-right-color: var(--danger); background: #fff1f2; }
        
        .bill-footer { padding: 20px; background: white; border-top: 1px solid #e2e8f0; }
        .delete-btn { width: 25px; height: 25px; border-radius: 50%; background: #fee2e2; color: var(--danger); display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .report-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        .report-table th, .report-table td { padding: 15px; border-bottom: 1px solid #e2e8f0; text-align: right; }
        .report-table th { background: #1f2937; color: white; font-weight: normal; }
        .report-table tr:hover { background: #f3f4f6; }

        /* COMPANIES */
        .company-card {
            background: white; padding: 20px; border-radius: 15px; border-right: 5px solid var(--info);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .company-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        
        .general-market-card {
            background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
            color: white !important;
            grid-column: span 2; 
            border-right: none;
            position: relative;
            overflow: hidden;
        }
        .general-market-card h3 { color: white !important; font-size: 1.5rem !important; }
        .general-market-card p { color: rgba(255,255,255,0.8) !important; }
        .general-market-card::after {
            content: "\f290"; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; left: -20px; bottom: -20px; font-size: 8rem; opacity: 0.1;
        }

        /* BUSY TABLES */
        .table-busy {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
            color: white !important;
            border: none !important;
            box-shadow: 0 10px 20px rgba(185, 28, 28, 0.4) !important;
            animation: pulse-red 2s infinite;
        }
        .table-busy i { color: white !important; transform: scale(1.1); }
        .table-busy h3 { color: white !important; font-size: 1.3rem; font-weight: bold; }
        .table-busy small { 
            background: rgba(255, 255, 255, 0.2) !important; 
            color: white !important; 
            padding: 2px 8px; border-radius: 10px; font-weight: bold; font-size: 0.9rem; 
        }
        @keyframes pulse-red { 
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 
            70% { transform: scale(1.02); box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); } 
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } 
        }

        .save-indicator {
            position: fixed; bottom: 20px; left: 20px; background: #000; color: #fff;
            padding: 10px 20px; border-radius: 30px; font-size: 0.9rem; z-index: 9999;
            display: none; animation: popIn 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        @keyframes popIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .click-animate { animation: bump 0.2s; }
        @keyframes bump { 0% { transform: scale(1); } 50% { transform: scale(0.9); } 100% { transform: scale(1); } }

        /* NEW SUPPLY MODAL */
        #new-supply-form {
            display: none; background: #fff; padding: 25px; margin-bottom: 20px; 
            border-radius: 15px; border: 1px solid #e5e7eb; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        }
        
        .status-badge-ok { background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; }
        .status-badge-low { background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; }
        .status-badge-out { background: #fee2e2; color: #b91c1c; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; }
        .status-badge-exp { background: #7f1d1d; color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; }
        
        /* QUICK DISCOUNT BUTTONS */
        .discount-presets {
            display: flex; gap: 5px; margin-bottom: 5px;
        }
        .disc-btn {
            flex: 1; background: #e5e7eb; border: none; padding: 5px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-weight: bold; color: #374151; transition: 0.2s;
        }
        .disc-btn:hover { background: #d1d5db; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Role Switch Button */
        .role-switch-btn {
            background: #fbbf24;
            color: black;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
            font-weight: bold;
            margin-right: 10px;
        }
        .role-switch-btn:hover {
            background: #f59e0b;
        }

        /* Backup Section */
        .backup-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border: 2px dashed #38bdf8;
        }

    </style>
</head>
<body>

    <!-- PRINTABLE AREA (UPDATED KURDISH ARABIC SCRIPT & LOGO) -->
    <div id="printable-area"></div>

    <!-- COMPANY PROFILE MODAL (FIXED WITH PHONE ID) -->
    <div id="company-profile-modal" class="profile-modal">
        <div class="profile-content">
            <div class="profile-header">
                <div>
                    <h2 id="cp-name" style="margin:0;">Ø´Û•Ø±ÛŒÚ©Û•</h2>
                    <small id="cp-phone" style="font-size:0.9rem; opacity:0.9;"></small>
                </div>
                <button style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;" onclick="closeCompanyProfile()">âœ–</button>
            </div>
            <div class="profile-tabs">
                <button id="tab-btn-inventory" class="tab-btn active" onclick="switchTab('inventory')">ğŸ“¦ Ù…Û•Ø®Ø²Û•Ù†</button>
                <button id="tab-btn-history" class="tab-btn" onclick="switchTab('history')">ğŸ“ Ù…ÛÚ˜ÙˆÙˆÛŒ Ú©Ú•ÛŒÙ†</button>
                <button id="tab-btn-ledger" class="tab-btn" onclick="switchTab('ledger')">ğŸ“’ Ø¬Û•Ø±Ø¯ (Ù‚Û•Ø±Ø² & Ù¾Ø§Ø±Û•Ø¯Ø§Ù†)</button>
                <button id="tab-btn-supply" class="tab-btn" onclick="switchTab('supply')">â• Ø²ÛŒØ§Ø¯Ú©Ø±Ù†Ø§ Ù…Û•Ø®Ø²Û•Ù†Û</button>
            </div>
            <div id="tab-inventory" class="tab-content active">
                <h3>Ø¯Ø§ØªØ§ÛŒ Ù…Û•Ø®Ø²Û•Ù†</h3>
                <div class="card">
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px; margin-bottom:20px;">
                        <div class="p-box"><h4>Ú©Û†Ù… Ø¨Ù‡Ø§ÛŒÛ Ù…Û•Ø®Ø²Û•Ù†Û</h4><h2 id="cp-total-stock-value">0</h2></div>
                        <div class="p-box"><h4>Ø¨Û•Ø±Ú¤Ø§ÛŒ Ú©Û†Ù…Ø§ Ù‚Û•Ø±Ø²ÛŒ</h4><h2 id="cp-balance" style="color:red">0</h2></div>
                        <div><button class="btn btn-success" onclick="payDebt()" style="height:100%; width:100%; font-size:1.2rem;"><i class="fas fa-money-bill-wave"></i> Ø¯Ø§ÛŒÛ• Ù‚Û•Ø±Ø²</button></div>
                    </div>
                    <h4>Ù„ÛŒØ³ØªÛ•ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø¦Ø§ÛŒØªÙ…ÛÙ†</h4>
                    <div style="max-height:400px; overflow-y:auto;">
                        <table class="report-table">
                            <thead><tr><th>Ø¦Ø§ÛŒØªÙ…</th><th>Ù…Û•Ø®Ø²Û•Ù†</th><th>Cost (ØªØ§Ú©)</th><th>Price (ØªØ§Ú©)</th><th>Ù‚Ø§Ø²Ø§Ù†Ø¬</th><th>Ú©Ø±Ø¯Ø§Ø±</th></tr></thead>
                            <tbody id="cp-items-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="tab-history" class="tab-content">
                <h3>Ù…ÛÚ˜ÙˆÙˆÛŒ Ú©Ú•ÛŒÙ† Ùˆ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ</h3>
                <div style="max-height:500px; overflow-y:auto;">
                    <table class="report-table">
                        <thead><tr><th>Ø¨Û•Ø±ÙˆØ§Ø±</th><th>Ø¦Ø§ÛŒØªÙ…</th><th>Ú˜Ù…Ø§Ø±Û•ÛŒ Ø²ÛŒØ§Ø¯Ú©Ø±Ù†</th><th>Ø¬Û†Ø±</th><th>Ú©Û†Ù…Ø§ Ù¾Ø§Ø±Û•</th></tr></thead>
                        <tbody id="cp-history-list"></tbody>
                    </table>
                </div>
            </div>
            <div id="tab-ledger" class="tab-content">
                <h3>Ø¬Û•Ø±Ø¯ÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù† Ùˆ Ù‚Û•Ø±Ø²</h3>
                <button class="btn btn-warning" onclick="printLedger()"><i class="fas fa-print"></i> Ù¾Ø±ÛŒÙ†Øª</button>
                <div style="max-height:500px; overflow-y:auto; margin-top:15px;">
                    <table class="report-table">
                        <thead><tr><th>Ø¨Û•Ø±ÙˆØ§Ø±</th><th>Ø¬Û†Ø±Û Ú©Ø§Ø±ØªÛ</th><th>Ø¨Ú•</th><th>ØªÛØ¨ÛŒÙ†ÛŒ</th></tr></thead>
                        <tbody id="cp-ledger-list"></tbody>
                    </table>
                </div>
            </div>
            <div id="tab-supply" class="tab-content">
                <h3>Ø²ÛŒØ§Ø¯Ú©Ø±Ù†Ø§ Ù…Û•Ø®Ø²Û•Ù†Û</h3>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4 style="margin:0;">Ø´Û•Ø±ÛŒÚ©Û•: <span id="supply-comp-name"></span></h4>
                        <button class="btn btn-brand" onclick="toggleSupplyForm()"><i class="fas fa-plus"></i> Ú©Ú•ÛŒÙ†Û Ù†ÙˆÛŒ</button>
                    </div>
                    
                    <!-- NEW SUPPLY FORM -->
                    <div id="new-supply-form">
                        <input type="hidden" id="supply-selected-prod-id">
                        <div class="form-grid-layout">
                            <div class="form-section">
                                <div class="form-section-title">Ù‡Û•ÚµØ¨Ú˜Ø§Ø±Ø¯Ù†Ø§ Ø¦Ø§ÛŒØªÙ…Û</div>
                                <div id="supply-item-grid" class="item-select-grid"></div>
                                <div id="supply-cost-hint" style="background:#f0f9ff; padding:8px; border-radius:8px; margin-top:10px; display:none;"></div>
                            </div>
                            <div class="form-section">
                                <div class="form-section-title">Ú˜Ù…Ø§Ø±Û• & Ù¾Ø§Ø±Û•</div>
                                <div style="display:flex; gap:10px;">
                                    <div style="flex:1"><label>Ú©Ø§Ø±ØªÙˆÙ†</label><input type="number" id="supply-qty-carton" class="input-std" placeholder="0" oninput="autoCalcSupply()"></div>
                                    <div style="flex:1"><label>Ø¯Ø§Ù†Û•</label><input type="number" id="supply-qty-unit" class="input-std" placeholder="0" oninput="autoCalcSupply()"></div>
                                </div>
                                <label>Ú©Û†Ù…Ø§ Ù¾Ø§Ø±Û• (Total Cost)</label>
                                <input type="number" id="supply-cost" class="input-std" placeholder="Auto..." readonly style="background:#f3f4f6">
                                
                                <div style="margin-top:15px;">
                                    <label>Ø¬Û†Ø±ÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù†:</label>
                                    <div class="radio-group">
                                        <label class="radio-label"><input type="radio" name="supply-type" value="cash" checked> Ù¾Ø§Ø±Û• (Ù†Û•Ù‚Ø¯)</label>
                                        <label class="radio-label"><input type="radio" name="supply-type" value="credit"> Ù‚Û•Ø±Ø²</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button class="btn btn-success" style="flex:1;" onclick="saveSupplyTransaction()"><i class="fas fa-save"></i> ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†</button>
                            <button class="btn btn-dark" onclick="toggleSupplyForm()"><i class="fas fa-times"></i> Ù¾Ø´Ú©Û•ÙØªÙ†</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SAVE INDICATOR -->
    <div id="save-indicator" class="save-indicator">
        <i class="fas fa-save"></i> Ù‡Ø§ØªÛ• Ø®Û•Ø²Ù†Ú©Ø±Ù†...
    </div>

    <!-- STARTUP SCREEN -->
    <div id="startup-screen" class="modal-overlay">
        <div class="glass-card">
            <i id="secret-icon" class="fas fa-paw" style="font-size: 4rem; color: white; margin-bottom: 20px; cursor:pointer; transition:0.2s;" onclick="triggerSecretCreate()"></i>
            <h1 style="margin-bottom: 5px; font-family: 'Segoe UI', sans-serif;">Black Bear Coffee</h1>
            <p style="opacity: 0.7; margin-bottom: 30px;">Pro Badini Version 2026</p>
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align:right;">
                <p style="font-size: 0.9rem; color: #fbbf24; margin-bottom: 10px;"><i class="fas fa-lock"></i> Ù¾Ø§Ø±Ø§Ø³ØªÙ†Ø§ Ø¯Ø§ØªØ§ÛŒØ§Ù†</p>
                <ol style="font-size: 0.85rem; padding-right: 20px; margin: 0; color: #e5e7eb;">
                    <li>ØªÚ©Ø§ÛŒÛ• ÙØ§ÛŒÙ„ÛŒ <b>USB</b> Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•.</li>
                    <li>Ø³ÛŒØ³ØªÛ•Ù… **Direct Save** Ø¨Û•Ú©Ø§Ø±Ø¯ÛÙ†ÛØª Ø¨Û† Ù¾Ø§Ø±Û•Ø¯Ø§Ù†.</li>
                    <li>ØªÛ•Ù†Ù‡Ø§ ÛŒÛ•Ú© ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ: <b>BLACKBEAR2026</b></li>
                </ol>
            </div>
            <button class="btn btn-warning" style="width:100%; padding:20px; font-size:1.2rem; margin-bottom:15px; background:#fbbf24; color:black; font-family: sans-serif;" onclick="connectToFileSystem()">
                <i class="fas fa-folder-open"></i> Ú¤Û•Ú©Ø±Ù†Ø§ ÙØ§ÛŒÙ„ÛŒ (Database)
            </button>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="modal-overlay" style="display:none;">
        <div class="glass-card" style="background: rgba(0, 0, 0, 0.9);">
            <h2><i class="fas fa-user-lock"></i> Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ±</h2>
            <p style="color:#aaa; font-size:0.8rem">Ù¾Ø§Ø±ÛØ²Ø±Ø§Ùˆ Ø¨Û• SHA-256 | ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ: BLACKBEAR2026</p>
            <input type="password" id="pin-code" class="pin-input" placeholder="PIN" maxlength="4" value="1234">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-brand" style="background:white; color:black" onclick="attemptLogin()">Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ±</button>
                <button class="btn btn-danger" onclick="location.reload()">Ø²Ú¤Ú•ÛŒÙ†</button>
            </div>
            <p id="login-error" style="color:var(--danger); margin-top:10px;"></p>
            <div style="margin-top:20px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1);">
                <p style="font-size:0.8rem; color:#aaa;">Ù†ÙˆÛÚ˜Û•Ø±Û:</p>
                <p style="font-size:0.8rem; color:#fbbf24;">
                    Ú©Ø§Ø´ÛØ±: <b>1234</b> | Ø¦Û•Ø¯Ù…ÛŒÙ†: <b>0000</b>
                </p>
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-header"><i class="fas fa-mug-hot"></i> Black Bear</div>
        <nav style="flex:1">
            <div class="nav-item active" onclick="nav('dash')"><i class="fas fa-chart-line"></i> Ø¯Ø§Ø´Ø¨Û†Ø±Ø¯</div>
            <div class="nav-item" onclick="nav('tables')"><i class="fas fa-couch"></i> Ù…ÛØ²</div>
            <div class="nav-item" id="nav-pos" onclick="nav('pos')" style="display:none"><i class="fas fa-coffee"></i> ÙØ±Û†Ø´ØªÙ† (POS)</div>
            <div class="nav-item protected" onclick="nav('companies')"><i class="fas fa-building"></i> Ø´Û•Ø±ÛŒÚ©Û•Ú©Ø§Ù†</div>
            <div class="nav-item protected" onclick="nav('warehouse')"><i class="fas fa-warehouse"></i> Ù…Û•Ø®Ø²Û•Ù† & Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±Ú©Ø±Ø¯Ù†Û•ÙˆÛ•</div>
            <div class="nav-item protected" onclick="nav('products')"><i class="fas fa-box-open"></i> Ù¾ÛÙ†Ø§Ø³Û•Ú©Ø±Ù†Ø§ Ø¦Ø§ÛŒØªÙ…</div>
            <div class="nav-item protected" onclick="nav('expenses')"><i class="fas fa-wallet"></i> Ø®Û•Ø±Ø¬ÛŒ</div>
            <div class="nav-item protected" onclick="nav('reports')"><i class="fas fa-file-invoice-dollar"></i> Ú•Ø§Ù¾Û†Ø±Øª</div>
        </nav>
        <div class="nav-item protected" onclick="nav('settings')" style="border-top:1px solid #374151"><i class="fas fa-cog"></i> Ú•ÛÚ©Ø®Ø³ØªÙ†</div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div id="connection-warning">ğŸ”´ Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ ÙØ§ÛŒÙ„ Ù¾Ú†Ú•Ø§! ØªÚ©Ø§ÛŒÛ• Refresh Ø¨Ú©Û• Ùˆ ÙØ§ÛŒÙ„Û•Ú©Û• Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•ÙˆÛ•.</div>

        <div class="top-bar">
            <div style="color: #64748b; font-size:0.9rem;">
                <i id="save-status-dot" class="fas fa-circle" style="color:gray; font-size:10px;"></i> 
                <span id="save-status-text">Not Connected</span>
                <span style="margin-right:15px; background:#d1fae5; color:#065f46; padding:2px 8px; border-radius:10px; font-size:0.8rem;">Auto-Refresh ON</span>
                <button id="role-switch-btn" class="role-switch-btn" onclick="switchRole()" style="display:none;">ğŸ”„ Ú¯Û†Ø±ÛŒÙ†ÛŒ Ú•Û†Úµ</button>
            </div>
            <div style="display:flex; align-items:center; gap:15px;">
                <span id="user-display">Ú©Ø§Ø±Ù…Û•Ù†Ø¯</span>
                <i class="fas fa-user-circle" style="font-size:1.5rem; cursor:pointer;" onclick="location.reload()"></i>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div id="view-dash" class="workspace active">
            <div class="stat-grid">
                <div class="stat-card">
                    <h3>ÙØ±Û†Ø´ØªÙ†Ø§ Ø¦Û•Ú¤Ú•Û†</h3>
                    <h1 id="st-sales">0</h1>
                    <small id="st-date-hint" style="font-size:0.7rem; color:#aaa;">(Business Day)</small>
                </div>
                <div class="stat-card" style="border-right-color:var(--danger)"><h3>Ø®Û•Ø±Ø¬ÛŒ</h3><h1 id="st-exp">0</h1></div>
                <div class="stat-card" style="border-right-color:var(--success)"><h3>Ù‚Ø§Ø³Û• (Net)</h3><h1 id="st-profit">0</h1></div>
                <div class="stat-card" style="border-right-color:var(--warning)"><h3>Ú˜Ù…Ø§Ø±Ø§ Ù¾Ø³ÙˆÙˆÙ„Ø§Ù†</h3><h1 id="st-count">0</h1></div>
            </div>
            <div class="card">
                <h3><i class="fas fa-history"></i> Ù…ÛØ²ÛÙ† Ú†Ø§Ù„Ø§Ú©</h3>
                <div id="dash-tables" class="product-grid" style="margin-top:20px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));"></div>
            </div>
        </div>

        <!-- TABLES -->
        <div id="view-tables" class="workspace">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Ù†Û•Ø®Ø´Û•ÛŒ Ù…ÛØ²Û•Ú©Ø§Ù†</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-warning protected" onclick="transferTableUI()">ğŸ”„ Ú¯Û†Ø§Ø³ØªÙ†Û•ÙˆÛ•</button>
                    <button class="btn btn-dark protected" onclick="printZReport()">ğŸ“‘ Ø¯Ø§Ø®Ø³ØªÙ†Ø§ Ú•Û†Ú˜Û (Z)</button>
                    <button class="btn btn-brand protected" onclick="addTable()">+ Ù…ÛØ²</button>
                </div>
            </div>
            <div id="tables-grid" class="product-grid" style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));"></div>
        </div>

        <!-- COMPANIES VIEW -->
        <div id="view-companies" class="workspace">
            <h2><i class="fas fa-building"></i> Ø¨Û•Ú•ÛÙˆØ¨Û•Ø±Ø§ÛŒÛ•ØªÛŒ Ø´Û•Ø±ÛŒÚ©Û•Ú©Ø§Ù†</h2>
            <div class="card">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:15px;">
                    <input type="text" id="c-name" class="input-std" placeholder="Ù†Ø§Ú¤Û Ø´Û•Ø±ÛŒÚ©Û">
                    <input type="text" id="c-phone" class="input-std" placeholder="Ú˜Ù…Ø§Ø±Ø§ ØªÛ•Ù„Û•ÙÛ†Ù†Û">
                    <input type="text" id="c-addr" class="input-std" placeholder="Ù†Ø§Ú¤Ù†ÛŒØ´Ø§Ù†">
                    <button class="btn btn-info" onclick="saveCompany()">+ Ø²ÛŒØ§Ø¯Ú©Ø±Ù†</button>
                </div>
            </div>
            <div id="companies-grid" class="stat-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));"></div>
        </div>

        <!-- NEW WAREHOUSE VIEW -->
        <div id="view-warehouse" class="workspace">
            <h2><i class="fas fa-warehouse"></i> Ù…Û•Ø®Ø²Û•Ù† & Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±Ú©Ø±Ø¯Ù†Û•ÙˆÛ•</h2>
            
            <div class="stat-grid">
                <div class="stat-card" style="border-right-color:var(--info)" onclick="renderWarehouse('all')">
                    <h3>Ù‡Û•Ù…ÙˆÙˆ Ø¦Ø§ÛŒØªÙ…Û•Ú©Ø§Ù†</h3>
                    <h1 id="wh-count-all">0</h1>
                </div>
                <div class="stat-card" style="border-right-color:var(--warning); cursor:pointer;" onclick="renderWarehouse('low')">
                    <h3>Ø¨Û•Ø±Û•Ùˆ ØªÛ•ÙˆØ§ÙˆØ¨ÙˆÙˆÙ† (Low Stock)</h3>
                    <h1 id="wh-count-low" style="color:var(--warning)">0</h1>
                </div>
                <div class="stat-card" style="border-right-color:var(--danger); cursor:pointer;" onclick="renderWarehouse('out')">
                    <h3>Ù†Û•Ù…Ø§ÙˆÛ• (Out of Stock)</h3>
                    <h1 id="wh-count-out" style="color:var(--danger)">0</h1>
                </div>
                <div class="stat-card" style="border-right-color:#7f1d1d; cursor:pointer;" onclick="renderWarehouse('expired')">
                    <h3>Ø¨Û•Ø³Û•Ø±Ú†ÙˆÙˆÙ† (Expired)</h3>
                    <h1 id="wh-count-exp" style="color:#7f1d1d">0</h1>
                </div>
            </div>

            <div class="card">
                <h3 id="wh-list-title">ğŸ“‹ Ù„ÛŒØ³ØªÛ•ÛŒ Ø¦Ø§ÛŒØªÙ…Û•Ú©Ø§Ù†</h3>
                <div style="max-height:500px; overflow-y:auto;">
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Ø¦Ø§ÛŒØªÙ…</th>
                                <th>Ø¯Ø§Ø¨ÛŒÙ†Ú©Û•Ø± (Ø´Û•Ø±ÛŒÚ©Û•)</th>
                                <th>Ú˜Ù…Ø§Ø±Û• (Ù…Û•Ø®Ø²Û•Ù†)</th>
                                <th>Ø¨Û•Ø±ÙˆØ§Ø±Ø§ Ø¨Û•Ø³Û•Ø±Ú†ÙˆÙˆÙ†</th>
                                <th>Ø¯Û†Ø® (Status)</th>
                            </tr>
                        </thead>
                        <tbody id="wh-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PRODUCTS DEFINITION VIEW -->
        <div id="view-products" class="workspace">
            <h2><i class="fas fa-box-open"></i> Ù¾ÛÙ†Ø§Ø³Û•Ú©Ø±Ù†Ø§ Ø¦Ø§ÛŒØªÙ…Û Ù†ÙˆÛŒ</h2>
            
            <div class="card" id="product-form-card">
                <input type="hidden" id="p-id">
                
                <div class="form-grid-layout">
                    <!-- SECTION 1: BASIC INFO -->
                    <div class="form-section">
                        <div class="form-section-title">Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ø³Û•Ø±Û•ØªØ§ÛŒÛŒ</div>
                        
                        <div class="radio-group">
                            <label class="radio-label"><input type="radio" name="p-source" value="direct" checked onchange="toggleSupplierInput()"> Ù…Û•Ø®Ø²Û•Ù† (Direct)</label>
                            <label class="radio-label"><input type="radio" name="p-source" value="market" onchange="toggleSupplierInput()"> Ø¨Ø§Ø²Ø§Ú• (Market)</label>
                            <label class="radio-label"><input type="radio" name="p-source" value="company" onchange="toggleSupplierInput()"> Ø´Û•Ø±ÛŒÚ©Û• (Supplier)</label>
                        </div>

                        <label>Ù†Ø§Ú¤Û Ø¦Ø§ÛŒØªÙ…ÛŒ</label>
                        <input type="text" id="p-name" class="input-std" placeholder="Ù†Ø§Ú¤ (Ú©ÙˆØ±Ø¯ÛŒ - English)">
                        
                        <div id="supplier-select-wrapper" style="display:none;">
                            <label>Ø´Û•Ø±ÛŒÚ©Û• / Ø¯Ø§Ø¨ÛŒÙ†Ú©Û•Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•</label>
                            <select id="p-supplier" class="input-std">
                                <option value="">Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•...</option>
                            </select>
                        </div>
                        
                        <label>Ù¾Û†Ù„ÛÙ† (Category)</label>
                        <input type="text" id="p-cat" class="input-std" placeholder="Msal: Drink">
                    </div>

                    <!-- SECTION 2: STOCK & COST -->
                    <div class="form-section">
                        <div class="form-section-title">ØªÛÚ†ÙˆÙˆ & Ù…Û•Ø®Ø²Û•Ù†</div>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <label style="font-size:0.8rem">Ø¯Ø§Ù†Û• Ø¯ Ú©Ø§Ø±ØªÙˆÙ†ÛŒ Ø¯Ø§</label>
                                <input type="number" id="p-per-carton" class="input-std" placeholder="24" oninput="calcUnitCost()">
                            </div>
                            <div>
                                <label style="font-size:0.8rem">Ù†Ø±Ø®ÛŒ Ú©Ú•ÛŒÙ†ÛŒ Ú©Ø§Ø±ØªÛ†Ù† (Ú¯Ø´ØªÛŒ)</label>
                                <input type="number" id="p-total-buy-cost" class="input-std" placeholder="Ú©Û†ÛŒ Ù¾Ø§Ø±Û•ÛŒ Ú©Ø§Ø±ØªÛ†Ù†" oninput="calcUnitCost()">
                            </div>
                        </div>

                        <div style="background:#f0f9ff; padding:8px; border-radius:8px; border:1px dashed #bae6fd; margin-bottom:10px;">
                            <label style="color:var(--info); font-weight:bold; font-size:0.9rem;">Ù†Ø±Ø®ÛŒ Ú©Ú•ÛŒÙ†ÛŒ ØªØ§Ú© (Cost Per Unit)</label>
                            <input type="number" id="p-cost" class="input-std" placeholder="Auto Calc..." readonly style="background:#e0f2fe; cursor:not-allowed; margin:0;">
                        </div>
                        
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1">
                                <label>Ù…Û•Ø®Ø²Û•Ù† (Ú©Ø§Ø±ØªÙˆÙ†)</label><input type="number" id="p-cartons" class="input-std" placeholder="0">
                            </div>
                            <div style="flex:1">
                                <label>Ø¯Ø§Ù†Û• (ÙÛ•Ø±Ø¯)</label><input type="number" id="p-loose" class="input-std" placeholder="0" value="0">
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 3: PRICING & SAVE -->
                    <div class="form-section">
                        <div class="form-section-title">ÙØ±Û†Ø´ØªÙ†</div>
                        
                        <label>Ø¨Ù‡Ø§ÛŒÛ ÙØ±Û†Ø´ØªÙ†Û (Price)</label>
                        <input type="number" id="p-price" class="input-std" placeholder="250" style="font-size:1.2rem; font-weight:bold;">
                        
                        <label>Ø¨Û•Ø±ÙˆØ§Ø±Ø§ Ø¨ Ø³Û•Ø±Ú†ÙˆÙˆÙ†Û</label>
                        <input type="date" id="p-expiry" class="input-std">
                        
                        <div style="display:flex; align-items:center; gap:10px; height:50px; margin-bottom:10px;">
                            <input type="checkbox" id="p-track" style="width:20px; height:20px;" checked>
                            <label>Ø­ÛŒØ³Ø§Ø¨Ø§ Ù…Û•Ø®Ø²Û•Ù†ÛŒØŸ</label>
                        </div>

                        <div style="display:flex; gap:10px;">
                            <button id="btn-save-prod" class="btn btn-brand" style="flex:1;" onclick="saveProduct()">
                                <i class="fas fa-save"></i> Ù‡Û•ÚµÚ¯Ø±ØªÙ†
                            </button>
                            <button class="btn btn-dark" onclick="clearProductInputs()">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- LIST OF ALL PRODUCTS -->
            <div class="card" style="border-top: 5px solid var(--warning);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>ğŸ“‹ Ù„ÛŒØ³ØªÛ•ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø¦Ø§ÛŒØªÙ…Û•Ú©Ø§Ù†</h3>
                    <input type="text" class="input-std" style="width:250px; margin:0;" placeholder="ğŸ” Ú¯Û•Ú•ÛŒØ§Ù†..." onkeyup="renderProducts(this.value)">
                </div>
                <div id="product-list-container"></div>
            </div>
        </div>

        <!-- POS SYSTEM (UPDATED WITH DISCOUNT & LOGO) -->
        <div id="view-pos" class="workspace" style="padding:10px;">
            <div class="pos-layout">
                <div class="pos-menu no-print">
                    <div style="display:flex; gap:15px; margin-bottom:15px;">
                        <input type="text" class="input-std" placeholder="ğŸ” Ú¯Û•Ú•ÛŒØ§Ù†..." style="margin:0; font-size:1.1rem;" onkeyup="renderPOSMenu(this.value)">
                    </div>
                    <div id="category-tabs" class="category-bar"></div>
                    <div id="pos-products" class="product-grid"></div>
                </div>
                
                <div class="pos-bill">
                    <div class="bill-header">
                        <div id="print-custom-header">
                            <h2 id="bill-cafe-name" style="margin:0;">Black Bear Coffee</h2>
                            <p id="bill-cafe-info" style="margin:5px 0; font-size:0.9rem;">0750 000 00 00</p>
                        </div>
                        <h3 id="pos-active-table" style="margin-top:10px; background:#f3f4f6; display:inline-block; padding:5px 15px; border-radius:10px;">Table #</h3>
                        <br><small id="pos-date"></small>
                    </div>
                    <div class="bill-items" id="bill-rows"></div>
                    <div class="bill-footer">
                        
                        <!-- NEW DISCOUNT INPUT & BUTTONS -->
                        <label style="font-size:0.9rem; font-weight:bold;">Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù† (Discount):</label>
                        <div class="discount-presets">
                            <button class="disc-btn" onclick="applyDiscountPercent(5)">%5</button>
                            <button class="disc-btn" onclick="applyDiscountPercent(10)">%10</button>
                            <button class="disc-btn" onclick="applyDiscountPercent(15)">%15</button>
                            <button class="disc-btn" onclick="applyDiscountPercent(20)">%20</button>
                            <button class="disc-btn" style="background:#fee2e2; color:red" onclick="applyDiscountPercent(0)">X</button>
                        </div>
                        <input type="number" id="pos-discount" class="input-std" placeholder="Ø¨Ú•ÛŒ Ù¾Ø§Ø±Û•" style="margin-bottom:10px; text-align:center;" oninput="renderBillTotal()">

                        <div class="bill-total-section" style="display:flex; justify-content:space-between; margin-bottom:15px; background:#f1f5f9; padding:15px; border-radius:12px;">
                            <span style="font-size:1.2rem; font-weight:bold;">Ú©Û†Ù… (Total):</span>
                            <h2 id="bill-total" style="margin:0; color:var(--brand); font-size:1.8rem;">0</h2>
                        </div>
                        <p id="bill-footer-msg" style="text-align:center; font-size:0.8rem; margin-top:15px; display:none;">Ø³ÙˆÙ¾Ø§Ø³ Ø¨Û† Ø³Û•Ø±Ø¯Ø§Ù†Ø§ Ù‡Û•ÙˆÛ•</p>
                        <div id="pos-actions-default" class="no-print">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                                <button class="btn btn-warning" onclick="printKitchen()">ğŸ´ Ú†Ø§ÛŒØ®Ø§Ù†Û•</button>
                                <button class="btn btn-brand" onclick="processPayment()">ğŸ“‘ ÙˆÛ•Ø±Ú¯Ø±ØªÙ†</button>
                            </div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <button class="btn btn-success" onclick="nav('tables')">ğŸ’¾ Ù¾Ø§Ø´Ú©Û•ÙØªÙ†</button>
                                <button class="btn btn-danger" onclick="cancelOrder()">ğŸ—‘ï¸ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXPENSES (UPDATED WITH COMPANY SELECTOR) -->
        <div id="view-expenses" class="workspace">
            <h2><i class="fas fa-wallet"></i> Ø®Û•Ø±Ø¬ÛŒ</h2>
            <div class="card">
                <div style="display:grid; grid-template-columns: 1fr 2fr 1fr 1fr; gap:10px;">
                    <!-- Added Company Selector -->
                    <select id="e-comp-select" class="input-std">
                        <option value="">Ø®Û•Ø±Ø¬ÛŒ Ú¯Ø´ØªÛŒ</option>
                    </select>
                    
                    <input type="text" id="e-note" class="input-std" placeholder="ØªÛØ¨ÛŒÙ†ÛŒ">
                    <input type="number" id="e-amount" class="input-std" placeholder="Ø¨Ú•">
                    <button class="btn btn-danger" style="height:46px" onclick="saveExpense()">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†</button>
                </div>
            </div>
            <div style="margin-bottom:10px;">
                <button class="btn btn-dark" onclick="printExpenses()"><i class="fas fa-print"></i> Ù¾Ø±ÛŒÙ†ØªÚ©Ø±Ù†Ø§ Ù„ÛŒØ³ØªÛ</button>
            </div>
            <div id="expense-list"></div>
        </div>

        <!-- REPORTS (ENHANCED) -->
        <div id="view-reports" class="workspace">
            <h2><i class="fas fa-file-invoice"></i> Ù…ÛÚ˜ÙˆÙˆ & Ø±Ø§Ù¾Û†Ø±Øª</h2>
            
            <div class="card" style="border-right: 5px solid var(--info);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>ğŸ“Š Ø¬Û•Ø±Ø¯ Ùˆ Ú•Ø§Ù¾Û†Ø±ØªØ§ ÙˆØ±Ø¯</h3>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-brand" onclick="printDetailedReport('daily')">ğŸ“„ Ø¬Û•Ø±Ø¯Ø§ Ø¦Û•Ú¤Ú•Û† (Daily)</button>
                        <button class="btn btn-dark" onclick="printDetailedReport('monthly')">ğŸ“… Ø¬Û•Ø±Ø¯Ø§ Ù‡Û•ÛŒÚ¤Ø§Ù†Û• (Monthly)</button>
                        <button class="btn btn-warning" onclick="printDebtReport()">ğŸ“‹ Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ù‚Û•Ø±Ø²Û•Ú©Ø§Ù†</button>
                    </div>
                </div>
                <p style="color:#666; font-size:0.9rem; margin-top:5px;">Ø¦Û•Ú¤ Ú•Ø§Ù¾Û†Ø±ØªÛ• Ø¯Ø§ØªØ§ÛŒÛÙ† Ø¦Û•Ø±Ø´ÛŒÙÚ©Ø±ÛŒ Ú˜ÛŒ Ø¯Ú¯Ø±ÛØªÛ•Ø®Û† (Complete Data).</p>
            </div>

            <div class="card" style="border-right: 5px solid var(--success);">
                <h3>ğŸ“… Ø±Ø§Ù¾Û†Ø±ØªØ§ Ù‡Û•ÛŒÚ¤Ø§Ù†Û• (Ù¾ÙˆØ®ØªÛ•)</h3>
                <div style="max-height: 250px; overflow-y:auto; margin-top:10px;">
                    <table class="report-table">
                        <thead><tr><th>Ù‡Û•ÛŒÚ¤</th><th>Ú©Û†Ù…Ø§ ÙØ±Û†Ø´ØªÙ†Û</th><th>Ú©Û†Ù…Ø§ Ø®Û•Ø±Ø¬ÛŒÛ</th><th>Ù‚Ø§Ø²Ø§Ù†Ø¬ (Net)</th><th>Ú©Ø±Ø¯Ø§Ø±</th></tr></thead>
                        <tbody id="monthly-report-list"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="stat-grid">
                 <div class="card" style="grid-column: span 3;">
                    <h3>ğŸ“Š ÙØ±Û†Ø´ØªÙ†Ø§ Ú•Û†Ú˜Ø§Ù†Û• (Business Day)</h3>
                    <div style="max-height: 200px; overflow-y:auto; margin-top:10px;">
                        <table class="report-table"><thead><tr><th>Ù…ÛÚ˜ÙˆÙˆ</th><th>Ú˜Ù…Ø§Ø±Ø§ Ù¾Ø³ÙˆÙˆÙ„Ø§Ù†</th><th>Ú©Û†Ù…Ø§ Ù¾Ø§Ø±Û•ÛŒ</th></tr></thead><tbody id="daily-sales-list"></tbody></table>
                    </div>
                 </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="card">
                    <h3>ğŸ“œ Ù…ÛÚ˜ÙˆÙˆÛŒÛŒØ§ Ù¾Ø³ÙˆÙˆÙ„Ø§Ù† (ØªØ§Ú©)</h3>
                    <input type="text" class="input-std" placeholder="Ú¯Û•Ú•ÛŒØ§Ù† (Ú˜Ù…Ø§Ø±Ø§ ÙˆÛ•Ø³ÚµÛ ÛŒØ§Ù† Ù…ÛØ²)..." onkeyup="filterHistory(this.value)">
                    <div id="sales-history-list" style="max-height: 400px; overflow-y:auto;"></div>
                </div>
                <div class="card">
                    <h3>ğŸ› ï¸ ØªÛ†Ù…Ø§Ø± (Logs)</h3>
                    <div id="log-list" style="max-height: 400px; overflow-y:auto; background:#f3f4f6; padding:15px; border-radius:10px;"></div>
                </div>
            </div>
        </div>

        <!-- SETTINGS (ADDED LOGO UPLOAD & BACKUP FOR CASHIER) -->
        <div id="view-settings" class="workspace">
            <h2><i class="fas fa-cog"></i> Ú•ÛÚ©Ø®Ø³ØªÙ†</h2>
            <div class="card" style="border-top: 5px solid var(--brand);">
                <h3><i class="fas fa-print"></i> Ø¯ÛŒØ²Ø§ÛŒÙ†Ø§ Ù¾Ø³ÙˆÙˆÙ„Û</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div><label>Ù†Ø§Ú¤Û Ú©Ø§ÙØªØ±ÛŒØ§</label><input type="text" id="set-cafe-name" class="input-std"></div>
                    <div><label>Ú˜Ù…Ø§Ø±Û• / Ù†Ø§Ú¤Ù†ÛŒØ´Ø§Ù†</label><input type="text" id="set-cafe-info" class="input-std"></div>
                    
                    <!-- LOGO UPLOAD -->
                    <div style="grid-column: span 2; background:#f9fafb; padding:10px; border-radius:10px; border:1px dashed #ccc;">
                        <label>Ù„Û†Ú¯Û†ÛŒ Ù¾Ø³ÙˆÙˆÙ„Û (Logo)</label>
                        <input type="file" id="set-cafe-logo" class="input-std" accept="image/*">
                        <small style="color:#666">ØªÚ©Ø§ÛŒÛ• ÙˆÛÙ†Û•ÛŒÛ•Ú©Û Ø¨Ú†ÙˆÛŒÚ© Ù‡Û•ÚµØ¨Ú˜ÛØ±Û• (JPG/PNG). Ù¾Ø´ØªÛŒ Ù‡Û•ÚµØ¨Ú˜Ø§Ø±ØªÙ†Û Save Ø¨Ú©Û•.</small>
                    </div>

                    <div style="grid-column: span 2;"><label>Ù†Ú¤ÛŒØ³ÛŒÙ†Ø§ Ø®ÙˆØ§Ø±Û</label><input type="text" id="set-cafe-footer" class="input-std"></div>
                    <div style="grid-column: span 2;"><button class="btn btn-brand" onclick="savePrintSettings()">ğŸ’¾ Ù¾Ø§Ø´Ú©Û•ÙØªÙ†Ø§ Ø¯ÛŒØ²Ø§ÛŒÙ†Û</button></div>
                </div>
            </div>
            
            <!-- BACKUP SECTION - AVAILABLE FOR BOTH ADMIN AND CASHIER -->
            <div class="card backup-section protected">
                <h3>ğŸ’¾ Database Management</h3>
                <p>ØªÛ•Ù†Ù‡Ø§ Ø¦Û•Ø¯Ù…ÛŒÙ† Ø¯Û•ØªÙˆØ§Ù†ÛØª Ú©Û†Ù¾ÛŒÛ•Ú©ÛŒ ÛŒÛ•Ø¯Û•Ú¯ (Backup) Ø¯Ø§Ø¨Û•Ø²ÛÙ†ÛØª.</p>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-success" onclick="exportDB()"><i class="fas fa-download"></i> Backup Full DB (JSON)</button>
                    <button class="btn btn-info" onclick="backupToLocal()"><i class="fas fa-save"></i> Ø¨Ø§Ú© Ø¦Û•Ù¾ Ø¨Û† Ú©Ø§Ù…Ù¾ÛŒÙˆØªÛ•Ø±</button>
                    <button class="btn btn-warning" onclick="archiveOldData()"><i class="fas fa-archive"></i> Ø¦Û•Ø±Ø´ÛŒÙÚ©Ø±Ø¯Ù†ÛŒ Ø¯Ø§ØªØ§ÛŒ Ú©Û†Ù†</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- GLOBAL STATE ---
        let db = null;
        let activeTableId = null;
        let currentUser = null; 
        let activeCategory = 'all';
        let fileHandle = null; 
        let isFileConnected = false;
        let currentViewingCompanyId = null;
        let selectedSupplyProdId = null; 
        let lastTableState = ""; 
        let saveTimeout = null;
        let isSwitchedRole = false; // New: Track role switching

        const MASTER_PIN = '2026';
        // --- AUTH SYSTEM - UPDATED WITH SINGLE PASSWORD ---
        const MASTER_PASSWORD = 'BLACKBEAR2026'; // Single password for both admin/cashier
        
        const USERS = [
            { pin: '1234', name: 'Ú©Ø§Ø´ÛØ±', role: 'cashier', hash: '' },
            { pin: '0000', name: 'Ø¦Û•Ø¯Ù…ÛŒÙ†', role: 'admin', hash: '' }
        ];
        
        // Initialize hashes
        async function initializeUserHashes() {
            for (let user of USERS) {
                const fullPassword = MASTER_PASSWORD + user.pin;
                user.hash = await hashPIN(fullPassword);
            }
        }

        async function hashPIN(pin) {
            const encoder = new TextEncoder();
            const data = encoder.encode(pin);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- FORMATTING HELPER ---
        function formatCurrency(val) {
            return Math.round(val).toLocaleString();
        }

        // --- SECURITY ---
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function getAllSales() {
            return [...(db.sales || []), ...(db.archive || [])];
        }

        function getBusinessDate(dateObj = new Date()) {
            const d = new Date(dateObj);
            if(d.getHours() < 4) { d.setDate(d.getDate() - 1); }
            return d.toDateString(); 
        }
        function getBusinessMonth(dateObj = new Date()) {
            const d = new Date(dateObj);
            if(d.getHours() < 4) d.setDate(d.getDate() - 1);
            return `${d.getFullYear()}-${d.getMonth() + 1}`;
        }

        // --- STARTUP LOGIC ---
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeUserHashes();
        });

        let secretClicks = 0; let clickTimer;
        async function triggerSecretCreate() {
            if (!window.showSaveFilePicker) return alert("System requires Chrome/Edge on PC.");
            const icon = document.getElementById('secret-icon');
            icon.classList.remove('click-animate'); void icon.offsetWidth; icon.classList.add('click-animate');
            secretClicks++; clearTimeout(clickTimer);
            clickTimer = setTimeout(() => { secretClicks = 0; }, 2000);
            if(secretClicks === 5) {
                secretClicks = 0; const pass = prompt("ğŸ” ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ø¨Û† Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ù†Ø§ ÙØ§ÛŒÙ„Û Ù†ÙˆÛŒ:", MASTER_PASSWORD);
                if(pass === MASTER_PASSWORD) { await createNewDatabaseFile(); }
                else { alert("ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ù‡Û•ÚµÛ•ÛŒÛ•!"); }
            }
        }
        async function createNewDatabaseFile() {
            try {
                const options = { suggestedName: 'BlackBear_DB_2026.json', types: [{ description: 'JSON Database', accept: { 'application/json': ['.json'] } }] };
                const handle = await window.showSaveFilePicker(options);
                createDefaultDB();
                const writable = await handle.createWritable();
                await writable.write(JSON.stringify(db));
                await writable.close();
                fileHandle = handle; isFileConnected = true;
                alert("âœ… ÙØ§ÛŒÙ„Û Ù†ÙˆÛŒ Ø¯Ø±ÙˆØ³Øª Ø¨ÙˆÙˆ! Ø¦ÛØ³ØªØ§ Ø³ÛŒØ³ØªÛ•Ù… Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ•.");
                document.getElementById('startup-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                updateSaveStatus(true);
            } catch (err) { if(err.name !== 'AbortError') alert("Error: " + err.message); }
        }
        async function connectToFileSystem() {
            if (!window.showOpenFilePicker) return alert("System requires Chrome/Edge on PC.");
            
            // No password check here - just open file
            try {
                const [handle] = await window.showOpenFilePicker({ types: [{ description: 'JSON Database', accept: { 'application/json': ['.json'] } }], multiple: false });
                fileHandle = handle;
                const file = await fileHandle.getFile();
                const text = await file.text();
                if(text.trim() === "") { alert("ÙØ§ÛŒÙ„ Ø¨Û•ØªØ§ÚµÛ•!"); return; } 
                else { try { db = JSON.parse(text); } catch(e) { alert("ÙØ§ÛŒÙ„ÛŒ Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø§Ùˆ ØªÛÚ©Ú†ÙˆÙˆÛ•."); return; } }
                
                if(!db.companies) db.companies = [];
                if(!db.supplies) db.supplies = [];
                if(!db.archive) db.archive = []; 
                if(!db.ledger) db.ledger = []; 
                if(!db.expenses) db.expenses = [];
                if(!db.sales) db.sales = [];
                if(!db.logs) db.logs = [];

                isFileConnected = true; updateSaveStatus(true);
                document.getElementById('startup-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('connection-warning').style.display = 'none';
                startAutoRefresh();

            } catch (err) { if(err.name !== 'AbortError') alert("Ù‡Û•ÚµÛ• Ù„Û• Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ ÙØ§ÛŒÙ„: " + err.message); }
        }

        function startAutoRefresh() {
            setInterval(() => {
                if(db && isFileConnected) {
                    updateStats(); renderDashboard();
                    if(document.getElementById('view-tables').classList.contains('active')) { renderTables(); }
                }
            }, 3000); 
        }

        // --- DATA SAFETY ---
        window.onbeforeunload = function() {
            if (saveTimeout !== null) {
                return "Ù‡ÛØ´ØªØ§ Ø¯Ø§ØªØ§ Ø®Û•Ø²Ù† Ù†Û•Ø¨ÙˆÙˆÛŒÙ†Û•! Ø¯ÚµÙ†ÛŒØ§ÛŒ Ø¯ØªÛ•ÙˆÛ Ø¯Û•Ø±Ø¨Ú†ÛŒØªØŸ";
            }
        };

        function scheduleSave() {
            const indicator = document.getElementById('save-indicator');
            indicator.style.display = 'block';
            indicator.innerHTML = '<i class="fas fa-clock"></i> Ú†Ø§ÙˆÛ•Ú•ÛØ¨Û•...';
            indicator.style.background = '#f59e0b'; 
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => { saveToDisk(); }, 2000); 
        }

        async function saveToDisk() {
            if (fileHandle && isFileConnected) {
                try {
                    const writable = await fileHandle.createWritable();
                    await writable.write(JSON.stringify(db));
                    await writable.close();
                    const indicator = document.getElementById('save-indicator');
                    indicator.innerHTML = '<i class="fas fa-save"></i> Ù‡Ø§ØªÛ• Ø®Û•Ø²Ù†Ú©Ø±Ù†';
                    indicator.style.background = 'black';
                    setTimeout(() => { indicator.style.display = 'none'; }, 2000);
                    saveTimeout = null; 
                } catch (err) {
                    updateSaveStatus(false); isFileConnected = false;
                    document.getElementById('connection-warning').style.display = 'block';
                    alert("ğŸ”´ Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±Ø¨Û•: Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ø¨Û• ÙØ§ÛŒÙ„Û•Ú©Û•ÙˆÛ• Ù¾Ú†Ú•Ø§!");
                }
            }
        }
        
        function updateSaveStatus(connected) {
            const dot = document.getElementById('save-status-dot'); const txt = document.getElementById('save-status-text');
            if(connected) { dot.style.color = 'var(--success)'; txt.innerText = "Connected (USB)"; } 
            else { dot.style.color = 'red'; txt.innerText = "Disconnected"; }
        }

        function createDefaultDB() {
            db = { 
                tables: [], products: [], companies: [], supplies: [], 
                sales: [], expenses: [], logs: [], archive: [], ledger: [],
                settings: { cafeName: "Black Bear Coffee", cafeInfo: "0750 XXX XX XX", footer: "Have a nice day!", logo: "" } 
            };
            db.products.push({id: 1, name: 'Espresso', supplier:'Direct Store', price: 2000, cost:0, itemsPerCarton:1, cat: 'Hot', trackStock: false, qty: 0, expiry:''});
            db.companies.push({ id: 999999, name: "General Market", phone: "-", address: "Ø¨Ø§Ø²Ø§Ú•Û Ú¯Ø´ØªÛŒ", balance: 0 });
            db.tables.push({id: 1, name: 'T1', items:[]}, {id:2, name:'T2', items:[]});
        }

        async function attemptLogin() {
            const pin = document.getElementById('pin-code').value;
            const user = USERS.find(u => u.pin === pin);
            
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('user-display').innerText = user.name + " (" + user.role + ")";
                
                // Show role switch button for both users
                document.getElementById('role-switch-btn').style.display = 'inline-block';
                
                const protectedItems = document.querySelectorAll('.protected');
                // Initially show/hide based on actual role
                protectedItems.forEach(el => { 
                    el.style.display = (user.role === 'admin' || isSwitchedRole) ? 'flex' : 'none'; 
                });
                
                renderAll(); applyPrintSettings();
            } else { 
                document.getElementById('login-error').innerText = "Ù¾ÛŒÙ† Ú©Û†Ø¯ Ø®Û•Ù„Û•ØªÛ•!"; 
            }
        }

        function switchRole() {
            if (!currentUser) return;
            
            isSwitchedRole = !isSwitchedRole;
            
            const protectedItems = document.querySelectorAll('.protected');
            protectedItems.forEach(el => { 
                el.style.display = isSwitchedRole ? 'flex' : (currentUser.role === 'admin' ? 'flex' : 'none'); 
            });
            
            document.getElementById('role-switch-btn').innerHTML = isSwitchedRole ? 
                'ğŸ”„ Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ• Ø¨Û† ' + currentUser.role : 'ğŸ”„ Ú¯Û†Ø±ÛŒÙ†ÛŒ Ú•Û†Úµ';
            
            alert(isSwitchedRole ? 
                "Ø¦ÛØ³ØªØ§ Ø¯Û•ØªÙˆØ§Ù†ÛŒØª Ù‡Û•Ù…ÙˆÙˆ Ø¨Û•Ø´Û•Ú©Ø§Ù† Ø¨Ø¨ÛŒÙ†ÛŒØª." : 
                "Ú¯Û•Ú•Ø§ÛŒÛ•ÙˆÛ• Ø¨Û† Ú•Û†ÚµÛŒ Ø®Û†Øª.");
        }

        function nav(id) {
            document.querySelectorAll('.workspace').forEach(w => w.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            const navBtn = document.querySelector(`.nav-item[onclick="nav('${id}')"]`);
            if(navBtn) navBtn.classList.add('active');
            
            if(id === 'companies') renderCompanies(); 
            if(id === 'products') renderProducts();
            if(id === 'warehouse') renderWarehouse('all');
            if(id === 'reports') { renderSalesHistory(); renderDailySales(); renderMonthlyReport(); renderLogs(); }
            if(id === 'tables') { lastTableState = ""; renderTables(); }
            if(id === 'expenses') { renderExpenses(); }
        }
        function renderAll() { if(!db) return; renderDashboard(); renderTables(); renderExpenses(); updateStats(); }

        // --- COMPANY SYSTEM ---
        function saveCompany() {
            const name = document.getElementById('c-name').value;
            const phone = document.getElementById('c-phone').value;
            const addr = document.getElementById('c-addr').value;
            if(!name) return alert("ØªÚ©Ø§ÛŒÛ• Ù†Ø§Ú¤Û Ø´Û•Ø±ÛŒÚ©Û Ø¨Ù†Ú¤ÛŒØ³Û•!");
            db.companies.push({ id: Date.now(), name, phone, address: addr, balance: 0 });
            document.getElementById('c-name').value = ''; document.getElementById('c-phone').value = ''; document.getElementById('c-addr').value = '';
            scheduleSave(); renderCompanies();
        }

        function renderCompanies() {
            const grid = document.getElementById('companies-grid'); grid.innerHTML = '';
            const sortedCompanies = db.companies.sort((a, b) => {
                if (a.name === "General Market") return -1; if (b.name === "General Market") return 1; return 0;
            });
            sortedCompanies.forEach(c => {
                const isGeneral = c.name === "General Market";
                grid.innerHTML += `
                <div class="company-card ${isGeneral ? 'general-market-card' : ''}" onclick="openCompanyProfile(${c.id})">
                    <h3 style="margin:0; color:var(--brand)">${isGeneral ? '<i class="fas fa-globe"></i> ' : ''}${escapeHtml(c.name)}</h3>
                    <p style="color:${isGeneral ? 'white' : '#666'}; font-size:0.9rem; margin:10px 0;"><i class="fas fa-phone"></i> ${escapeHtml(c.phone)}</p>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold; color:${c.balance > 0 ? '#dc2626' : '#10b981'}">Ù‚Û•Ø±Ø²: ${c.balance ? c.balance.toLocaleString() : 0}</span>
                        ${!isGeneral ? `<button class="btn btn-danger btn-sm" style="padding:5px 10px; font-size:0.8rem;" onclick="event.stopPropagation(); deleteCompany(${c.id})"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                </div>`;
            });
        }

        function deleteCompany(id) {
            if(confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒ Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ØŸ Ø¦Ø§ÛŒØªÙ…ÛÙ† ÙˆÛ Ø¯Û Ú†Ù†Û• Ø³Û•Ø± General Market.")) { 
                const comp = db.companies.find(c => c.id === id);
                if(comp) {
                    db.products.forEach(p => {
                        if(p.supplier === comp.name) p.supplier = "General Market";
                    });
                    db.companies = db.companies.filter(c => c.id !== id); 
                    scheduleSave(); renderCompanies(); 
                }
            }
        }

        // --- PROFILE & SUPPLY & DEBT ---
        function openCompanyProfile(id) {
            const comp = db.companies.find(c => c.id === id); if(!comp) return;
            currentViewingCompanyId = id;
            
            // FIXED: These IDs now exist in the HTML
            document.getElementById('cp-name').innerText = comp.name;
            document.getElementById('cp-phone').innerText = comp.phone;
            
            document.getElementById('cp-balance').innerText = formatCurrency(comp.balance || 0) + " IQD";
            switchTab('inventory'); 
            renderCompanyInventory(comp.name); 
            renderCompanyHistory(comp.name);
            renderLedgerHistory(id); 
            document.getElementById('company-profile-modal').style.display = 'flex';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('tab-btn-' + tabName).classList.add('active');
        }

        function renderCompanyInventory(compName) {
            const products = db.products.filter(p => p.supplier === compName);
            const totalValue = products.reduce((sum, p) => sum + (p.cost * (p.trackStock ? p.qty : 0)), 0);
            document.getElementById('cp-total-stock-value').innerText = formatCurrency(totalValue);
            const list = document.getElementById('cp-items-list'); list.innerHTML = '';
            products.forEach(p => {
                let stockTxt = p.trackStock ? (p.itemsPerCarton > 1 ? `${Math.floor(p.qty/p.itemsPerCarton)} Ú©ØŒ ${p.qty%p.itemsPerCarton} Ø¯` : `${p.qty} Ø¯`) : 'âˆ';
                let unitProfit = p.price - p.cost;
                list.innerHTML += `<tr><td><b>${escapeHtml(p.name)}</b></td><td style="color:${p.trackStock && p.qty<5 ? 'red' : 'black'}">${stockTxt}</td><td>${formatCurrency(p.cost)}</td><td>${formatCurrency(p.price)}</td><td style="color:${unitProfit > 0 ? 'green':'red'}">${formatCurrency(unitProfit)}</td><td><button class="btn btn-brand btn-sm" onclick="editProdFromProfile(${p.id})"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm" onclick="deleteProdFromProfile(${p.id}, '${escapeHtml(compName)}')"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        function editProdFromProfile(id) { closeCompanyProfile(); nav('products'); editProd(id); }
        function deleteProdFromProfile(id, compName) {
            const isActive = db.tables.some(t => t.items.some(i => i.id === id));
            if (isActive) return alert("â›” Ù†Ø§ØªÙˆØ§Ù†ÛŒØª Ø¦Û•Ù… Ø¦Ø§ÛŒØªÙ…Û• Ø¨Ø³Ú•ÛŒØªÛ•ÙˆÛ•! Ø¦ÛØ³ØªØ§ Ù„Û•Ø³Û•Ø± Ù…ÛØ²ÛÚ© Ø¯Ø§ÙˆØ§Ú©Ø±Ø§ÙˆÛ•.");
            if(confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒ Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ØŸ")) { db.products = db.products.filter(p => p.id !== id); scheduleSave(); renderCompanyInventory(compName); }
        }

        function renderCompanyHistory(compName) {
            const list = document.getElementById('cp-history-list'); list.innerHTML = '';
            const history = db.supplies.filter(s => s.company === compName).reverse();
            if(history.length === 0) { list.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">Ù‡ÛŒÚ† ØªÛ†Ù…Ø§Ø±ÛÚ© Ù†ÛŒÛŒÛ•</td></tr>'; return; }
            history.forEach(h => {
                let typeBadge = h.type === 'credit' ? '<span style="background:#fee2e2; color:#b91c1c; padding:2px 8px; border-radius:5px;">Ù‚Û•Ø±Ø²</span>' : '<span style="background:#d1fae5; color:#065f46; padding:2px 8px; border-radius:5px;">Ù†Û•Ù‚Ø¯</span>';
                list.innerHTML += `<tr><td>${new Date(h.date).toLocaleDateString()}</td><td>${escapeHtml(h.itemName)}</td><td style="color:var(--success)">+${h.qtyAdded}</td><td>${typeBadge}</td><td>${formatCurrency(h.totalCost)}</td></tr>`;
            });
        }

        function renderLedgerHistory(compId) {
            const list = document.getElementById('cp-ledger-list'); list.innerHTML = '';
            if(!db.ledger) db.ledger = [];
            
            const entries = db.ledger.filter(l => l.companyId === compId).reverse();
            
            if(entries.length === 0) { list.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">Ù‡ÛŒÚ† Ø¬ÙˆÙˆÚµÛ•ÛŒÛ•Ú© Ù†ÛŒÛŒÛ•</td></tr>'; return; }
            
            entries.forEach(l => {
                const isDebt = l.type === 'credit_purchase';
                const typeHtml = isDebt 
                    ? '<span style="color:red; font-weight:bold"><i class="fas fa-arrow-down"></i> ÙˆÛ•Ø±Ú¯Ø±ØªÙ† (Ù‚Û•Ø±Ø²)</span>' 
                    : '<span style="color:green; font-weight:bold"><i class="fas fa-arrow-up"></i> Ø¯Ø§Ù†Û•ÙˆÛ•ÛŒ Ù‚Û•Ø±Ø²</span>';
                
                list.innerHTML += `<tr>
                    <td>${new Date(l.date).toLocaleDateString()}</td>
                    <td>${typeHtml}</td>
                    <td>${formatCurrency(l.amount)}</td>
                    <td>${escapeHtml(l.note)}</td>
                </tr>`;
            });
        }

        function toggleSupplyForm() {
            const form = document.getElementById('new-supply-form');
            const isHidden = form.style.display === 'none' || form.style.display === '';
            form.style.display = isHidden ? 'block' : 'none';
            if(isHidden) {
                const comp = db.companies.find(c => c.id === currentViewingCompanyId);
                document.getElementById('supply-comp-name').innerText = comp.name;
                const grid = document.getElementById('supply-item-grid'); grid.innerHTML = '';
                const prods = db.products.filter(p => p.supplier === comp.name);
                if(prods.length === 0) { grid.innerHTML = '<p style="color:#999;">Ù‡ÛŒÚ† Ø¦Ø§ÛŒØªÙ…ÛÚ© Ù¾ÛÙ†Ø§Ø³Û• Ù†Û•Ú©Ø±Ø§ÙˆÛ• Ø¨Û† Ø¦Û•Ù… Ø´Û•Ø±ÛŒÚ©Û•ÛŒÛ•.</p>'; return; }
                prods.forEach(p => {
                    grid.innerHTML += `<div class="item-select-card" id="sel-card-${p.id}" onclick="selectSupplyItem(${p.id})"><i class="fas fa-box" style="font-size:1.5rem; color:#ccc; margin-bottom:5px;"></i><b>${escapeHtml(p.name)}</b><br><small>Cost: ${formatCurrency(p.cost)}</small></div>`;
                });
                selectedSupplyProdId = null; document.getElementById('supply-selected-prod-id').value = "";
                document.getElementById('supply-cost-hint').style.display = "none";
            }
        }

        function selectSupplyItem(id) {
            document.querySelectorAll('.item-select-card').forEach(el => el.classList.remove('selected'));
            document.getElementById('sel-card-'+id).classList.add('selected');
            selectedSupplyProdId = id; document.getElementById('supply-selected-prod-id').value = id;
            autoCalcSupply();
        }

        function autoCalcSupply() {
            if(!selectedSupplyProdId) return;
            const p = db.products.find(x => x.id == selectedSupplyProdId);
            const cartons = parseInt(document.getElementById('supply-qty-carton').value) || 0;
            const units = parseInt(document.getElementById('supply-qty-unit').value) || 0;
            
            const costPerUnit = p.cost; 
            const costPerCarton = p.cost * p.itemsPerCarton;
            
            const totalCost = (cartons * costPerCarton) + (units * costPerUnit);
            document.getElementById('supply-cost').value = totalCost;
            
            const hint = document.getElementById('supply-cost-hint');
            hint.style.display = 'block';
            hint.innerHTML = `<i class="fas fa-info-circle"></i> Ù†Ø±Ø®ÛŒ ØªØ§Ú©: <b>${formatCurrency(costPerUnit)}</b> | Ù†Ø±Ø®ÛŒ Ú©Ø§Ø±ØªÛ†Ù†: <b>${formatCurrency(costPerCarton)}</b>`;
        }

        function saveSupplyTransaction() {
            const comp = db.companies.find(c => c.id === currentViewingCompanyId);
            const prodId = selectedSupplyProdId;
            const cartonsInput = parseInt(document.getElementById('supply-qty-carton').value) || 0;
            const unitsInput = parseInt(document.getElementById('supply-qty-unit').value) || 0;
            const cost = parseFloat(document.getElementById('supply-cost').value) || 0;
            const type = document.querySelector('input[name="supply-type"]:checked').value; 

            if(!prodId) return alert("ØªÚ©Ø§ÛŒÛ• Ø¦Ø§ÛŒØªÙ… Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•!");
            if(cartonsInput === 0 && unitsInput === 0) return alert("ØªÚ©Ø§ÛŒÛ• Ú˜Ù…Ø§Ø±Û• Ø¨Ù†Ú¤ÛŒØ³Û•!");

            const product = db.products.find(p => p.id == prodId);
            const totalItemsToAdd = (cartonsInput * product.itemsPerCarton) + unitsInput;

            if(product.trackStock) { product.qty += totalItemsToAdd; }

            if(type === 'credit') {
                if(!comp.balance) comp.balance = 0;
                comp.balance += cost; 
                
                if(!db.ledger) db.ledger = [];
                db.ledger.push({
                    id: Date.now(),
                    companyId: comp.id,
                    type: 'credit_purchase',
                    amount: cost,
                    date: new Date(),
                    note: `Ú©Ú•ÛŒÙ†: ${product.name} (Ù‚Û•Ø±Ø²)`
                });

            } else {
                db.expenses.push({ id: Date.now(), note: `Ú©Ú•ÛŒÙ†: ${product.name} Ú˜ ${comp.name}`, amount: cost, date: new Date(), user: currentUser.name });
            }

            db.supplies.push({ 
                id: Date.now(), company: comp.name, prodId: product.id, 
                itemName: product.name, qtyAdded: totalItemsToAdd, totalCost: cost, 
                date: new Date(), type: type 
            });

            scheduleSave();
            
            document.getElementById('supply-qty-carton').value = ''; 
            document.getElementById('supply-qty-unit').value = ''; 
            document.getElementById('supply-cost').value = '';
            toggleSupplyForm(); 
            
            renderCompanyInventory(comp.name); 
            renderCompanyHistory(comp.name);
            renderLedgerHistory(comp.id);
            document.getElementById('cp-balance').innerText = formatCurrency(comp.balance || 0) + " IQD";
            renderExpenses();
            
            alert(`âœ… ${product.name} Ù‡Ø§ØªÛ• Ú©Ú•ÛŒÙ†.`);
        }
        
        function payDebt() {
            const comp = db.companies.find(c => c.id === currentViewingCompanyId);
            if(!comp.balance || Math.round(comp.balance) <= 0) return alert("Ù‡ÛŒÚ† Ù‚Û•Ø±Ø²ÛÚ© Ù„Û•Ø³Û•Ø± Ø¦Û•Ù… Ø´Û•Ø±ÛŒÚ©Û•ÛŒÛ• Ù†ÛŒÛŒÛ•.");
            
            const amount = prompt(`Ø¨Ú•ÛŒ Ù‚Û•Ø±Ø²: ${formatCurrency(comp.balance)}\nÚ†Û•Ù†Ø¯ Ù¾Ø§Ø±Û• Ø¯Û•Ø¯Û•ÛŒØªÛ•ÙˆÛ•ØŸ`);
            if(!amount) return;
            const val = parseFloat(amount);
            if(val <= 0) return;

            if(val > Math.round(comp.balance) + 1) { // +1 for small float tolerance
                alert(`âš ï¸ Ù†Ø§ØªÙˆØ§Ù†ÛŒØª Ø¨Ú•ÛŒ ${formatCurrency(val)} Ø¨Ø¯Û•ÛŒØª! Ù‚Û•Ø±Ø² ØªÛ•Ù†Ù‡Ø§ ${formatCurrency(comp.balance)} Ø¯ÛŒÙ†Ø§Ø±Û•.`);
                return;
            }

            comp.balance -= val;
            
            if(!db.ledger) db.ledger = [];
            db.ledger.push({
                id: Date.now(),
                companyId: comp.id,
                type: 'payment',
                amount: val,
                date: new Date(),
                note: 'Ø¯Ø§Ù†Û•ÙˆÛ•ÛŒ Ù‚Û•Ø±Ø²'
            });

            db.expenses.push({ id: Date.now(), note: `Ø¯Ø§Ù†Û•ÙˆÛ•ÛŒ Ù‚Û•Ø±Ø²: ${comp.name}`, amount: val, date: new Date(), user: currentUser.name });
            
            scheduleSave();
            document.getElementById('cp-balance').innerText = formatCurrency(comp.balance) + " IQD";
            renderLedgerHistory(comp.id);
            renderExpenses();
            alert("âœ… Ù‚Û•Ø±Ø² Ø¯Ø±Ø§ÛŒÛ•ÙˆÛ• Ùˆ Ú†ÙˆÙˆÛ• Ø³Û•Ø± Ø®Û•Ø±Ø¬ÛŒ.");
        }

        function closeCompanyProfile() { document.getElementById('company-profile-modal').style.display = 'none'; renderCompanies(); }

        // --- WAREHOUSE ---
        function renderWarehouse(filter) {
            const allItems = db.products.filter(p => p.trackStock);
            const lowItems = allItems.filter(p => p.qty > 0 && p.qty <= 5);
            const outItems = allItems.filter(p => p.qty <= 0);
            const today = new Date();
            const expItems = allItems.filter(p => {
                if(!p.expiry) return false;
                const expDate = new Date(p.expiry);
                const diffTime = expDate - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) <= 30;
            });

            document.getElementById('wh-count-all').innerText = allItems.length;
            document.getElementById('wh-count-low').innerText = lowItems.length;
            document.getElementById('wh-count-out').innerText = outItems.length;
            document.getElementById('wh-count-exp').innerText = expItems.length;

            let list = []; let title = "Ù‡Û•Ù…ÙˆÙˆ Ø¦Ø§ÛŒØªÙ…Û•Ú©Ø§Ù†";
            if(filter === 'all') list = allItems;
            if(filter === 'low') { list = lowItems; title = "Ø¦Ø§ÛŒØªÙ…Û• Ú©Û•Ù…Ø¨ÙˆÙˆÛ•Ú©Ø§Ù† (Low Stock)"; }
            if(filter === 'out') { list = outItems; title = "Ø¦Ø§ÛŒØªÙ…Û• ØªÛ•ÙˆØ§ÙˆØ¨ÙˆÙˆÛ•Ú©Ø§Ù† (Out of Stock)"; }
            if(filter === 'expired') { list = expItems; title = "Ø¦Ø§ÛŒØªÙ…Û• Ø¨Û•Ø³Û•Ø±Ú†ÙˆÙˆÛ•Ú©Ø§Ù† (Expiring)"; }

            document.getElementById('wh-list-title').innerText = title;
            const tbody = document.getElementById('wh-list-body'); tbody.innerHTML = '';
            list.forEach(p => {
                let statusBadge = `<span class="status-badge-ok">Ø¨Ø§Ø´Û•</span>`;
                if(p.qty <= 0) statusBadge = `<span class="status-badge-out">Ù†Û•Ù…Ø§ÙˆÛ•</span>`;
                else if(p.qty <= 5) statusBadge = `<span class="status-badge-low">Ú©Û•Ù…Ø¨ÙˆÙˆÛ•</span>`;
                if(p.expiry && new Date(p.expiry) < new Date()) statusBadge += ` <span class="status-badge-exp">Ø¨Û•Ø³Û•Ø±Ú†ÙˆÙˆ</span>`;
                tbody.innerHTML += `<tr><td><b>${escapeHtml(p.name)}</b></td><td>${escapeHtml(p.supplier)}</td><td style="font-weight:bold">${p.qty} Ø¯Ø§Ù†Û•</td><td>${p.expiry ? p.expiry : '-'}</td><td>${statusBadge}</td></tr>`;
            });
        }

        // --- PRODUCT MANAGEMENT ---
        function toggleSupplierInput() {
            const source = document.querySelector('input[name="p-source"]:checked').value;
            const wrapper = document.getElementById('supplier-select-wrapper');
            if(source === 'company') { wrapper.style.display = 'block'; } else { wrapper.style.display = 'none'; document.getElementById('p-supplier').value = ""; }
        }

        function calcUnitCost() {
            const totalBuyCost = parseFloat(document.getElementById('p-total-buy-cost').value) || 0;
            const itemsPerCarton = parseInt(document.getElementById('p-per-carton').value) || 1;

            if(itemsPerCarton > 0 && totalBuyCost > 0) {
                const unitCost = totalBuyCost / itemsPerCarton;
                document.getElementById('p-cost').value = Math.round(unitCost); 
            }
        }

        function saveProduct() {
            const id = document.getElementById('p-id').value;
            const name = document.getElementById('p-name').value;
            
            const source = document.querySelector('input[name="p-source"]:checked').value;
            let supplier = "";
            if (source === 'direct') { supplier = "Direct Store"; } 
            else if (source === 'market') {
                supplier = "General Market";
                if(!db.companies.some(c => c.name === "General Market")) { db.companies.push({ id: 999999, name: "General Market", phone: "-", address: "Ø¨Ø§Ø²Ø§Ú•Û Ú¯Ø´ØªÛŒ", balance: 0 }); }
            } else if (source === 'company') {
                supplier = document.getElementById('p-supplier').value;
                if(!supplier) return alert("ØªÚ©Ø§ÛŒÛ• Ø´Û•Ø±ÛŒÚ©Û• Ø¯ÛŒØ§Ø±ÛŒ Ø¨Ú©Û•!");
            }

            const duplicate = db.products.find(p => 
                p.name.trim().toLowerCase() === name.trim().toLowerCase() && 
                p.supplier === supplier &&
                p.id != (id || 0)
            );

            if(duplicate) {
                alert(`â›” Ø¦Û•Ù… Ø¦Ø§ÛŒØªÙ…Û• (${name}) Ù¾ÛØ´ØªØ± ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø§ÙˆÛ•!`);
                return;
            }

            const price = parseFloat(document.getElementById('p-price').value) || 0;
            const cost = parseFloat(document.getElementById('p-cost').value) || 0;
            const cat = document.getElementById('p-cat').value;
            const track = document.getElementById('p-track').checked;
            const expiry = document.getElementById('p-expiry').value;
            const itemsPerCarton = parseInt(document.getElementById('p-per-carton').value) || 1; 
            const cartonCount = parseInt(document.getElementById('p-cartons').value) || 0;
            const looseItems = parseInt(document.getElementById('p-loose').value) || 0;
            
            const totalQty = (cartonCount * itemsPerCarton) + looseItems;

            if (!name) return alert("ØªÚ©Ø§ÛŒÛ• Ù†Ø§Ú¤Û Ø¦Ø§ÛŒØªÙ…ÛŒ Ø¨Ù†Ú¤ÛŒØ³Û•!");

            const productObj = { 
                id: id ? parseInt(id) : Date.now(),
                name, supplier, price, cost, cat, trackStock: track, itemsPerCarton, expiry,
                qty: 0 
            };

            if(id) { 
                const index = db.products.findIndex(x => x.id == id);
                if(index > -1) {
                    productObj.qty = track ? totalQty : 0; 
                    db.products[index] = productObj;
                }
            } else { 
                productObj.qty = track ? totalQty : 0;
                db.products.push(productObj); 
            }
            
            clearProductInputs(); scheduleSave(); renderProducts();
        }

        function clearProductInputs() {
            document.getElementById('p-id').value = '';
            document.getElementById('p-name').value = '';
            document.getElementById('p-supplier').value = '';
            document.getElementById('p-price').value = '';
            document.getElementById('p-cost').value = ''; 
            document.getElementById('p-total-buy-cost').value = ''; 
            document.getElementById('p-cat').value = '';
            document.getElementById('p-cartons').value = '';
            document.getElementById('p-loose').value = '0';
            document.getElementById('p-per-carton').value = '';
            document.getElementById('p-expiry').value = '';
            document.querySelector('input[name="p-source"][value="direct"]').checked = true;
            toggleSupplierInput();
        }

        function editProd(id) {
            const p = db.products.find(x => x.id === id); if (!p) return;
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-name').value = p.name;
            
            if(p.supplier === "Direct Store") { document.querySelector('input[name="p-source"][value="direct"]').checked = true; } 
            else if (p.supplier === "General Market") { document.querySelector('input[name="p-source"][value="market"]').checked = true; } 
            else { document.querySelector('input[name="p-source"][value="company"]').checked = true; toggleSupplierInput(); document.getElementById('p-supplier').value = p.supplier; }
            toggleSupplierInput(); 

            document.getElementById('p-price').value = p.price;
            document.getElementById('p-cost').value = p.cost;
            document.getElementById('p-total-buy-cost').value = p.cost * p.itemsPerCarton; 
            
            document.getElementById('p-cat').value = p.cat;
            document.getElementById('p-track').checked = p.trackStock;
            document.getElementById('p-per-carton').value = p.itemsPerCarton;
            document.getElementById('p-expiry').value = p.expiry;
            
            if(p.trackStock) {
                const cartons = Math.floor(p.qty / p.itemsPerCarton);
                const loose = p.qty % p.itemsPerCarton;
                document.getElementById('p-cartons').value = cartons;
                document.getElementById('p-loose').value = loose;
            } else {
                document.getElementById('p-cartons').value = 0;
                document.getElementById('p-loose').value = 0;
            }
            document.getElementById('product-form-card').scrollIntoView({behavior: 'smooth'});
        }

        function deleteProd(id) { 
            const isActive = db.tables.some(t => t.items.some(i => i.id === id));
            if (isActive) return alert("â›” Ù†Ø§ØªÙˆØ§Ù†ÛŒØª Ø¦Û•Ù… Ø¦Ø§ÛŒØªÙ…Û• Ø¨Ø³Ú•ÛŒØªÛ•ÙˆÛ•! Ø¦ÛØ³ØªØ§ Ù„Û•Ø³Û•Ø± Ù…ÛØ²ÛÚ© Ø¯Ø§ÙˆØ§Ú©Ø±Ø§ÙˆÛ•.");
            if(confirm('Ø¦Ø§ÛŒØªÙ… Ú˜ÛØ¨Ø¨Û•Ù…ØŸ')) { db.products = db.products.filter(p => p.id !== id); scheduleSave(); renderProducts(); }
        }

        function renderProducts(searchQ = '') {
            const container = document.getElementById('product-list-container');
            const select = document.getElementById('p-supplier');
            
            select.innerHTML = '<option value="">Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•...</option>';
            db.companies.filter(c => c.name !== "General Market").forEach(c => { select.innerHTML += `<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`; });
            
            const lowerQ = searchQ.toLowerCase().trim();
            const filteredProducts = db.products.filter(p => {
                return ((p.name && p.name.toLowerCase().includes(lowerQ)) || (p.cat && p.cat.toLowerCase().includes(lowerQ)) || (p.supplier && p.supplier.toLowerCase().includes(lowerQ)));
            });

            container.innerHTML = `
                <table class="report-table" style="margin-top:10px;">
                    <thead><tr><th>Ø¦Ø§ÛŒØªÙ…</th><th>Category</th><th>Cost (Unit)</th><th>Price</th><th>Stock</th><th>Ø¯Ø§Ø¨ÛŒÙ†Ú©Û•Ø±</th><th>Ú©Ø±Ø¯Ø§Ø±</th></tr></thead>
                    <tbody>
                        ${filteredProducts.map(p => `
                        <tr>
                            <td><b>${escapeHtml(p.name)}</b></td>
                            <td>${escapeHtml(p.cat) || '-'}</td>
                            <td>${formatCurrency(p.cost)}</td>
                            <td>${formatCurrency(p.price)}</td>
                            <td style="color:${p.trackStock && p.qty<5 ? 'red':'black'}">${p.trackStock ? p.qty : 'âˆ'}</td>
                            <td>${escapeHtml(p.supplier)}</td>
                            <td>
                                <button class="btn btn-brand btn-sm" onclick="editProd(${p.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-sm" onclick="deleteProd(${p.id})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            `;
            if(document.getElementById('view-pos').style.display !== 'none') { renderPOSMenu(searchQ); }
        }

        // --- DASHBOARD ---
        function updateStats() {
            const todayStr = getBusinessDate(new Date());
            const todaySales = db.sales.filter(s => getBusinessDate(new Date(s.date)) === todayStr);
            const totalSale = todaySales.reduce((sum, s) => sum + s.total, 0);
            const todayExpenses = db.expenses.filter(e => getBusinessDate(new Date(e.date)) === todayStr);
            const totalExp = todayExpenses.reduce((sum, e) => sum + e.amount, 0);

            document.getElementById('st-sales').innerText = formatCurrency(totalSale);
            document.getElementById('st-exp').innerText = formatCurrency(totalExp);
            document.getElementById('st-profit').innerText = formatCurrency(totalSale - totalExp);
            document.getElementById('st-count').innerText = todaySales.length;
        }

        function renderDashboard() {
            const container = document.getElementById('dash-tables'); container.innerHTML = '';
            db.tables.forEach(t => {
                if(t.items && t.items.length > 0) {
                     container.innerHTML += `<div class="p-card table-busy" onclick="openTable(${t.id})"><i class="fas fa-mug-hot" style="font-size:2rem; margin-bottom:10px;"></i><b>${escapeHtml(t.name)}</b><br><small>ğŸ”´ Ù…Ú˜ÙˆÙˆÙ„Û•</small></div>`;
                }
            });
        }
        function renderTables() {
            const currentTableState = JSON.stringify(db.tables);
            if(currentTableState === lastTableState) return; 
            lastTableState = currentTableState;
            const grid = document.getElementById('tables-grid'); grid.innerHTML = '';
            db.tables.forEach(t => {
                const busy = t.items && t.items.length > 0;
                if(busy) {
                    grid.innerHTML += `<div class="p-card table-busy" onclick="openTable(${t.id})"><i class="fas fa-user-clock" style="font-size:2.5rem; margin-bottom:10px;"></i><h3>${escapeHtml(t.name)}</h3><small>ğŸ”´ Ù…Ú˜ÙˆÙˆÙ„Û•</small></div>`;
                } else {
                    grid.innerHTML += `<div class="p-card" style="height:auto; background:white;" onclick="openTable(${t.id})"><i class="fas fa-chair" style="font-size:2.5rem; margin-bottom:10px; color:#cbd5e1"></i><h3>${escapeHtml(t.name)}</h3><small style="color:#94a3b8">Ú¤Ø§Ù„Ø§</small></div>`;
                }
            });
        }
        function addTable() { const n = prompt("Name:"); if(n) { db.tables.push({id: Date.now(), name: n, items: []}); lastTableState = ""; scheduleSave(); renderTables(); } }
        function transferTableUI() {
            const fromName = prompt("From Table:"); if (!fromName) return; const fromTable = db.tables.find(t => t.name == fromName);
            if (!fromTable || fromTable.items.length === 0) return alert("Empty!");
            const toName = prompt("To Table:"); if (!toName) return; const toTable = db.tables.find(t => t.name == toName);
            if (!toTable) return alert("Not Found!");
            if (confirm("Move?")) { toTable.items = [...toTable.items, ...fromTable.items]; fromTable.items = []; scheduleSave(); lastTableState = ""; renderAll(); }
        }

        function printZReport() {
            printDetailedReport('daily');
        }

        // --- POS ---
        function openTable(id) {
            activeTableId = id; const t = db.tables.find(x => x.id === id);
            document.getElementById('pos-actions-default').style.display = 'block'; 
            document.getElementById('pos-active-table').innerText = t.name; document.getElementById('pos-date').innerText = new Date().toLocaleString('ku');
            document.getElementById('nav-pos').style.display = 'flex'; nav('pos'); applyPrintSettings(); renderPOSCategories(); renderPOSMenu(); renderBill();
            
            // Reset discount field when opening table
            document.getElementById('pos-discount').value = '';
        }

        function renderPOSCategories() {
            const container = document.getElementById('category-tabs');
            container.innerHTML = `<button class="cat-btn ${activeCategory === 'all' ? 'active' : ''}" onclick="setCategory('all')">Ù‡Û•Ù…ÛŒ</button>`;
            [...new Set(db.products.map(p => p.cat))].filter(Boolean).forEach(c => {
                container.innerHTML += `<button class="cat-btn ${activeCategory === c ? 'active' : ''}" onclick="setCategory('${escapeHtml(c)}')">${escapeHtml(c)}</button>`;
            });
        }
        function setCategory(cat) { activeCategory = cat; renderPOSCategories(); renderPOSMenu(); }
        
        function renderPOSMenu(q = '') {
            const container = document.getElementById('pos-products'); container.innerHTML = '';
            const lowerQ = q.toLowerCase();
            
            db.products.filter(p => {
                const matchesName = p.name.toLowerCase().includes(lowerQ);
                const matchesCategory = (activeCategory === 'all' || p.cat === activeCategory);
                return matchesName && (lowerQ.length > 0 || matchesCategory);
            }).forEach(p => {
                const hasStock = !p.trackStock || p.qty > 0;
                container.innerHTML += `<div class="p-card" onclick="${hasStock ? `addToBill(${p.id})` : ''}" style="opacity:${hasStock ? 1 : 0.5}">
                    ${p.trackStock ? `<div class="qty-badge">${p.qty}</div>` : ''}<b>${escapeHtml(p.name)}</b><p>${formatCurrency(p.price)}</p></div>`;
            });
        }
        
        function addToBill(pid) {
            const prod = db.products.find(p => p.id === pid); const table = db.tables.find(t => t.id === activeTableId);
            if(prod.trackStock && prod.qty <= 0) return alert("Ù†Û•Ù…Ø§!");
            if(prod.trackStock) prod.qty--;
            table.items.push({...prod, billId: Date.now()}); lastTableState = ""; 
            scheduleSave(); 
            renderBill(); renderPOSMenu(); 
        }

        function renderBill() {
            const table = db.tables.find(t => t.id === activeTableId); const container = document.getElementById('bill-rows'); container.innerHTML = '';
            const grouped = {}; let total = 0;
            table.items.forEach(item => { 
                total += item.price; 
                const key = item.id + '_' + (item.note || '');
                if(!grouped[key]) { grouped[key] = { ...item, count: 0, subtotal: 0, _key: key }; } 
                grouped[key].count++; 
                grouped[key].subtotal += item.price; 
            });
            Object.values(grouped).forEach(g => {
                container.innerHTML += `<div class="bill-row">
                    <div class="p-name" style="flex:2"><b>${escapeHtml(g.name)}</b>${g.note ? `<br><small style="color:var(--info); font-style:italic;">${escapeHtml(g.note)}</small>` : ''}<br><small>${formatCurrency(g.price)}</small></div>
                    <div class="p-qty" style="flex:1; text-align:center;">x${g.count}</div><div class="p-price" style="font-weight:bold; flex:1; text-align:right;">${formatCurrency(g.subtotal)}</div>
                    <div style="display:flex; gap:5px; margin-right:10px;">
                        <button class="btn btn-sm btn-info no-print" onclick="addNoteToItem(${g.id}, '${(g.note||'').replace(/'/g, "\\'")}')"><i class="fas fa-comment-dots"></i></button>
                        <div class="delete-btn no-print" onclick="removeFromBill(${g.id}, '${(g.note||'').replace(/'/g, "\\'")}')"><i class="fas fa-minus"></i></div>
                    </div></div>`;
            });
            
            renderBillTotal();
        }
        
        // --- UPDATED DISCOUNT LOGIC (PERCENTAGE ONLY) ---
        function applyDiscountPercent(pct) {
            const table = db.tables.find(t => t.id === activeTableId);
            if (!table) return;
            let subTotal = table.items.reduce((sum, item) => sum + item.price, 0);
            
            if(pct === 0) {
                 document.getElementById('pos-discount').value = '';
            } else {
                 const amount = Math.round(subTotal * (pct / 100));
                 document.getElementById('pos-discount').value = pct; // Store percentage
            }
            renderBillTotal();
        }

        function renderBillTotal() {
            const table = db.tables.find(t => t.id === activeTableId);
            if (!table) return;
            let total = table.items.reduce((sum, item) => sum + item.price, 0);
            
            // Calculate Discount as Percentage
            const discountInput = document.getElementById('pos-discount').value;
            let finalTotal = total;
            
            if(discountInput && !isNaN(discountInput)) {
                const pct = parseFloat(discountInput);
                if(pct >= 0 && pct <= 100) {
                    const discountAmount = Math.round(total * (pct / 100));
                    finalTotal = total - discountAmount;
                }
            }

            document.getElementById('bill-total').innerText = finalTotal > 0 ? formatCurrency(finalTotal) : 0;
        }

        function addNoteToItem(prodId, currentNote) {
            const note = prompt("ØªÛØ¨ÛŒÙ†ÛŒ Ø¨Ù†ÙˆÙˆØ³Û• (Add Note):", currentNote);
            if(note === null) return;
            const table = db.tables.find(t => t.id === activeTableId);
            // Update all items in this group
            table.items.forEach(item => {
                if(item.id === prodId && (item.note || '') === currentNote) {
                    item.note = note;
                }
            });
            scheduleSave(); renderBill();
        }

        function removeFromBill(prodId, note) {
            const table = db.tables.find(t => t.id === activeTableId); 
            const idx = table.items.findIndex(item => item.id === prodId && (item.note || '') === note);
            if(idx > -1) { 
                const item = table.items[idx]; const prod = db.products.find(p => p.id === item.id); 
                if(prod && prod.trackStock) prod.qty++; 
                table.items.splice(idx, 1); lastTableState = ""; 
                scheduleSave(); 
                renderBill(); renderPOSMenu(); 
            }
        }

        function cancelOrder() {
            const table = db.tables.find(t => t.id === activeTableId);
            if(table.items.length > 0 && confirm("Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒØŸ")) {
                table.items.forEach(item => { const prod = db.products.find(p => p.id === item.id); if(prod && prod.trackStock) prod.qty++; });
                table.items = []; lastTableState = ""; scheduleSave(); nav('tables');
            }
        }

        // --- NEW PRINTING FUNCTIONALITY (PURE KURDISH & LOGO) ---
        function printContent(htmlContent) {
            const area = document.getElementById('printable-area');
            area.innerHTML = htmlContent;
            window.print();
        }

        function printKitchen() { 
             const t = db.tables.find(t => t.id === activeTableId);
             if (t.items.length === 0) return; 
             
             const grouped = {};
             t.items.forEach(i => {
                 const key = i.id + '_' + (i.note || '');
                 if(!grouped[key]) grouped[key] = { ...i, count: 0 };
                 grouped[key].count++;
             });
             
             // Pure Kurdish (Arabic Script) - No Latin
             let html = `
             <div class="print-thermal-container">
                <h2 style="margin:0; font-family:'Segoe UI'">Ú†Ø§ÛŒØ®Ø§Ù†Û•</h2>
                <div class="thermal-divider"></div>
                <div class="thermal-info"><span>Ù…ÛØ²: ${t.name}</span><span>${new Date().toLocaleTimeString()}</span></div>
                <div class="thermal-divider"></div>
                <div class="kitchen-box">
                    ${Object.values(grouped).map(g => `
                        <div class="kitchen-row"><span class="kitchen-qty">${g.count}</span><span class="kitchen-item">${g.name}</span></div>
                        ${g.note ? `<span class="kitchen-note">* ${g.note}</span>` : ''}
                    `).join('')}
                </div>
             </div>`;
             printContent(html);
        }
        
        function processPayment() {
            const table = db.tables.find(t => t.id === activeTableId); if (table.items.length === 0) return;
            const subTotal = table.items.reduce((a,b) => a+b.price, 0); 
            
            // Handle Discount as Percentage
            const discountInput = document.getElementById('pos-discount').value;
            let discount = 0;
            let discountPercent = 0;
            
            if(discountInput && !isNaN(discountInput)) {
                discountPercent = parseFloat(discountInput);
                if(discountPercent >= 0 && discountPercent <= 100) {
                    discount = Math.round(subTotal * (discountPercent / 100));
                }
            }
            
            const total = subTotal - discount;

            const sale = { 
                id: Date.now(), 
                table: table.name, 
                items: [...table.items], 
                total, 
                discount,
                discountPercent,
                date: new Date(), 
                cashier: currentUser.name 
            };
            
            db.sales.push(sale); 
            
            // --- PROFESSIONAL RECEIPT DESIGN (LOGO + PURE KURDISH) ---
            const grouped = {}; 
            sale.items.forEach(i => { 
                const key = i.id + '_' + (i.note || '');
                if(!grouped[key]) grouped[key]={name:i.name, price:i.price, count:0, sub:0, note: i.note}; 
                grouped[key].count++; 
                grouped[key].sub+=i.price; 
            });
            
            const logoHtml = db.settings.logo ? `<img src="${db.settings.logo}" class="thermal-logo">` : '';

            let billHtml = `
                <div class="print-thermal-container">
                    ${logoHtml}
                    <div class="thermal-header">
                        ${!db.settings.logo ? `<h1>${db.settings.cafeName}</h1>` : ''}
                        <p>${db.settings.cafeInfo}</p>
                    </div>
                    
                    <div class="thermal-divider"></div>
                    
                    <div class="thermal-info">
                        <span>Ø¨Û•Ø±ÙˆØ§Ø±: ${new Date(sale.date).toLocaleString('ku')}</span>
                    </div>
                    <div class="thermal-info">
                        <span>ÙˆÛ•Ø³Úµ: #${sale.id.toString().slice(-4)}</span>
                        <span>Ù…ÛØ²: ${sale.table}</span>
                    </div>

                    <div class="thermal-divider"></div>
                    
                    <table class="thermal-table">
                        <thead>
                            <tr>
                                <th style="text-align:right">Ø¨Ø§Ø¨Û•Øª</th>
                                <th style="text-align:center">Ú˜Ù…Ø§Ø±Û•</th>
                                <th style="text-align:left">Ù†Ø±Ø®</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.values(grouped).map(g => `
                            <tr>
                                <td class="row-item">${g.name}${g.note ? `<br><small>* ${g.note}</small>` : ''}</td>
                                <td class="row-qty">x${g.count}</td>
                                <td class="row-price">${formatCurrency(g.sub)}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                    
                    <div class="thermal-divider"></div>
                    
                    <div class="thermal-totals-rtl">
                        <div class="total-row">
                            <span>Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ:</span>
                            <span>${formatCurrency(subTotal)}</span>
                        </div>
                        ${discount > 0 ? `
                        <div class="total-row" style="color:black">
                            <span>Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù† (${discountPercent}%):</span>
                            <span>-${formatCurrency(discount)}</span>
                        </div>` : ''}
                        
                        <div class="grand-total">
                            Ú©Û†ÛŒ Ø³Ø§ÙÛŒ: ${formatCurrency(sale.total)}
                        </div>
                    </div>

                    <div class="thermal-footer">
                        <p>${db.settings.footer}</p>
                        <p>ØªÚ©Ø§ÛŒÛ• Ø³Û•Ø±Ø¯Ø§Ù†Ù…Ø§Ù† Ø¨Ú©Û•Ù†Û•ÙˆÛ•</p>
                    </div>
                </div>
            `;
            
            printContent(billHtml);

            table.items = []; 
            lastTableState = ""; 
            saveToDisk();
            nav('dash');
        }

        // --- EXPENSES & SETTINGS ---
        function renderExpenses() { 
            // Populate Dropdown
            const select = document.getElementById('e-comp-select');
            select.innerHTML = '<option value="">Ø®Û•Ø±Ø¬ÛŒ Ú¯Ø´ØªÛŒ</option>';
            if(db.companies) {
                db.companies.forEach(c => {
                    select.innerHTML += `<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`;
                });
            }

            // Render List
            document.getElementById('expense-list').innerHTML = db.expenses.slice().reverse().map(e => `
                <div class="card" style="padding:10px;">
                    <b>${escapeHtml(e.note)}</b> 
                    <span style="float:left;color:red">${formatCurrency(e.amount)}</span><br>
                    <small style="color:#888">${new Date(e.date).toLocaleDateString()}</small>
                </div>`).join(''); 
        }

        function saveExpense() { 
            const noteInput = document.getElementById('e-note').value;
            const amount = parseInt(document.getElementById('e-amount').value); 
            const compSelect = document.getElementById('e-comp-select').value;
            
            let finalNote = noteInput;
            if(compSelect) {
                finalNote = noteInput ? `${noteInput} (${compSelect})` : `Expense: ${compSelect}`;
            }

            if (finalNote && amount) { 
                db.expenses.push({ id: Date.now(), note: finalNote, amount, date: new Date(), user: currentUser.name }); 
                
                // Clear inputs
                document.getElementById('e-note').value = '';
                document.getElementById('e-amount').value = '';
                document.getElementById('e-comp-select').value = '';
                
                scheduleSave(); 
                renderExpenses(); 
            } 
        }
        
        function savePrintSettings() { 
            db.settings.cafeName = document.getElementById('set-cafe-name').value; 
            db.settings.cafeInfo = document.getElementById('set-cafe-info').value; 
            db.settings.footer = document.getElementById('set-cafe-footer').value; 
            
            // Handle Logo Upload
            const fileInput = document.getElementById('set-cafe-logo');
            if(fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    db.settings.logo = e.target.result; // Store base64
                    scheduleSave(); applyPrintSettings(); alert("Saved with Logo!");
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                scheduleSave(); applyPrintSettings(); alert("Saved!");
            }
        }

        function applyPrintSettings() { if(db && db.settings) { document.getElementById('bill-cafe-name').innerText = db.settings.cafeName; document.getElementById('bill-cafe-info').innerText = db.settings.cafeInfo; document.getElementById('bill-footer-msg').innerText = db.settings.footer; } }
        
        // --- UPDATED BACKUP FUNCTIONS (AVAILABLE FOR CASHIER TOO) ---
        function exportDB() { 
            // Allow both admin and cashier to backup
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); 
            const a = document.createElement('a'); 
            a.href = dataStr; 
            a.download = `BlackBear_Backup_${new Date().toISOString().slice(0,10)}.json`; 
            a.click(); 
        }
        
        function backupToLocal() {
            if (!window.showSaveFilePicker) {
                alert("Ø¦Û•Ù… Ø¦Ø§Ù…ÛØ±Û• Ù¾Ø´ØªÚ¯ÛŒØ±ÛŒ ÙØ§ÛŒÙ„ÛŒ Ø³Û•Ø±Û•Ú©ÛŒ Ù†Ø§Ú©Ø§Øª. ØªÚ©Ø§ÛŒÛ• Export JSON Ø¨Û•Ú©Ø§Ø±Ø¨ÛÙ†Û•.");
                return;
            }
            
            try {
                const options = { 
                    suggestedName: `BlackBear_Backup_${new Date().toISOString().slice(0,10)}.json`, 
                    types: [{ description: 'JSON Database', accept: { 'application/json': ['.json'] } }] 
                };
                
                window.showSaveFilePicker(options).then(handle => {
                    handle.createWritable().then(writable => {
                        writable.write(JSON.stringify(db, null, 2));
                        writable.close();
                        alert("âœ… ÙØ§ÛŒÙ„Û•Ú©Û•Øª Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§!");
                    });
                });
            } catch (err) {
                exportDB(); // Fallback to regular export
            }
        }
        
        function archiveOldData() {
            if(!confirm("Ø¯Ø§ØªØ§ÛŒ Ú©Û†Ù†ØªØ± Ù„Û• 365 Ú•Û†Ú˜ Ø¦Û•Ø±Ø´ÛŒÙ Ø¯Û•Ú©Û•ÛŒØªØŸ")) return;
            const cutoffDate = new Date(); 
            cutoffDate.setDate(cutoffDate.getDate() - 365);
            
            const oldSales = db.sales.filter(s => new Date(s.date) < cutoffDate);
            const keepSales = db.sales.filter(s => new Date(s.date) >= cutoffDate);
            
            if(oldSales.length === 0) return alert("Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ø¨Û† Ø¦Û•Ø±Ø´ÛŒÙÚ©Ø±Ø¯Ù† Ù†ÛŒÛŒÛ•.");
            
            if(!db.archive) db.archive = [];
            db.archive.push(...oldSales); 
            db.sales = keepSales;
            
            // Also archive old expenses
            const oldExpenses = db.expenses.filter(e => new Date(e.date) < cutoffDate);
            const keepExpenses = db.expenses.filter(e => new Date(e.date) >= cutoffDate);
            
            // Create archive for expenses if not exists
            if(!db.expensesArchive) db.expensesArchive = [];
            db.expensesArchive.push(...oldExpenses);
            db.expenses = keepExpenses;
            
            saveToDisk(); 
            alert(`${oldSales.length} Ù¾Ø³ÙˆÙˆÙ„Û• Ùˆ ${oldExpenses.length} Ø®Û•Ø±Ø¬ÛŒ Ø®Ø±Ø§Ù†Û• Ø¦Û•Ø±Ø´ÛŒÙÛ•ÙˆÛ•.`);
        }

        // --- REPORTING (ENHANCED) ---
        function renderDailySales() { 
            const container = document.getElementById('daily-sales-list'); container.innerHTML = ''; 
            const grouped = {}; 
            db.sales.forEach(s => { 
                const k = getBusinessDate(new Date(s.date)); 
                if(!grouped[k]) grouped[k] = {c:0, t:0}; 
                grouped[k].c++; grouped[k].t += s.total; 
            }); 
            Object.keys(grouped).reverse().forEach(d => container.innerHTML += `<tr><td>${d}</td><td>${grouped[d].c}</td><td>${formatCurrency(grouped[d].t)}</td></tr>`); 
        }
        function renderLogs() { document.getElementById('log-list').innerHTML = db.logs.map(l => `<div style="border-bottom:1px solid #eee; font-size:0.8rem;">${escapeHtml(l.action)}</div>`).join(''); }
        
        function filterHistory(q) { 
            const list = document.getElementById('sales-history-list'); list.innerHTML = ''; 
            // Search in Active Sales + Archive
            const all = getAllSales();
            const filtered = all.filter(s => s.id.toString().includes(q) || s.table.includes(q)); 
            
            filtered.slice().reverse().forEach(s => { 
                list.innerHTML += `
                <div style="border-bottom:1px solid #ddd; padding:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div><b>#${s.id.toString().slice(-4)}</b> - ${formatCurrency(s.total)} IQD<br><span style="font-size:0.8rem; color:#666">${new Date(s.date).toLocaleString()}</span></div>
                    <div>
                        <button class="btn btn-sm btn-dark" onclick="reprintBill(${s.id})"><i class="fas fa-print"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="refundSale(${s.id})"><i class="fas fa-undo"></i> Refund</button>
                    </div>
                </div>`; 
            }); 
        }
        function renderSalesHistory() { filterHistory(''); }
        function renderMonthlyReport() { 
            const container = document.getElementById('monthly-report-list'); container.innerHTML = ''; 
            const stats = {}; 
            const allSales = getAllSales();
            allSales.forEach(s => { const key = getBusinessMonth(new Date(s.date)); if(!stats[key]) stats[key] = { sales:0, expenses:0 }; stats[key].sales += s.total; }); 
            db.expenses.forEach(e => { const key = getBusinessMonth(new Date(e.date)); if(!stats[key]) stats[key] = { sales:0, expenses:0 }; stats[key].expenses += e.amount; }); 
            Object.keys(stats).sort().reverse().forEach(key => { const s = stats[key]; const net = s.sales - s.expenses; container.innerHTML += `<tr><td>${key}</td><td style="color:var(--success)">${formatCurrency(s.sales)}</td><td style="color:var(--danger)">${formatCurrency(s.expenses)}</td><td style="font-weight:bold">${formatCurrency(net)}</td><td>-</td></tr>`; }); 
        }

        // --- REPRINT ---
        function reprintBill(id) {
            const sale = getAllSales().find(s => s.id === id);
            if(!sale) return;
            const grouped = {}; 
            sale.items.forEach(i => { 
                const key = i.id + '_' + (i.note || '');
                if(!grouped[key]) grouped[key]={name:i.name, price:i.price, count:0, sub:0, note: i.note}; 
                grouped[key].count++; 
                grouped[key].sub+=i.price; 
            });
            
            // Check logo
            const logoHtml = db.settings.logo ? `<img src="${db.settings.logo}" class="thermal-logo">` : '';

            let billHtml = `
                <div class="print-thermal-container">
                    ${logoHtml}
                    <div class="thermal-header">
                         ${!db.settings.logo ? `<h1>${db.settings.cafeName}</h1>` : ''}
                        <p>COPY - REPRINT</p>
                    </div>
                    <div class="thermal-divider"></div>
                    <div class="thermal-info">
                        <span>Ø¨Û•Ø±ÙˆØ§Ø±: ${new Date(sale.date).toLocaleString('ku')}</span>
                    </div>
                    <div class="thermal-info">
                        <span>ÙˆÛ•Ø³Úµ: #${sale.id.toString().slice(-4)}</span>
                    </div>
                    <div class="thermal-divider"></div>
                    <table class="thermal-table">
                        ${Object.values(grouped).map(g => `<tr><td class="row-item">${g.name}${g.note ? `<br><small>* ${g.note}</small>` : ''}</td><td class="row-qty">x${g.count}</td><td class="row-price">${formatCurrency(g.sub)}</td></tr>`).join('')}
                    </table>
                    <div class="thermal-divider"></div>
                    
                     <div class="thermal-totals-rtl">
                        <div class="total-row">
                             <span>Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ:</span>
                            <span>${formatCurrency(sale.total + (sale.discount || 0))}</span>
                        </div>
                         ${sale.discount > 0 ? `
                        <div class="total-row">
                            <span>Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù† (${sale.discountPercent || 0}%):</span>
                            <span>-${formatCurrency(sale.discount)}</span>
                        </div>` : ''}
                        <div class="grand-total">Ú©Û†ÛŒ Ø³Ø§ÙÛŒ: ${formatCurrency(sale.total)}</div>
                    </div>
                </div>
            `;
            printContent(billHtml);
        }

        function refundSale(id) {
            if(!confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒ Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¦Û•Ù… ÙˆÛ•Ø³ÚµÛ•ØŸ\nÙ…Û•ÙˆØ§Ø¯ Ø¯Û•Ú¯Û•Ú•ÛÙ†Û•ÙˆÛ• Ù…Û•Ø®Ø²Û•Ù†.")) return;
            const saleIdx = db.sales.findIndex(s => s.id === id);
            if(saleIdx === -1) return alert("ÙˆÛ•Ø³Úµ Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ• (Ú•Û•Ù†Ú¯Û• Ù„Û• Ø¦Û•Ø±Ø´ÛŒÙ Ø¨ÛØª).");
            
            const sale = db.sales[saleIdx];
            sale.items.forEach(item => {
                const prod = db.products.find(p => p.id === item.id);
                if(prod && prod.trackStock) {
                    prod.qty++;
                }
            });

            db.sales.splice(saleIdx, 1);
            scheduleSave();
            renderSalesHistory();
            updateStats();
            alert("ÙˆÛ•Ø³Úµ Ø³Ú•Ø§ÛŒÛ•ÙˆÛ• (Refunded).");
        }

        function printExpenses() {
            const totalExp = db.expenses.reduce((a,b) => a+b.amount, 0);
            
            let html = `
                <div class="print-a4-container">
                    <div class="print-header">
                        <div>
                            <h1 style="color: #1f2937; margin: 0;">${db.settings.cafeName}</h1>
                            <p style="color:#666; margin: 5px 0;">${db.settings.cafeInfo}</p>
                        </div>
                        <div style="text-align:right">
                            <h2 style="color: #1f2937; margin: 0;">Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ø®Û•Ø±Ø¬ÛŒÛŒÛ•Ú©Ø§Ù†</h2>
                            <p style="color:#6b7280; margin: 5px 0;">Ø¨Û•Ø±ÙˆØ§Ø±: ${new Date().toLocaleDateString('ku')}</p>
                        </div>
                    </div>
                    
                    <div class="print-summary-box">
                        <div class="p-box" style="border-color: #ef4444; grid-column: span 3;">
                            <h3>Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ Ø®Û•Ø±Ø¬ÛŒ</h3>
                            <h2 style="color: #ef4444;">${formatCurrency(totalExp)} IQD</h2>
                        </div>
                    </div>

                    <div class="section-title">Ù„ÛŒØ³ØªÛ•ÛŒ Ø®Û•Ø±Ø¬ÛŒÛŒÛ•Ú©Ø§Ù†</div>
                    <table class="print-table">
                        <thead><tr><th>Ø¨Û•Ø±ÙˆØ§Ø±</th><th>ØªÛØ¨ÛŒÙ†ÛŒ</th><th>Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±</th><th>Ø¨Ú• (IQD)</th></tr></thead>
                        <tbody>
                            ${db.expenses.slice().reverse().map(e => `
                                <tr>
                                    <td>${new Date(e.date).toLocaleDateString('ku')}</td>
                                    <td>${escapeHtml(e.note)}</td>
                                    <td>${escapeHtml(e.user || '-')}</td>
                                    <td style="text-align:right; color:#ef4444; font-weight:bold;">${formatCurrency(e.amount)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="report-footer">
                        Black Bear POS Pro 2026 | Expenses Report
                    </div>
                </div>
            `;
            printContent(html);
        }
        
        function printLedger() {
            const comp = db.companies.find(c => c.id === currentViewingCompanyId);
            if(!comp) return;
            
            const l = db.ledger.filter(x => x.companyId === currentViewingCompanyId).reverse();
            
            let html = `
                <div class="print-a4-container">
                    <div class="print-header">
                        <div>
                            <h1 style="color: #1f2937; margin: 0;">${db.settings.cafeName}</h1>
                            <p style="color:#666; margin: 5px 0;">${db.settings.cafeInfo}</p>
                        </div>
                        <div style="text-align:right">
                            <h2 style="color: #1f2937; margin: 0;">Ú©Û•Ø´Ù Ø­ÛŒØ³Ø§Ø¨ (Ledger)</h2>
                            <p style="color:#6b7280; margin: 5px 0;">Ø´Û•Ø±ÛŒÚ©Û•: ${escapeHtml(comp.name)}</p>
                        </div>
                    </div>
                    
                    <div class="print-summary-box">
                        <div class="p-box" style="border-color: #3b82f6;">
                            <h3>Ù‚Û•Ø±Ø²ÛŒ Ù…Ø§ÙˆÛ•</h3>
                            <h2 style="color: #dc2626;">${formatCurrency(comp.balance)} IQD</h2>
                        </div>
                    </div>

                    <div class="section-title">ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ Ø¬ÙˆÙˆÚµÛ•Ú©Ø§Ù†</div>
                    <table class="print-table">
                        <thead><tr><th>Ø¨Û•Ø±ÙˆØ§Ø±</th><th>Ø¬Û†Ø±</th><th>ØªÛØ¨ÛŒÙ†ÛŒ</th><th>Ø¨Ú• (IQD)</th></tr></thead>
                        <tbody>
                            ${l.map(x => {
                                const isDebt = x.type === 'credit_purchase';
                                const typeLabel = isDebt ? 'ÙˆÛ•Ø±Ú¯Ø±ØªÙ† (Ù‚Û•Ø±Ø²)' : 'Ø¯Ø§Ù†Û•ÙˆÛ•ÛŒ Ù¾Ø§Ø±Û•';
                                const color = isDebt ? '#dc2626' : '#059669';
                                return `
                                <tr>
                                    <td>${new Date(x.date).toLocaleDateString('ku')}</td>
                                    <td style="color:${color}; font-weight:bold;">${typeLabel}</td>
                                    <td>${escapeHtml(x.note)}</td>
                                    <td style="text-align:right; font-weight:bold;">${formatCurrency(x.amount)}</td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div class="report-footer">
                        Black Bear POS Pro 2026 | Ledger Report
                    </div>
                </div>
            `;
            printContent(html);
        }

        // --- DETAILED REPORT (A4 DESIGN) - ENHANCED ---
        function printDetailedReport(type) {
            const today = getBusinessDate(new Date());
            const thisMonth = getBusinessMonth(new Date());
            const allSales = getAllSales();
            
            let filteredSales = [];
            let filteredExpenses = [];
            let title = "";

            if(type === 'daily') {
                filteredSales = allSales.filter(s => getBusinessDate(new Date(s.date)) === today);
                filteredExpenses = db.expenses.filter(e => getBusinessDate(new Date(e.date)) === today);
                title = `Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ú•Û†Ú˜Ø§Ù†Û•: ${today}`;
            } else {
                filteredSales = allSales.filter(s => getBusinessMonth(new Date(s.date)) === thisMonth);
                filteredExpenses = db.expenses.filter(e => getBusinessMonth(new Date(e.date)) === thisMonth);
                title = `Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û•: ${thisMonth}`;
            }

            const itemCounts = {};
            let totalRevenue = 0;
            
            filteredSales.forEach(s => {
                totalRevenue += s.total;
                s.items.forEach(i => {
                    const safeName = escapeHtml(i.name);
                    if(!itemCounts[safeName]) itemCounts[safeName] = { qty: 0, total: 0 };
                    itemCounts[safeName].qty++;
                    itemCounts[safeName].total += i.price;
                });
            });

            const totalExp = filteredExpenses.reduce((a,b) => a+b.amount, 0);
            const net = totalRevenue - totalExp;

            // A4 HTML GENERATION - ENHANCED
            let html = `
                <div class="print-a4-container">
                    <div class="print-header">
                        <div>
                            <h1 style="color: #1f2937; margin: 0;">${db.settings.cafeName}</h1>
                            <p style="color:#666; margin: 5px 0;">${db.settings.cafeInfo}</p>
                        </div>
                        <div style="text-align:right">
                            <h2 style="color: #1f2937; margin: 0;">${title}</h2>
                            <p style="color:#6b7280; margin: 5px 0;">Ø¨Û•Ø±ÙˆØ§Ø±: ${new Date().toLocaleDateString('ku')}</p>
                        </div>
                    </div>
                    
                    <div class="print-summary-box">
                        <div class="p-box" style="border-color: #10b981;">
                            <h3>Ú©Û†ÛŒ ÙØ±Û†Ø´ØªÙ†</h3>
                            <h2 style="color: #10b981;">${formatCurrency(totalRevenue)} IQD</h2>
                        </div>
                        <div class="p-box" style="border-color: #ef4444;">
                            <h3>Ú©Û†ÛŒ Ø®Û•Ø±Ø¬ÛŒ</h3>
                            <h2 style="color: #ef4444;">${formatCurrency(totalExp)} IQD</h2>
                        </div>
                        <div class="p-box" style="background:#f0f9ff; border-color: #3b82f6;">
                            <h3>Ù‚Ø§Ø²Ø§Ù†Ø¬ÛŒ Ø³Ø§Ù</h3>
                            <h2 style="color: #1f2937;">${formatCurrency(net)} IQD</h2>
                        </div>
                    </div>

                    <div class="section-title">Ù¡. ÙØ±Û†Ø´ØªÙ† Ø¨Û•Ù¾ÛÛŒ Ø¦Ø§ÛŒØªÙ…</div>
                    <table class="print-table">
                        <thead><tr><th>Ø¦Ø§ÛŒØªÙ…</th><th>Ú˜Ù…Ø§Ø±Û•</th><th>Ú©Û†ÛŒ Ù†Ø±Ø®</th></tr></thead>
                        <tbody>
                            ${Object.keys(itemCounts).map(k => `
                                <tr>
                                    <td><b>${k}</b></td>
                                    <td style="text-align:center; font-weight:bold;">${itemCounts[k].qty}</td>
                                    <td style="text-align:right; font-weight:bold;">${formatCurrency(itemCounts[k].total)} IQD</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="section-title">Ù¢. Ø®Û•Ø±Ø¬ÛŒÛŒÛ•Ú©Ø§Ù†</div>
                     <table class="print-table">
                        <thead><tr><th>ØªÛØ¨ÛŒÙ†ÛŒ</th><th>Ø¨Ú• (IQD)</th></tr></thead>
                        <tbody>
                            ${filteredExpenses.map(e => `<tr><td>${escapeHtml(e.note)}</td><td style="text-align:right; color:#ef4444;">${formatCurrency(e.amount)}</td></tr>`).join('')}
                            ${filteredExpenses.length === 0 ? '<tr><td colspan="2" style="text-align:center; color:#999;">Ù‡ÛŒÚ† Ø®Û•Ø±Ø¬ÛŒÛŒÛ•Ú© Ù†ÛŒÛŒÛ•</td></tr>' : ''}
                        </tbody>
                    </table>

                    <div class="section-title">Ù£. Ù¾Ø³ÙˆÙˆÙ„Û•Ú©Ø§Ù†</div>
                    <table class="print-table">
                        <thead><tr><th>Ú˜Ù…Ø§Ø±Û•ÛŒ ÙˆÛ•Ø³Úµ</th><th>Ù…ÛØ²</th><th>Ú©Û†ÛŒ Ù†Ø±Ø®</th><th>Ú©Ø§Øª</th></tr></thead>
                        <tbody>
                            ${filteredSales.slice().reverse().map(s => `
                                <tr>
                                    <td>#${s.id.toString().slice(-4)}</td>
                                    <td>${escapeHtml(s.table)}</td>
                                    <td style="text-align:right;">${formatCurrency(s.total)} IQD</td>
                                    <td>${new Date(s.date).toLocaleTimeString('ku', {hour: '2-digit', minute:'2-digit'})}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="report-footer">
                        Black Bear POS Pro 2026 | Generated at: ${new Date().toLocaleString('ku')}
                    </div>
                </div>
            `;

            printContent(html);
        }
        
        function printDebtReport() {
            const companiesWithDebt = db.companies.filter(c => c.balance > 0);
            let totalDebt = 0;
            companiesWithDebt.forEach(c => totalDebt += c.balance);
            
            let html = `
                <div class="print-a4-container">
                    <div class="print-header">
                        <div>
                            <h1 style="color: #1f2937; margin: 0;">${db.settings.cafeName}</h1>
                            <p style="color:#666; margin: 5px 0;">${db.settings.cafeInfo}</p>
                        </div>
                        <div style="text-align:right">
                            <h2 style="color: #1f2937; margin: 0;">Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ù‚Û•Ø±Ø²Û•Ú©Ø§Ù†</h2>
                            <p style="color:#6b7280; margin: 5px 0;">Ø¨Û•Ø±ÙˆØ§Ø±: ${new Date().toLocaleDateString('ku')}</p>
                        </div>
                    </div>
                    
                    <div class="print-summary-box">
                        <div class="p-box" style="border-color: #dc2626; background: #fef2f2;">
                            <h3>Ú©Û†Ù… Ù‚Û•Ø±Ø²ÛŒ Ú¯Ø´ØªÛŒ</h3>
                            <h2 style="color: #dc2626;">${formatCurrency(totalDebt)} IQD</h2>
                        </div>
                        <div class="p-box" style="border-color: #d97706; background: #fffbeb;">
                            <h3>Ú˜Ù…Ø§Ø±Û•ÛŒ Ø´Û•Ø±ÛŒÚ©Û• Ù‚Û•Ø±Ø²Ø¯Ø§Ø±Û•Ú©Ø§Ù†</h3>
                            <h2 style="color: #d97706;">${companiesWithDebt.length}</h2>
                        </div>
                        <div class="p-box" style="border-color: #059669; background: #ecfdf5;">
                            <h3>Ø´Û•Ø±ÛŒÚ©Û• Ø¨Û Ù‚Û•Ø±Ø²Û•Ú©Ø§Ù†</h3>
                            <h2 style="color: #059669;">${db.companies.length - companiesWithDebt.length}</h2>
                        </div>
                    </div>

                    <div class="section-title">Ù„ÛŒØ³ØªÛ•ÛŒ Ù‚Û•Ø±Ø²Û•Ú©Ø§Ù†</div>
                    <table class="print-table">
                        <thead><tr><th>Ø´Û•Ø±ÛŒÚ©Û•</th><th>Ú˜Ù…Ø§Ø±Û•ÛŒ ØªÛ•Ù„Û•ÙÛ†Ù†</th><th>Ø¨Ú•ÛŒ Ù‚Û•Ø±Ø² (IQD)</th><th>Ù†Ø§Ú¤Ù†ÛŒØ´Ø§Ù†</th></tr></thead>
                        <tbody>
                            ${companiesWithDebt.map(c => `
                                <tr>
                                    <td><b>${escapeHtml(c.name)}</b></td>
                                    <td>${escapeHtml(c.phone)}</td>
                                    <td style="text-align:right; color:#dc2626; font-weight:bold;">${formatCurrency(c.balance)}</td>
                                    <td>${escapeHtml(c.address)}</td>
                                </tr>
                            `).join('')}
                            ${companiesWithDebt.length === 0 ? '<tr><td colspan="4" style="text-align:center; color:#999; padding:30px;">Ù‡ÛŒÚ† Ù‚Û•Ø±Ø²ÛÚ© Ù†ÛŒÛŒÛ•</td></tr>' : ''}
                        </tbody>
                    </table>
                    
                    <div class="section-title">ØªÛØ¨ÛŒÙ†ÛŒ</div>
                    <div style="background: #f8fafc; padding: 20px; border-radius: 10px; margin-top: 20px; border: 1px solid #e2e8f0;">
                        <p style="margin: 0; color: #4b5563;">
                            Ø¦Û•Ù… Ú•Ø§Ù¾Û†Ø±ØªÛ• ØªÛ•Ù†Ù‡Ø§ Ù‚Û•Ø±Ø²Û•Ú©Ø§Ù†ÛŒ Ø´Û•Ø±ÛŒÚ©Û•Ú©Ø§Ù† Ù¾ÛØ´Ø§Ù† Ø¯Û•Ø¯Ø§Øª Ú©Û• Ø¨Ú•ÛŒØ§Ù† Ù„Û• Ø³ÙØ± Ø²ÛŒØ§ØªØ±Û•.
                            Ø¦Û•Ú¯Û•Ø± Ù‡Û•Ù…ÙˆÙˆ Ø´Û•Ø±ÛŒÚ©Û•Ú©Ø§Ù† Ø¨Û Ù‚Û•Ø±Ø² Ø¨Ù†ØŒ Ø¦Û•ÙˆØ§ Ù‡ÛŒÚ† ØªÛ†Ù…Ø§Ø±ÛÚ© Ù†Ø§Ø¨ÛŒÙ†Ø±ÛØª.
                        </p>
                    </div>

                    <div class="report-footer">
                        Black Bear POS Pro 2026 | Debt Report
                    </div>
                </div>
            `;
            
            printContent(html);
        }
    </script>
</body>
</html>
