<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø³Ø¨Ù„ Ø§Ù„Ø³Ù„Ø§Ù… | Ú•ÛÚ•Û•ÙˆØ§ Ø²Ø§Ù†Ø³ØªÛ Ø´Û•Ø±Ø¹ÛŒ</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;500;700;800&display=swap');

/* --- THEME VARIABLES --- */
:root {
    --bg-main: #0f172a; 
    --bg-secondary: #1e293b; 
    --bg-glass: rgba(30, 41, 59, 0.95);
    --text-primary: #f8fafc; 
    --text-secondary: #94a3b8; 
    --accent-primary: #fbbf24; 
    --accent-glow: rgba(251, 191, 36, 0.4);
    --accent-secondary: #0ea5e9; 
    --border-color: #334155;
    --success-color: #10b981; 
    --danger-color: #ef4444; 
    --warning-color: #f59e0b;
    --font-body: 'Noto Naskh Arabic', sans-serif;
    --radius-xl: 24px;
    --radius-md: 16px;
    --radius-sm: 8px;
    --shadow-main: 0 10px 30px -10px rgba(0,0,0,0.5);
    --nav-height: 70px; /* NEW: Height for bottom nav */
    --gradient-bg: radial-gradient(circle at 10% 10%, rgba(14, 165, 233, 0.05) 0%, transparent 40%),
                   radial-gradient(circle at 90% 90%, rgba(251, 191, 36, 0.05) 0%, transparent 40%);
}

[data-theme="light"] {
    --bg-main: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-glass: rgba(255, 255, 255, 0.95);
    --text-primary: #0f172a;
    --text-secondary: #64748b;
    --accent-primary: #d97706; 
    --accent-glow: rgba(217, 119, 6, 0.3);
    --accent-secondary: #0284c7; 
    --border-color: #e2e8f0;
    --shadow-main: 0 10px 30px -10px rgba(0,0,0,0.1);
    --gradient-bg: radial-gradient(circle at 10% 10%, rgba(2, 132, 199, 0.05) 0%, transparent 40%),
                   radial-gradient(circle at 90% 90%, rgba(217, 119, 6, 0.05) 0%, transparent 40%);
}

* { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
html { scroll-behavior: smooth; }
body { 
    font-family: var(--font-body); 
    background-color: var(--bg-main); 
    color: var(--text-primary); 
    line-height: 1.8; 
    overflow-x: hidden; 
    min-height: 100vh;
    background-image: var(--gradient-bg);
    transition: background-color 0.3s, color 0.3s;
    padding-bottom: calc(var(--nav-height) + 20px); /* SPACE FOR BOTTOM NAV */
}

/* Scrollbar */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-main); }
::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }

.container { width: 92%; max-width: 1200px; margin: auto; }

/* Loading Screen */
#loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-main); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.8s ease-out, visibility 0.8s; }
#loading-screen.fade-out { opacity: 0; visibility: hidden; }
.spinner { width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; box-shadow: 0 0 20px var(--accent-glow); }
@keyframes spin { to { transform: rotate(360deg); } }

/* Toast Notifications */
#toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 8000; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
.toast { background: var(--bg-secondary); border-left: 5px solid var(--accent-primary); padding: 15px; border-radius: var(--radius-sm); box-shadow: 0 10px 30px rgba(0,0,0,0.3); color: var(--text-primary); opacity: 0; transform: translateY(-20px); transition: 0.4s; pointer-events: auto; display: flex; align-items: center; gap: 15px; }
.toast.show { opacity: 1; transform: translateY(0); }
.toast.warning { border-color: var(--warning-color); }
.toast.danger { border-color: var(--danger-color); }
.toast.success { border-color: var(--success-color); }
.toast-icon { font-size: 1.5rem; }

/* Header */
header { position: sticky; top: 0; width: 100%; padding: 15px 0; z-index: 1000; background: var(--bg-secondary); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-color); transition: 0.3s; }
.header-container { display: flex; justify-content: space-between; align-items: center; }
.logo { display: flex; align-items: center; gap: 12px; text-decoration: none; }
.logo-icon { font-size: 2.2rem; color: var(--accent-primary); filter: drop-shadow(0 0 8px var(--accent-glow)); transition: 0.3s; }
.logo:hover .logo-icon { transform: rotate(10deg); }
.logo-text { font-weight: 800; font-size: 1.6rem; color: var(--text-primary); letter-spacing: -0.5px; }
.header-actions { display: flex; align-items: center; gap: 15px; }
.points-display { font-size: 0.95rem; color: var(--accent-primary); background: rgba(251, 191, 36, 0.08); padding: 6px 14px; border-radius: 50px; border: 1px solid rgba(251, 191, 36, 0.2); display: flex; align-items: center; gap: 8px; font-weight: bold; transition: 0.3s; }

.icon-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-main); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; color: var(--text-secondary); position: relative; }
.icon-btn:hover { background: var(--accent-secondary); color: white; border-color: var(--accent-secondary); transform: scale(1.1); }
.notification-dot { position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: var(--danger-color); border-radius: 50%; border: 2px solid var(--bg-main); display: none; }
.notification-dot.active { display: block; }

/* --- NEW BOTTOM NAVIGATION --- */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: var(--nav-height);
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-around;
    align-items: center;
    z-index: 5000;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
    backdrop-filter: blur(15px);
}
.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    font-size: 0.8rem;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
    width: 33%;
    height: 100%;
    position: relative;
    padding-top: 5px;
}
.nav-item i { font-size: 1.4rem; margin-bottom: 5px; transition: 0.3s; }
.nav-item.active { color: var(--accent-secondary); }
.nav-item.active i { transform: translateY(-3px); color: var(--accent-secondary); text-shadow: 0 0 10px rgba(14, 165, 233, 0.4); }
.nav-item.active::after {
    content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
    width: 40px; height: 4px; background: var(--accent-secondary); border-radius: 0 0 10px 10px;
}

/* VIEWS (For Tab Switching) */
.view-section { display: none; animation: fadeIn 0.4s ease-out; }
.view-section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }


/* Hero Section */
.hero { text-align: center; padding: 60px 20px 40px; position: relative; overflow: hidden; margin-bottom: 20px; }
.hero::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; height: 600px; background: var(--accent-secondary); opacity: 0.05; filter: blur(100px); border-radius: 50%; z-index: -1; }
.hero h1 { font-size: 3rem; margin-bottom: 25px; background: linear-gradient(135deg, var(--text-primary) 20%, var(--accent-secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; letter-spacing: -1px; line-height: 1.2; }
.hero p { font-size: 1.1rem; color: var(--text-secondary); max-width: 700px; margin: 0 auto 30px; }

.btn-group { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
.btn-primary { background: linear-gradient(90deg, var(--accent-primary), #f59e0b); color: #0f172a; padding: 14px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: 700; text-decoration: none; display: inline-flex; align-items: center; gap: 10px; transition: all 0.3s ease; border: none; cursor: pointer; box-shadow: 0 10px 25px rgba(251, 191, 36, 0.3); }
.btn-primary:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 15px 35px rgba(251, 191, 36, 0.5); }
.btn-outline { background: transparent; border: 2px solid var(--border-color); color: var(--text-primary); padding: 12px 30px; border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
.btn-outline:hover { border-color: var(--accent-secondary); color: var(--accent-secondary); background: rgba(14, 165, 233, 0.05); }

/* Levels & Timeline */
.timeline-container { padding: 20px 0 60px; position: relative; }
.level-card { background: var(--bg-glass); border: 1px solid var(--border-color); border-radius: var(--radius-xl); margin-bottom: 40px; overflow: hidden; position: relative; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
.level-card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.1); box-shadow: var(--shadow-main); }
.level-card.active { border-color: var(--accent-secondary); box-shadow: 0 0 20px rgba(14, 165, 233, 0.15); }
.level-card.locked { opacity: 0.7; filter: grayscale(1); border-style: dashed; }
.level-card.locked .level-header { cursor: not-allowed; }

.level-header { padding: 35px; display: flex; align-items: center; gap: 25px; cursor: pointer; background: linear-gradient(to left, rgba(255,255,255,0.02), transparent); }
.level-icon-box { width: 70px; height: 70px; background: var(--bg-secondary); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--accent-secondary); border: 1px solid var(--border-color); flex-shrink: 0; transition: 0.3s; position: relative; overflow: hidden; }
.level-card.active .level-icon-box { background: var(--accent-secondary); color: white; border-color: var(--accent-secondary); box-shadow: 0 0 20px rgba(14, 165, 233, 0.4); }

.level-content { max-height: 0; overflow: hidden; transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(0,0,0,0.1); }
.level-card.active .level-content { max-height: 6000px; }

/* Course Grid */
.courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; padding: 35px; border-top: 1px solid var(--border-color); }
.course-item { background: var(--bg-secondary); padding: 30px 25px; border-radius: var(--radius-md); border: 1px solid var(--border-color); text-align: center; transition: 0.3s; cursor: pointer; position: relative; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; }
.course-item::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--border-color); transition: 0.3s; }
.course-item:hover { transform: translateY(-7px); border-color: rgba(255,255,255,0.1); box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
.course-item:hover::before { background: var(--accent-secondary); }
.course-icon { font-size: 2.8rem; color: var(--accent-secondary); margin-bottom: 20px; display: block; transition: 0.3s; }
.course-item:hover .course-icon { transform: scale(1.1); color: var(--text-primary); text-shadow: 0 0 10px var(--accent-secondary); }

.progress-bar { height: 8px; background: var(--bg-main); margin-top: 20px; border-radius: 4px; overflow: hidden; width: 100%; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-secondary), #3b82f6); width: 0%; transition: width 0.8s ease-out; border-radius: 4px; }

/* LIBRARY (Free Videos) Styles */
.library-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; padding: 10px 0; }
.library-card { background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-color); overflow: hidden; transition: 0.3s; }
.library-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-main); border-color: var(--accent-secondary); }
.library-card.locked { opacity: 0.6; filter: grayscale(1); pointer-events: none; }
.library-thumb { height: 180px; background: #000; position: relative; display: flex; align-items: center; justify-content: center; }
.library-thumb i { font-size: 3rem; color: rgba(255,255,255,0.5); }
.library-info { padding: 20px; }
.lib-badge { font-size: 0.8rem; background: rgba(14, 165, 233, 0.1); color: var(--accent-secondary); padding: 4px 10px; border-radius: 20px; display: inline-block; margin-bottom: 10px; }
.library-card.locked .lib-badge { background: rgba(255,255,255,0.1); color: var(--text-secondary); }

/* Lesson List Styles */
.lesson-row { background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 20px; border-radius: var(--radius-sm); margin-bottom: 15px; transition: 0.3s; }
.lesson-row:hover { border-color: var(--accent-secondary); }
.lesson-row.completed { border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.05); }
.lesson-row.locked { opacity: 0.5; pointer-events: none; border-style: dashed; }

.checkbox-custom { width: 32px; height: 32px; border: 2px solid var(--border-color); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; flex-shrink: 0; background: var(--bg-main); color: transparent; }
.checkbox-custom.checked { background: var(--success-color); border-color: var(--success-color); color: white; transform: scale(1.1); box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
.checkbox-custom.disabled { cursor: not-allowed; opacity: 0.7; border-color: var(--border-color); background: var(--bg-main); }

/* Modals */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); z-index: 6000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
.modal-overlay.open { display: flex; opacity: 1; }
.modal-box { background: var(--bg-secondary); width: 95%; max-width: 900px; max-height: 95vh; overflow-y: auto; border-radius: var(--radius-xl); border: 1px solid var(--border-color); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); position: relative; animation: slideUp 0.4s ease-out; color: var(--text-primary); }
@keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary); position: sticky; top: 0; z-index: 10; }
.modal-body { padding: 30px; }
.modal-close { font-size: 1.6rem; color: var(--text-secondary); cursor: pointer; transition: 0.3s; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
.modal-close:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }

/* Unified Lesson Viewer */
.lesson-viewer-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
@media(min-width: 768px) {
    .lesson-viewer-grid { grid-template-columns: 2fr 1fr; }
}
.video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; background: #000; border-radius: var(--radius-sm); overflow: hidden; margin-bottom: 20px; border: 1px solid var(--border-color); }
.video-wrapper iframe, .video-wrapper video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
.pdf-wrapper { height: 400px; background: #f1f5f9; border-radius: var(--radius-sm); overflow: hidden; border: 1px solid var(--border-color); margin-bottom: 20px; }
.matn-box { background: var(--bg-main); padding: 20px; border-radius: var(--radius-sm); border: 1px solid var(--border-color); max-height: 400px; overflow-y: auto; line-height: 2; font-size: 1.1rem; text-align: justify; }

/* Auth Forms Extended */
.auth-tabs { display: flex; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); }
.auth-tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; color: var(--text-secondary); font-weight: bold; transition: 0.3s; position: relative; }
.auth-tab.active { color: var(--accent-primary); }
.auth-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background: var(--accent-primary); border-radius: 3px 3px 0 0; }
.form-group { margin-bottom: 15px; text-align: right; }
.form-label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500; }
.form-section-title { grid-column: 1 / -1; margin-top: 15px; margin-bottom: 10px; font-size: 1.1rem; color: var(--accent-secondary); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
.form-input { width: 100%; background: var(--bg-main); border: 2px solid var(--border-color); padding: 12px 15px; border-radius: var(--radius-sm); color: var(--text-primary); font-size: 0.95rem; transition: 0.3s; }
.form-input:focus { border-color: var(--accent-secondary); box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); }
.row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

/* --- PROFILE & HIFZ & TREE STYLES --- */
.profile-header-insta { display: flex; align-items: center; gap: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
.profile-avatar-xl { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent-secondary); padding: 3px; box-shadow: 0 0 20px rgba(14, 165, 233, 0.3); }
.profile-avatar-xl img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background: var(--bg-main); }
.profile-stats-row { display: flex; gap: 30px; margin-bottom: 15px; text-align: center; }
.stat-box { display: flex; flex-direction: column; }
.stat-num { font-weight: 800; font-size: 1.2rem; color: var(--text-primary); }
.stat-label { font-size: 0.85rem; color: var(--text-secondary); }

.hifz-container { margin-top: 30px; }
.hifz-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; margin-top: 15px; }
.juz-box { aspect-ratio: 1; border: 1px solid var(--border-color); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; font-weight: bold; background: var(--bg-main); color: var(--text-secondary); flex-direction: column; font-size: 0.9rem; }
.juz-box:hover { transform: translateY(-3px); border-color: var(--accent-secondary); }
.juz-box.started { background: rgba(251, 191, 36, 0.1); border-color: var(--accent-primary); color: var(--accent-primary); }
.juz-box.completed { background: rgba(16, 185, 129, 0.15); border-color: var(--success-color); color: var(--success-color); }
.juz-box i { font-size: 0.8rem; margin-top: 3px; display: none; }
.juz-box.completed i { display: block; }

.task-card { background: var(--bg-main); border: 1px solid var(--border-color); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; transition: 0.3s; cursor: pointer; }
.task-card:hover { border-color: var(--accent-secondary); }

/* Tree Visualization */
.tree-container { text-align: center; padding: 40px 20px; background: linear-gradient(180deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%); border-radius: var(--radius-xl); border: 1px solid var(--border-color); margin-bottom: 25px; position: relative; overflow: hidden; }
.tree-circle { width: 140px; height: 140px; background: var(--bg-secondary); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; border: 4px solid var(--success-color); box-shadow: 0 0 30px rgba(16, 185, 129, 0.2); position: relative; z-index: 2; transition: 0.5s; }
.tree-icon { font-size: 4.5rem; transition: 0.5s; }

/* Soil Effect for Seed */
.tree-circle.seed-stage { border-color: #5d4037; background: #3e2723; box-shadow: none; overflow: hidden; }
.tree-circle.seed-stage::after { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 50%; background: #5d4037; opacity: 0.5; z-index: -1; } /* Soil line */

/* Certificate */
#certificate-view { text-align: center; padding: 40px; border: 15px double var(--accent-primary); background: #fff; color: #000; display: none; margin-top: 20px; position: relative; }
#certificate-view h1 { font-size: 2.5rem; color: var(--accent-primary); margin-bottom: 10px; font-family: 'Noto Naskh Arabic'; }
#certificate-view .cert-subtitle { font-size: 1.2rem; margin: 10px 0; color: #555; }
#certificate-view .cert-name { font-size: 2.2rem; font-weight: bold; border-bottom: 2px solid #000; display: inline-block; padding: 5px 40px; margin: 20px 0; color: #000; }
#certificate-view .cert-level { font-size: 1.8rem; color: var(--accent-secondary); margin: 20px 0; font-weight:bold; }

/* Responsive */
@media (max-width: 768px) {
    .hero h1 { font-size: 2.2rem; }
    .level-header { flex-direction: column; text-align: center; }
    .header-container { padding: 0 15px; }
    .logo-text { display: none; }
    .btn-group { flex-direction: column; width: 100%; }
    .btn-primary, .btn-outline { width: 100%; justify-content: center; }
    .row-2 { grid-template-columns: 1fr; }
    .profile-header-insta { flex-direction: column; text-align: center; }
    .profile-stats-row { justify-content: center; }
    
    /* Better bottom nav spacing */
    .hero { padding-top: 40px; }
}

/* Print Styles */
@media print {
    body * { visibility: hidden; }
    #print-area, #print-area * { visibility: visible; }
    #print-area { position: absolute; left: 0; top: 0; width: 100%; height:100%; display:flex; align-items:center; justify-content:center; }
}
</style>
</head>
<body>

<!-- Loader -->
<div id="loading-screen">
    <div class="spinner"></div>
    <h3 style="font-weight: 800; letter-spacing: 1px;">Ø³Ø¨Ù„ Ø§Ù„Ø³Ù„Ø§Ù…</h3>
    <p style="color: var(--text-secondary); font-size: 0.9rem;">Ø¨Ø§Ø±Ø¯Ú©Û•Øª...</p>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Navbar -->
<header>
    <div class="container header-container">
        <a href="#" class="logo">
            <i class="fas fa-kaaba logo-icon"></i>
            <span class="logo-text">Ø³Ø¨Ù„ Ø§Ù„Ø³Ù„Ø§Ù…</span>
        </a>
        <div class="header-actions">
            <div class="points-display"><i class="fas fa-star"></i> <span id="user-points">0</span></div>
            
            <div class="icon-btn" onclick="toggleTheme()" title="Ú¯Û†Ú•ÛŒÙ†Ø§ Ø¯Û†Ø®ÛŒ (Ø´Û•Ú¤/Ú•Û†Ú˜)">
                <i class="fas fa-adjust"></i>
            </div>
            
            <div class="icon-btn" onclick="openNotifications()">
                <i class="fas fa-bell"></i>
                <div id="notif-dot" class="notification-dot"></div>
            </div>
        </div>
    </div>
</header>

<!-- MAIN CONTENT VIEWS -->
<main class="container">
    
    <!-- 1. HOME VIEW (PATH) -->
    <div id="view-home" class="view-section active">
        <div class="hero">
            <h1>Ú¯Û•Ø´ØªØ§ Ø²Ø§Ù†Ø³ØªÛ Ø´Û•Ø±Ø¹ÛŒ</h1>
            <p>Ù¾Ù„Ø§ØªÙÛ†Ø±Ù…Û•Ú©Ø§ Ú•ÛÚ©Ø®Ø³ØªÛŒ Ùˆ Ù…ÙˆØ¯ÛØ±Ù† Ø¨Û† ÙÛØ±Ø¨ÙˆÙˆÙ†Ø§ Ø¨Ù†Û•Ù…Ø§ÛŒÛÙ† Ø¦ÛŒØ³Ù„Ø§Ù…Û. Ø³ÛŒØ³ØªÛ•Ù…Û•Ú©Û Ø²ÛŒØ±Û•Ú© Ø¨Û† ÙÛØ±Ø¨ÙˆÙˆÙ†ØŒ Ù¾Ù„Ø§Ù† Ø¯Ø§Ù†Ø§Ù†ØŒ Ùˆ Ú†Ø§Ú¤Ø¯ÛØ±ÛŒÛŒØ§ Ù¾ÛØ´Ú©Û•ÙØªÙ†Û.</p>
            <div class="btn-group">
                <button class="btn-primary" onclick="document.getElementById('levels-container').scrollIntoView()">
    â€                Ø¯Û•Ø³ØªÙ¾ÛÚ©Û• <i class="fas fa-arrow-down"></i>
                </button>
                <button class="btn-outline" onclick="openTutorial()">
                    <i class="fas fa-info-circle"></i> Ú†Û•ÙˆØ§ Ø¯Û Ø¨Ú©Ø§Ø± Ø¦ÛŒÙ†ÛŒØŸ
                </button>
            </div>
        </div>
        
        <div id="levels-container" class="timeline-container">
            <!-- Levels injected here -->
        </div>
    </div>

    <!-- 2. LIBRARY VIEW -->
    <div id="view-library" class="view-section">
        <div style="text-align:center; margin: 30px 0;">
            <h2>Ù¾Û•Ø±ØªÙˆÙˆÚ©Ø®Ø§Ù†Ø§ Ú¤ÛŒØ¯ÛŒÛ†ÛŒØ§Ù†</h2>
            <p style="color:var(--text-secondary);">Ø¦Û•Ú¤ Ú¤ÛŒØ¯ÛŒÛ†ÛŒÛ• Ø¯Û Ú¤Û•Ø¨Ù† Ù„Ø¯ÛŒÙ Ù¾ÛØ´Ú©Û•ÙØªÙ†Ø§ ØªÛ• Ø¯ Ø¦Ø§Ø³ØªØ§Ù† Ø¯Ø§.</p>
        </div>
        <div id="library-grid" class="library-grid">
             <!-- Library Items Injected Here -->
        </div>
    </div>

    <!-- 3. PROFILE VIEW -->
    <div id="view-profile" class="view-section">
        <!-- Content injected dynamically: Either Profile Info OR Login Forms -->
    </div>

</main>

<!-- BOTTOM NAVIGATION -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchView('home', this)">
        <i class="fas fa-road"></i>
        <span>Ø³Û•Ø±Û•Ú©ÛŒ</span>
    </div>
    <div class="nav-item" onclick="switchView('library', this)">
        <i class="fas fa-play-circle"></i>
        <span>Ù¾Û•Ø±ØªÙˆÙˆÚ©Ø®Ø§Ù†Û•</span>
    </div>
    <div class="nav-item" onclick="switchView('profile', this)">
        <i class="fas fa-user"></i>
        <span>Ù¾Ø±Û†ÙØ§ÛŒÙ„</span>
    </div>
</nav>


<!-- MODALS -->

<!-- Main Modal (Courses/Tasks/Lessons) -->
<div id="main-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <div style="display:flex; flex-direction:column; gap:5px; flex:1;">
                <h3 id="modal-title" style="font-size: 1.4rem;">Ù†Ø§Ú¤ÙˆÙ†ÛŒØ´Ø§Ù†</h3>
                <div id="modal-timer" style="display:none;"></div>
            </div>
            <i class="fas fa-times modal-close" onclick="closeModal()"></i>
        </div>
        <div id="modal-content" class="modal-body"></div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="edit-profile-modal" class="modal-overlay" style="z-index: 7000;">
    <div class="modal-box">
        <div class="modal-header">
             <h3>Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒÛŒØ§ Ù¾Ø±Û†ÙØ§ÛŒÙ„ÛŒ</h3>
             <i class="fas fa-times modal-close" onclick="document.getElementById('edit-profile-modal').classList.remove('open')"></i>
        </div>
        <div class="modal-body" id="edit-profile-body">
             <!-- Form injected here -->
        </div>
    </div>
</div>

<!-- Unlock Modal -->
<div id="unlock-modal" class="modal-overlay" style="z-index: 8000;">
    <div class="modal-box" style="max-width: 400px; text-align:center; padding:30px;">
        <i class="fas fa-lock" style="font-size:3rem; color:var(--accent-primary); margin-bottom:20px;"></i>
        <h3>Ù‚ÙÙ„Û Ú¤Û•Ú©Û•</h3>
        <p style="color:var(--text-secondary); margin-bottom:20px;">ØªÚ©Ø§ÛŒÛ• Ú©Û†Ø¯Û (Passcode) Ø¯Ø§Ø®Ù„ Ø¨Ú©Û•:</p>
        <input type="text" id="unlock-code-input" class="form-input" style="text-align:center; font-size:1.5rem; letter-spacing:5px;" placeholder="____" maxlength="4">
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn-primary" style="width:100%; justify-content:center;" onclick="submitUnlockCode()">Ú¤Û•Ú©Ø±Ù†</button>
            <button class="btn-outline" style="width:100%; justify-content:center;" onclick="document.getElementById('unlock-modal').classList.remove('open')">Ù¾Ø§Ø´Ú¯Û•Ø²Ø¨ÙˆÙˆÙ†</button>
        </div>
    </div>
</div>

<script>
/* --- 1. DATA STRUCTURE (Full) --- */
const PDF_URL_DEMO = "https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf";

const appData = {
    levels: [
        {
            id: 1,
            title: "Ø¦Ø§Ø³ØªÛ Ø¦ÛÚ©Û: Ø¨Ù†Ø§ØºÛ•",
            description: "Ø²Ø§Ù†Ø³ØªÛÙ† Ø³Û•Ø±Û•ØªØ§ÛŒÛŒ ÛŒÛÙ† Ù¾ÛØªÚ¤ÛŒ Ø¨Û† Ù‡Û•Ø± Ù…ÙˆØ³Ù„Ù…Ø§Ù†Û•Ú©Û",
            icon: "fa-seedling",
            courses: [
                { 
                    id: "aqidah_1", title: "Ø¹Û•Ù‚ÛŒØ¯Û•", subtitle: "Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ù„Ø§Ø«Ø©", icon: "fa-cubes", type: "standard", 
                    duration: "Ù¤ Ú©Ø§ØªÚ˜Ù…ÛØ±", lessonCount: 3, pdf: PDF_URL_DEMO,
                    lessons: [
                        { id: "aq1_1", title: "Ù¡. Ú¯Ø±Ù†Ú¯ÛŒØ§ Ø¹Û•Ù‚ÛŒØ¯Û", text: "Ø¦Û•Ùˆ Ø²Ø§Ù†Ø³ØªÛ• ÛŒÛ• ÛŒÛ Ø¨Û•Ø­Ø³Û Ø¨Ø§ÙˆÛ•Ø±ÛŒÛ Ø¯Ú©Û•Øª Ø¨ Ø®ÙˆØ¯Û Ùˆ Ù¾ÛØºÛ•Ù…Ø¨Û•Ø±Ø§Ù†.", video: "", points: 10 },
                        { id: "aq1_2", title: "Ù¢. Ø¨Ù†Û•Ù…Ø§ÛŒÛ Ø¦ÛÚ©Û: Ù†Ø§Ø³ÛŒÙ†Ø§ Ø®ÙˆØ¯Û", text: "ÙÙØ¥ÙØ°ÙØ§ Ù‚ÙÙŠÙ„Ù Ù„ÙÙƒÙ: Ù…ÙÙ†Ù’ Ø±ÙØ¨ÙÙ‘ÙƒÙØŸ ÙÙÙ‚ÙÙ„Ù’: Ø±ÙØ¨ÙÙ‘ÙŠÙ Ø§Ù„Ù„ÙÙ‘Ù‡Ù...", video: "", points: 10 },
                        { id: "aq1_3", title: "Ù£. Ø¨Ù†Û•Ù…Ø§ÛŒÛ Ø¯ÙˆÙˆÛ: Ù†Ø§Ø³ÛŒÙ†Ø§ Ø¦ÛŒØ³Ù„Ø§Ù…Û", text: "Ø§Ù„Ù’Ù…ÙØ±Ù’ØªÙØ¨ÙØ©Ù Ø§Ù„Ø«ÙÙ‘Ø§Ù†ÙÙŠÙØ©Ù: Ù…ÙØ¹Ù’Ø±ÙÙÙØ©Ù Ø¯ÙÙŠÙ†Ù Ø§Ù„Ù’Ø¥ÙØ³Ù’Ù„ÙØ§Ù…Ù Ø¨ÙØ§Ù„Ù’Ø£ÙØ¯ÙÙ„ÙÙ‘Ø©Ù...", video: "", points: 10 }
                    ] 
                },
                { 
                    id: "seerah_1", title: "Ø³ÛŒØ±Û•Øª", subtitle: "Ù¾ÙˆØ®ØªÛ•ÛŒØ§ Ú˜ÛŒØ§Ù†Ø§ Ù¾ÛØºÛ•Ù…Ø¨Û•Ø±ÛŒ ï·º", icon: "fa-moon", type: "seerah",
                    duration: "Ù£ Ú©Ø§ØªÚ˜Ù…ÛØ±", lessonCount: 2, pdf: PDF_URL_DEMO,
                    lessons: [
                        { id: "sr_1", title: "Ù¡. Ú•Û•Ú†Û•ÚµÛ•Ú© Ùˆ Ú˜ Ø¯Ø§ÛŒÚ©Ø¨ÙˆÙˆÙ†", text: "Ú˜ Ø¯Ø§ÛŒÚ© Ø¨ÙˆÙˆÛŒÛ• Ù„ Ø³Ø§ÚµØ§ ÙÛŒÙ„ÛØŒ Ú•Û†Ú˜Ø§ Ø¯ÙˆÙˆØ´Û•Ù…Ø¨Û...", video: "", points: 15 },
                        { id: "sr_2", title: "Ù¢. Ú˜ÛŒØ§Ù†Ø§ Ø²Ø§Ø±Û†Ú©ÛŒÙ†ÛŒ", text: "Ù„ Ø¯Û•Ù Ø­Û•Ù„ÛŒÙ…Ø§ Ø³Û•Ø¹Ø¯ÛŒÛ• Ù…Û•Ø²Ù† Ø¨ÙˆÙˆ...", video: "", points: 15 }
                    ] 
                },
                {
                    id: "hifz_l1", title: "Ø­ÙØ¸ (Ø¬Ø²Ø¡ Ù£Ù  Ùˆ Ù¢Ù©)", subtitle: "Ù‚ÙˆØ±Ø¦Ø§Ù†Ø§ Ù¾ÛŒØ±Û†Ø²", icon: "fa-quran", type: "hifz",
                    duration: "Ø¨Û•Ø±Ø¯Û•ÙˆØ§Ù…", lessonCount: 2, pdf: PDF_URL_DEMO,
                    lessons: [
                        { id: "juz30", title: "Ø¬Ø²Ø¡ Ù£Ù  (Ø¹Ù…)", text: "Ù¾ÛØ¯Ú¤ÛŒÛ• Ú¤ÛŒ Ø¬Ø²Ø¦ÛŒ Ø¨ ØªÛ•Ù…Ø§Ù…ÛŒ Ú˜Ø¨Û•Ø± Ø¨Ú©Û•ÛŒ.", video: "", points: 50, juzNum: 30 },
                        { id: "juz29", title: "Ø¬Ø²Ø¡ Ù¢Ù© (ØªØ¨Ø§Ø±Ùƒ)", text: "Ù¾ÛØ¯Ú¤ÛŒÛ• Ú¤ÛŒ Ø¬Ø²Ø¦ÛŒ Ø¨ ØªÛ•Ù…Ø§Ù…ÛŒ Ú˜Ø¨Û•Ø± Ø¨Ú©Û•ÛŒ.", video: "", points: 50, juzNum: 29 }
                    ]
                }
            ]
        },
        {
            id: 2,
            title: "Ø¦Ø§Ø³ØªÛ Ø¯ÙˆÙˆÛ: Ù¾ÛØ´Ú©Û•ÙØªÛŒ",
            description: "Ù‚ÙˆÙˆÙ„Ø¨ÙˆÙˆÙ† Ø¯ Ø²Ø§Ù†Ø³ØªÛÙ† Ø´Û•Ø±Ø¹ÛŒ Ø¯Ø§ (Ù¾ÛØ¯Ú¤ÛŒ Ø¨ Ú©Û†Ø¯Û ÛŒÛ•)",
            icon: "fa-layer-group",
            courses: [
                 { 
                    id: "aqidah_2", title: "Ø¹Û•Ù‚ÛŒØ¯Û• Ù¢", subtitle: "Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©", icon: "fa-book-quran", type: "standard", 
                    duration: "Ù¦ Ú©Ø§ØªÚ˜Ù…ÛØ±", lessonCount: 2, pdf: PDF_URL_DEMO,
                    lessons: [
                        { id: "aq2_1", title: "Ù¡. Ù‚Ø§Ø¹ÛŒØ¯Û•ÛŒØ§ Ø¦ÛÚ©Û", text: "Ú©Ø§ÙØ±ÛÙ† Ù‚ÙˆØ±Û•ÛŒØ´ Ø¯Ø§Ù† Ø¨ ØªÛ•ÙˆØ­ÛŒØ¯Ø§ Ø±ÙˆØ¨ÙˆØ¨ÛŒÛ•ØªÛ Ø¯Ø¯Ù†Ø§Ù†...", video: "", points: 15 },
                        { id: "aq2_2", title: "Ù¢. Ù‚Ø§Ø¹ÛŒØ¯Û•ÛŒØ§ Ø¯ÙˆÙˆÛ", text: "Ø¦Û•ÙˆØ§Ù† Ø¯Ú¯Û†Øª Ø¦Û•Ù… Ù¾Û•Ø±Ø³ØªÙ†Û Ø¯Ú©Û•ÛŒÙ† Ø¯Ø§ Ø¨Ø¨Ù†Û• ÙˆØ§Ø³ØªÛ•...", video: "", points: 15 }
                    ]
                },
                {
                    id: "hifz_l2", title: "Ø­ÙØ¸ (Ø¬Ø²Ø¡ Ù¢Ù¨ Ùˆ Ù¢Ù§)", subtitle: "Ù‚ÙˆØ±Ø¦Ø§Ù†Ø§ Ù¾ÛŒØ±Û†Ø²", icon: "fa-quran", type: "hifz",
                    duration: "Ø¨Û•Ø±Ø¯Û•ÙˆØ§Ù…", lessonCount: 2, pdf: PDF_URL_DEMO,
                    lessons: [
                        { id: "juz28", title: "Ø¬Ø²Ø¡ Ù¢Ù¨ (Ù‚Ø¯ Ø³Ù…Ø¹)", text: "ØªÚ©Ø§ÛŒÛ• Ø¯Û•Ø³ØªÙ¾ÛÚ©Û• Ø¨ Ú˜Ø¨Û•Ø±Ú©Ø±Ù†Ø§ Ø¬Ø²Ø¦Û Ù¢Ù¨.", video: "", points: 50, juzNum: 28 },
                        { id: "juz27", title: "Ø¬Ø²Ø¡ Ù¢Ù§ (Ù‚Ø§Ù„ ÙÙ…Ø§ Ø®Ø·Ø¨ÙƒÙ…)", text: "ØªÚ©Ø§ÛŒÛ• Ø¯Û•Ø³ØªÙ¾ÛÚ©Û• Ø¨ Ú˜Ø¨Û•Ø±Ú©Ø±Ù†Ø§ Ø¬Ø²Ø¦Û Ù¢Ù§.", video: "", points: 50, juzNum: 27 }
                    ]
                }
            ]
        },
        {
            id: 3,
            title: "Ø¦Ø§Ø³ØªÛ Ø³ÛÛŒÛ: ØªØ§ÛŒØ¨Û•ØªÙ…Û•Ù†Ø¯",
            description: "Ø²Ø§Ù†Ø³ØªÛÙ† ÙˆØ±Ø¯ (Ù¾ÛØ¯Ú¤ÛŒÛ• Ø¦Ø§Ø³ØªÛ Ù¢ ØªÙ…Ø§Ù… Ø¨Ú©Û•ÛŒ)",
            icon: "fa-graduation-cap",
            courses: [
                 { 
                    id: "hadith_1", title: "ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•", subtitle: "Ø§Ù„Ø£Ø±Ø¨Ø¹ÙˆÙ† Ø§Ù„Ù†ÙˆÙˆÙŠØ©", icon: "fa-scroll", type: "standard", 
                    duration: "Ù¡Ù  Ú©Ø§ØªÚ˜Ù…ÛØ±", lessonCount: 1, pdf: PDF_URL_DEMO,
                    lessons: [
                        { id: "hd_1", title: "Ù¡. Ø¥Ù†Ù…Ø§ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø§Ù„Ù†ÙŠØ§Øª", text: "ÙˆØ§ØªÛ• Ù‡Û•Ù…ÙˆÙˆ Ú©Ø§Ø±Û•Ú© Ø¨ Ù†ÛŒØªÛ ÛŒÛ•...", video: "", points: 20 }
                    ]
                }
            ]
        }
    ],
    library: [
        { title: "Ú¯Ø±Ù†Ú¯ÛŒØ§ Ø²Ø§Ù†Ø³ØªÛ Ø´Û•Ø±Ø¹ÛŒ", instructor: "Ù…. Ù…Ø­Ù…Ø¯", duration: "15 Ø®ÙˆÙ„Û•Ú©", type: "video", unlockLevel: 0, icon: "fa-play-circle" },
        { title: "Ú†Û•ÙˆØ§ Ø¯Û•Ø³ØªÙ¾ÛØ¨Ú©Û•ÛŒÙ†ØŸ", instructor: "Ù…. Ø§Ø­Ù…Ø¯", duration: "20 Ø®ÙˆÙ„Û•Ú©", type: "video", unlockLevel: 0, icon: "fa-question-circle" },
        { title: "Ø´Ú•Û†Ú¤Û•Ú©Ø±Ù†Ø§ Ù†ÙˆÛŒÚ˜Û (Ø¨Û•Ø´Û Ù¡)", instructor: "Ù…. Ú©Ø§Ø±ÙˆØ§Ù†", duration: "45 Ø®ÙˆÙ„Û•Ú©", type: "series", unlockLevel: 1, icon: "fa-pray" },
        { title: "Ø²Ù†Ø¬ÛŒØ±Û•ÛŒØ§ Ø¦Ø§Ø¯Ø§Ø¨ÛÙ† Ø¦ÛŒØ³Ù„Ø§Ù…ÛŒ", instructor: "Ø¯. Ø¹Û•Ù„ÛŒ", duration: "5 Ø²Ù†Ø¬ÛŒØ±Û•", type: "series", unlockLevel: 1, icon: "fa-list-ul" },
        { title: "ØªÛ•ÙØ³ÛŒØ± (Ø³ÙˆØ±Û•ØªØ§ ÙØ§ØªÛŒØ­Û•)", instructor: "Ù…. Ú©Ø§Ù…Û•Ø±Ø§Ù†", duration: "1 Ú©Ø§ØªÚ˜Ù…ÛØ±", type: "video", unlockLevel: 1, icon: "fa-quran" },
        { title: "Ø´Ú•Û†Ú¤Û•Ú©Ø±Ù†Ø§ Ù¾Û•Ø±ØªÙˆÙˆÚ©Ø§ ØªÛ•ÙˆØ­ÛŒØ¯Û", instructor: "Ù…. Ø¦Ø§Ø²Ø§Ø¯", duration: "10 Ø²Ù†Ø¬ÛŒØ±Û•", type: "series", unlockLevel: 2, icon: "fa-book" },
        { title: "Ø¨Ù†Û•Ù…Ø§ÛŒÛÙ† ÙÛŒÙ‚Ù‡ÛŒ (Ù¾ÛØ´Ú©Û•ÙØªÛŒ)", instructor: "Ø¯. Ø³Ø§Ù…Ø§Ù†", duration: "2 Ú©Ø§ØªÚ˜Ù…ÛØ±", type: "video", unlockLevel: 2, icon: "fa-balance-scale" },
        { title: "Ù…ÛÚ˜ÙˆÙˆÛŒØ§ Ø¦ÛŒØ³Ù„Ø§Ù…Û", instructor: "Ù…. Ø±ÛØ¨ÙˆØ§Ø±", duration: "3 Ú©Ø§ØªÚ˜Ù…ÛØ±", type: "video", unlockLevel: 3, icon: "fa-history" }
    ]
};

/* --- 2. STATE MANAGEMENT --- */
const State = {
    usersDB: JSON.parse(localStorage.getItem('sabilUsersDB_v12')) || [],
    currentUser: null, 
    pendingUnlockId: null
};

// Start Up
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => document.getElementById('loading-screen').classList.add('fade-out'), 1200);
    
    const savedTheme = localStorage.getItem('sabilTheme');
    if(savedTheme === 'light') document.body.setAttribute('data-theme', 'light');

    const lastUserContact = localStorage.getItem('sabilLastUser_v12');
    if (lastUserContact) {
        const user = State.usersDB.find(u => u.contact === lastUserContact);
        if (user) {
            State.currentUser = user;
            initApp();
            return;
        }
    }
    // Initial Render
    renderLevels();
});

function initApp() {
    checkStreak();
    renderLevels();
    updatePointsUI();
    checkNotifications(); 
    setTimeout(checkStartupAlerts, 2000); 
}

/* --- VIEW SWITCHING LOGIC (NEW) --- */
function switchView(viewName, navItem) {
    // 1. Hide all views
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    // 2. Show selected view
    document.getElementById(`view-${viewName}`).classList.add('active');
    
    // 3. Update Nav Icons
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    if(navItem) navItem.classList.add('active');

    // 4. Trigger specific view logic
    if(viewName === 'home') renderLevels();
    if(viewName === 'library') renderLibrary();
    if(viewName === 'profile') renderProfileView(); // New function for full view
}

function checkStartupAlerts() {
    if (!State.currentUser) return;
    let alerts = [];
    
    const tasks = State.currentUser.dailyTasks.tasks;
    const tasksDone = Object.values(tasks).filter(Boolean).length;
    if(tasksDone === 0) {
        alerts.push("âš ï¸ ØªÛ• Ù‡ÛØ´ØªØ§ Ú† ØªØ§Ø³Ú©ÛÙ† Ú•Û†Ú˜Ø§Ù†Û• Ø¦Û•Ù†Ø¬Ø§Ù… Ù†Û•Ø¯Ø§ÛŒÙ†Û•!");
    }
    
    const hasHifzStarted = Object.keys(State.currentUser.progress).some(k => k.includes('juz'));
    if(hasHifzStarted) {
        alerts.push("ğŸ“– Ø¨ÛŒØ±Ø¦ÛŒÙ†Ø§Ù†: Ø¦Û•Ú¤Ú•Û† Ù¢ Ù„Ø§Ù¾Û•Ø±ÛÙ† Ù‚ÙˆØ±Ø¦Ø§Ù†Û Ú˜Ø¨Û•Ø± Ø¨Ú©Û•.");
    }

    const now = Date.now();
    let isLate = false;
    for (const [courseId, plan] of Object.entries(State.currentUser.plans)) {
        let course = null;
        appData.levels.forEach(l => { const c = l.courses.find(x => x.id === courseId); if(c) course = c; });
        if(course) {
             const diffDays = (now - plan.startDate) / (1000 * 60 * 60 * 24);
             const completed = course.lessons.filter(l => State.currentUser.progress[l.id]).length;
             const total = course.lessons.length;
             const expectedRatio = diffDays / plan.days; 
             const expectedLessons = Math.floor(expectedRatio * total);
             
             if (completed < expectedLessons && diffDays < plan.days) {
                 isLate = true;
             }
        }
    }
    if(isLate) {
        alerts.push("â³ ØªÛ† ÛŒÛ Ù¾Ø§Ø´Ú©Û•ÙØªÛŒ Ù„ Ù‡Û•Ù†Ø¯Û•Ú© Ú˜ ÙˆØ§Ù†ÛÙ† Ø®Û†ØŒ ØªÚ©Ø§ÛŒÛ• ØªÛ•Ù…Ø§Ø´Û•Ú©Û•!");
    }

    if(alerts.length > 0) {
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        document.getElementById('modal-timer').style.display = 'none';
        modalTitle.innerText = "Ø¦Ø§Ú¯Û•Ù‡Ø¯Ø§Ø±ÛŒØ§ Ú•Û†Ú˜Ø§Ù†Û•";
        modalContent.innerHTML = `
            <div style="text-align:center; padding:10px;">
                ${alerts.map(a => `<p style="margin-bottom:15px; font-size:1.1rem; color:var(--text-primary); background:var(--bg-secondary); padding:15px; border-radius:10px; border:1px solid var(--border-color);">${a}</p>`).join('')}
                <button class="btn-primary" onclick="closeModal()">Ø¨Ø§Ø´Û•ØŒ Ú¯Û•Ù‡Û•Ø´ØªÙ…</button>
            </div>
        `;
        document.getElementById('main-modal').classList.add('open');
    }
}

function saveState() {
    if(!State.currentUser) return;
    const idx = State.usersDB.findIndex(u => u.contact === State.currentUser.contact);
    if (idx !== -1) {
        State.usersDB[idx] = State.currentUser;
    } else {
        State.usersDB.push(State.currentUser);
    }
    
    localStorage.setItem('sabilUsersDB_v12', JSON.stringify(State.usersDB));
    localStorage.setItem('sabilLastUser_v12', State.currentUser.contact);
    updatePointsUI();
}

function updatePointsUI() {
    if (State.currentUser) {
        document.getElementById('user-points').innerText = State.currentUser.points;
    } else {
        document.getElementById('user-points').innerText = "0";
    }
}

function toggleTheme() {
    const current = document.body.getAttribute('data-theme');
    const newTheme = current === 'light' ? 'dark' : 'light';
    
    if(newTheme === 'light') document.body.setAttribute('data-theme', 'light');
    else document.body.removeAttribute('data-theme');
    
    localStorage.setItem('sabilTheme', newTheme);
}

/* --- 3. TOAST & ALERTS --- */
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'fa-info-circle';
    if(type === 'warning') icon = 'fa-exclamation-triangle';
    if(type === 'danger') icon = 'fa-times-circle';
    if(type === 'success') icon = 'fa-check-circle';

    toast.innerHTML = `<i class="fas ${icon} toast-icon"></i> <span>${message}</span>`;
    container.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('show'));
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
    }, 4000);
}

function checkNotifications() {
    if (!State.currentUser) return;
    let hasAlert = false;
    const tasks = State.currentUser.dailyTasks.tasks;
    const completedTasks = Object.values(tasks).filter(Boolean).length;
    if (completedTasks === 0) hasAlert = true;

    const dot = document.getElementById('notif-dot');
    if(hasAlert) dot.classList.add('active');
    else dot.classList.remove('active');
}

/* --- 4. STREAK LOGIC --- */
function checkStreak() {
    if(!State.currentUser) return;
    const today = new Date().toDateString();
    const lastLogin = State.currentUser.lastLoginDate;
    
    if (lastLogin !== today) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        if (lastLogin === yesterday.toDateString()) {
            State.currentUser.streak = (State.currentUser.streak || 0) + 1;
        } else {
            State.currentUser.streak = 1;
        }
        State.currentUser.lastLoginDate = today;
        State.currentUser.dailyTasks = {
            date: today,
            tasks: { prayer: false, quran: false, dhikr: false, reading: false }
        };
        saveState();
    }
}

/* --- 5. LOGIC: MAIN TABS & LEVELS --- */
function isLevelUnlocked(levelIndex) {
    if (levelIndex === 0) return true; 
    const prevLevel = appData.levels[levelIndex - 1];
    if (!State.currentUser) return false;

    let prevCompleted = true;
    for (let course of prevLevel.courses) {
        for (let lesson of course.lessons) {
            if (!State.currentUser.progress[lesson.id]) {
                prevCompleted = false;
                break;
            }
        }
    }
    if (!prevCompleted) return false; 
    if (appData.levels[levelIndex].id === 2) {
        return State.currentUser.unlockedLevels.includes(2);
    }
    return true; 
}

function checkLevelCompletion(level) {
    if(!State.currentUser) return false;
    let allDone = true;
    level.courses.forEach(c => {
        c.lessons.forEach(l => {
            if(!State.currentUser.progress[l.id]) allDone = false;
        });
    });
    return allDone;
}

function renderLevels() {
    const container = document.getElementById('levels-container');
    container.innerHTML = '';
    
    appData.levels.forEach((level, index) => {
        const unlocked = isLevelUnlocked(index);
        const levelComplete = checkLevelCompletion(level);
        
        const html = `
            <div class="level-card ${!unlocked ? 'locked' : ''}" id="level-${level.id}">
                <div class="level-header" onclick="toggleLevel(${level.id}, ${index}, ${unlocked})">
                    <div class="level-icon-box"><i class="fas ${level.icon}"></i></div>
                    <div class="level-info" style="flex:1;">
                        <h2 style="margin-bottom:5px;">${level.title}</h2>
                        <p style="color:var(--text-secondary);">${level.description}</p>
                    </div>
                    ${levelComplete ? 
                        `<button class="btn-primary" style="padding:8px 15px; font-size:0.9rem;" onclick="event.stopPropagation(); generateLevelCertificate('${level.title}')"><i class="fas fa-certificate"></i> Ø¨Ú•ÙˆØ§Ù†Ø§Ù…Û•</button>` 
                        : (!unlocked ? '<i class="fas fa-lock" style="font-size:1.5rem; opacity:0.5;"></i>' : '<i class="fas fa-chevron-down" style="font-size:1.2rem; transition:0.3s;"></i>')
                    }
                </div>
                <div class="level-content">
                    <div class="courses-grid">
                        ${level.courses.map(course => {
                            let completedCount = 0;
                            let progressPercent = 0;
                            let plan = null;
                            
                            if (State.currentUser) {
                                completedCount = course.lessons.filter(l => State.currentUser.progress[l.id]).length;
                                progressPercent = Math.round((completedCount / course.lessons.length) * 100);
                                plan = State.currentUser.plans[course.id];
                            }
                            
                            return `
                                <div class="course-item" onclick="openCourse('${course.id}')">
                                    <div>
                                        <i class="fas ${course.icon} course-icon"></i>
                                        <h4 class="course-title">${course.title}</h4>
                                        <div class="course-subtitle">${course.subtitle}</div>
                                    </div>
                                    <div style="width:100%;">
                                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:var(--text-secondary); margin-bottom:5px;">
                                            <span>Ù¾Ù„Ø§Ù†: <b style="color:${plan ? 'var(--accent-primary)' : 'inherit'}">${plan ? plan.days + ' Ú•Û†Ú˜' : 'Ù†Û•Ù‡Ø§ØªÛŒÛ• Ø¯Ø§Ù†Ø§Ù†'}</b></span>
                                            <span>%${progressPercent}</span>
                                        </div>
                                        <div class="progress-bar"><div class="progress-fill" style="width:${progressPercent}%"></div></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += html;
    });
}

function toggleLevel(id, index, isUnlocked) {
    if (!isUnlocked) {
        if (!State.currentUser) { 
            showToast("Ù¾ÛØ¯Ú¤ÛŒÛ• Ø¯Û•Ø³Ù¾ÛÚ©Û ØªÛ†Ù…Ø§Ø±Ø¨Ú©Û•ÛŒ ÛŒØ§Ù† Ø¨Ú†ÛŒÛ• Ú˜ÙˆÙˆØ±.", "warning");
            // Switch to profile view for login
            switchView('profile', document.querySelectorAll('.nav-item')[2]);
            return; 
        }
        
        if(index > 0) {
            const prevLevel = appData.levels[index - 1];
            if(!checkLevelCompletion(prevLevel)) {
                showToast("Ù¾ÛØ¯Ú¤ÛŒÛ• Ø¦Ø§Ø³ØªÛ Ø¨Û•Ø±Û Ø¨ ØªÛ•Ù…Ø§Ù…ÛŒ (Ù¡Ù Ù Ùª) Ø®Ù„Ø§Ø³ Ø¨Ú©Û•ÛŒ!", "danger");
                return;
            }
        }

        if (id === 2 && !State.currentUser.unlockedLevels.includes(2)) {
            State.pendingUnlockId = id;
            document.getElementById('unlock-code-input').value = '';
            document.getElementById('unlock-modal').classList.add('open');
            document.getElementById('unlock-code-input').focus();
        }
        return;
    }

    const card = document.getElementById(`level-${id}`);
    card.classList.toggle('active');
    const icon = card.querySelector('.fa-chevron-down');
    if(icon) icon.style.transform = card.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0)';
}

function submitUnlockCode() {
    const code = document.getElementById('unlock-code-input').value;
    if (code === "2024") {
        State.currentUser.unlockedLevels.push(State.pendingUnlockId);
        saveState();
        renderLevels();
        document.getElementById('unlock-modal').classList.remove('open');
        showToast("Ù¾ÛŒØ±Û†Ø²Û•! Ø¦Ø§Ø³Øª Ú¤Û•Ø¨ÙˆÙˆ.", "success");
    } else {
        showToast("Ú©Û†Ø¯ Ø®Û•Ù„Û•ØªÛ•!", "danger");
    }
}

/* --- 6. LOGIC: COURSES & PLANS --- */
function openCourse(courseId) {
    if(!State.currentUser) {
        switchView('profile', document.querySelectorAll('.nav-item')[2]);
        return;
    }

    let course = null;
    let levelIndex = -1;
    appData.levels.forEach((l, idx) => {
        const c = l.courses.find(x => x.id === courseId);
        if(c) { course = c; levelIndex = idx; }
    });

    if (!isLevelUnlocked(levelIndex)) {
        showToast("Ø¦Û•Ú¤ Ø¦Ø§Ø³ØªÛ• Ù‡ÛØ´ØªØ§ Ù‚ÙÙ„Û•!", "warning");
        return;
    }

    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    modalTitle.innerText = course.title;
    
    const hasPlan = !!State.currentUser.plans[courseId];
    if(hasPlan) {
        renderTimer(courseId);
    } else {
        document.getElementById('modal-timer').style.display = 'none';
    }

    modalContent.innerHTML = renderLessonList(course, hasPlan);
    document.getElementById('main-modal').classList.add('open');
}

function renderPlanSelectionId(courseId) {
    let course = null;
    appData.levels.forEach(l => {
        let c = l.courses.find(x => x.id === courseId);
        if(c) course = c;
    });
    const modalContent = document.getElementById('modal-content');
    modalContent.innerHTML = `
        <div style="text-align:center; padding:20px 10px;">
            <h3 style="margin-bottom:10px;">Ø¯Ø§Ù†Ø§Ù†Ø§ Ù¾Ù„Ø§Ù†Û (Ø¦ÛŒØ¬Ø¨Ø§Ø±ÛŒ)</h3>
            <p style="margin-bottom:20px; color:var(--text-secondary);">Ù‡Û•Ú˜Ù…Ø§Ø±Ø§ ÙˆØ§Ù†Û•ÛŒØ§Ù†: ${course.lessons.length}</p>
            <div style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap;">
                ${[1, 3, 7, 10].map(d => `
                    <div onclick="selectPlan('${course.id}', ${d})" 
                         style="background:var(--bg-main); border:2px solid var(--border-color); padding:20px; width:100px; border-radius:15px; cursor:pointer;">
                        <span style="font-size:2rem; font-weight:800; display:block; color:var(--accent-secondary);">${d}</span>
                        <span style="font-size:0.9rem; color:var(--text-secondary);">Ú•Û†Ú˜</span>
                    </div>
                `).join('')}
            </div>
            <button class="btn-outline" onclick="openCourse('${course.id}')" style="margin-top:20px;">Ù¾Ø§Ø´Ú¯Û•Ø²Ø¨ÙˆÙˆÙ†</button>
        </div>
    `;
}

function selectPlan(courseId, days) {
    if(!confirm(`ØªÛ• Ù¾Ù„Ø§Ù†Û ${days} Ú•Û†Ú˜ÛŒ Ù‡Û•ÚµØ¨Ú˜Ø§Ø±Ø¯. Ø¦Û•Ø±Û ØªÛ† Ù¾Ø´ØªÚ•Ø§Ø³ØªÛŒØŸ`)) return;
    State.currentUser.plans[courseId] = { days: days, startDate: Date.now() };
    saveState();
    openCourse(courseId);
    renderLevels();
    showToast("Ù¾Ù„Ø§Ù† Ø¨ Ø³Û•Ø±Ú©Û•ÙØªÛŒØ§Ù†Û• Ù‡Ø§ØªÛ• Ø¯Ø§Ù†Ø§Ù†", "success");
}

function changePlan(courseId) {
    const plan = State.currentUser.plans[courseId];
    const msPerDay = 24 * 60 * 60 * 1000;
    const timeDiff = Date.now() - plan.startDate;
    if (timeDiff > msPerDay) {
        showToast("Ø¨ÙˆØ±Ù†ØŒ Ø¯Û•Ù…Û Ú¯Û†Ú•ÛŒÙ†Ø§ Ù¾Ù„Ø§Ù†Û Ø¨ Ø³Û•Ø±Ú¤Û•Ú†ÙˆÙˆ (ØªÛ•Ù†Û Ù¢Ù¤ Ø¯Û•Ù…Ú˜Ù…ÛØ±ÛÙ† Ø¯Û•Ø³Ù¾ÛÚ©Û).", "danger");
        return;
    }
    if(confirm("Ø¦Û•Ø±Û ØªÛ† Ù¾Ø´ØªÚ•Ø§Ø³ØªÛŒ Ø¯ØªÛ•Ú¤ÛØª Ù¾Ù„Ø§Ù†Û Ø¨Ú¯Û†Ú•ÛŒØŸ")) renderPlanSelectionId(courseId);
}

function renderTimer(courseId) {
    const plan = State.currentUser.plans[courseId];
    if(!plan) return;
    const diffDays = (Date.now() - plan.startDate) / (1000 * 60 * 60 * 24); 
    const remainingDays = Math.ceil(plan.days - diffDays);
    const modalTimer = document.getElementById('modal-timer');
    let timerHTML = '';
    if (remainingDays > 0) timerHTML = `<span style="font-size:0.9rem; color:var(--text-secondary);"><i class="fas fa-clock"></i> Ù…Ø§ÙˆÛ•: <b style="color:var(--accent-primary)">${remainingDays} Ú•Û†Ú˜</b></span>`;
    else timerHTML = `<span style="font-size:0.9rem; color:var(--danger-color); font-weight:bold;"><i class="fas fa-exclamation-triangle"></i> Ø¯Û•Ù… Ø¨ Ø³Û•Ø±Ú¤Û•Ú†ÙˆÙˆ</span>`;
    modalTimer.innerHTML = timerHTML;
    modalTimer.style.display = 'block';
}

function renderLessonList(course, hasPlan) {
    const isSeerah = course.type === 'seerah';
    const isHifz = course.type === 'hifz';
    let completedCount = 0;
    if(State.currentUser) {
        course.lessons.forEach(l => { if(State.currentUser.progress[l.id]) completedCount++; });
    }
    const isCourseCompleted = completedCount === course.lessons.length;
    let changeAllowed = false;
    if (hasPlan) {
        const msPerDay = 24 * 60 * 60 * 1000;
        if (Date.now() - State.currentUser.plans[course.id].startDate < msPerDay) changeAllowed = true;
    }

    return `
    <div style="animation: fadeIn 0.5s;">
        ${!hasPlan ? `
            <div style="background:rgba(251, 191, 36, 0.1); border:1px solid var(--accent-primary); padding:15px; border-radius:10px; margin-bottom:20px; text-align:center;">
                <p style="margin-bottom:10px; color:var(--accent-primary);">Ù‡ÛØ´ØªØ§ ØªÛ• Ù¾Ù„Ø§Ù† Ø¯Ø§Ù†Û•Ù†Ø§ØªÛŒÛ•.</p>
                <button class="btn-primary" onclick="renderPlanSelectionId('${course.id}')" style="font-size:0.9rem; padding:8px 20px;">
                    <i class="fas fa-calendar-alt"></i> Ø¯Ø§Ù†Ø§Ù†Ø§ Ù¾Ù„Ø§Ù†Û
                </button>
            </div>
        ` : `
            <div style="text-align:left; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:0.85rem; color:var(--text-secondary); background:var(--bg-main); padding:5px 10px; border-radius:5px; border:1px solid var(--border-color);">
                     ${changeAllowed ? '<i class="fas fa-check-circle" style="color:var(--success-color)"></i> Ú¯Û†Ú•ÛŒÙ† ÛŒØ§ Ø¨Û•Ø±Ø¯Û•Ø³ØªÛ•' : '<i class="fas fa-lock" style="color:var(--danger-color)"></i> Ú¯Û†Ú•ÛŒÙ† Ù‡Ø§ØªÛŒÛ• Ú¯Ø±ØªÙ†'}
                </span>
                <button onclick="changePlan('${course.id}')" style="background:transparent; border:none; color:${changeAllowed ? 'var(--text-primary)' : 'var(--text-secondary)'}; cursor:${changeAllowed ? 'pointer' : 'not-allowed'}; font-size:0.85rem; opacity:${changeAllowed ? 1 : 0.5}">
                    <i class="fas fa-edit"></i> Ú¯Û†Ú•ÛŒÙ†
                </button>
            </div>
        `}

        ${isCourseCompleted && hasPlan ? `
            <div style="background:linear-gradient(90deg, #10b981, #059669); padding:15px; border-radius:10px; color:white; margin-bottom:20px; text-align:center;">
                <i class="fas fa-check-circle" style="font-size:1.5rem;"></i>
                <h4 style="margin-top:5px;">Ù†Ø§ÛŒØ§Ø¨Û•! ØªÛ• Ø¦Û•Ú¤ Ú©Û†Ø±Ø³Û• ØªÛ•ÙˆØ§Ùˆ Ú©Ø±.</h4>
            </div>
        ` : ''}

        <div style="display:flex; flex-direction:column; gap:12px;">
        ${course.lessons.map((lesson, idx) => {
            const isCompleted = State.currentUser && State.currentUser.progress[lesson.id];
            
            let isLocked = false;
            // Lock logic: Sequential for normal, but maybe loose for Hifz? Let's keep sequential for structure.
            if(hasPlan && idx > 0) {
                if(!State.currentUser.progress[course.lessons[idx-1].id]) isLocked = true;
            }
            
            let checkboxAction = "";
            if (!hasPlan) {
                checkboxAction = `showToast('Ù¾ÛØ¯Ú¤ÛŒÛ• Ø¯Û•Ø³Ù¾ÛÚ©Û Ù¾Ù„Ø§Ù†Û Ø¯Ø§Ø¨Ù†ÛÛŒ!', 'warning');`;
            } else if (isLocked) {
                checkboxAction = "";
            } else if (isSeerah) {
                checkboxAction = `showToast('Ø¨Û† Ú¤ÛŒ Ø¨Ø§Ø¨Û•ØªÛŒØŒ ÙÛ•Ø±Û• ØªÛØ¨ÛŒÙ†ÛŒØ§Ù† Ù„ Ø®ÙˆØ§Ø±Û Ø¨Ù†Ú¤ÛŒØ³ÛŒ.', 'info')`;
            } else {
                checkboxAction = `toggleLesson('${lesson.id}', ${lesson.points}, '${course.id}', ${idx})`;
            }

            let openAction = `openLessonContent('${course.id}', ${idx})`;

            return `
            <div class="lesson-row ${isCompleted ? 'completed' : ''} ${isLocked ? 'locked' : ''}">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:15px; margin-bottom:10px;">
                    <div style="display:flex; align-items:center; gap:15px; flex:1;">
                        <div class="checkbox-custom ${isCompleted ? 'checked' : ''} ${(!hasPlan || isLocked) ? 'disabled' : ''}" 
                            onclick="${checkboxAction}">
                            ${isCompleted ? '<i class="fas fa-check"></i>' : (isSeerah ? '<i class="fas fa-pen" style="font-size:0.8rem; opacity:0.5;"></i>' : '')}
                        </div>
                        <div style="cursor:pointer;" onclick="${openAction}">
                            <h4 style="font-weight:700; font-size:1.05rem;">${lesson.title}</h4>
                            <p style="font-size:0.85rem; color:var(--text-secondary); margin-top:3px;">
                                <i class="fas fa-book-open"></i> ÙˆØ§Ù†Û• &nbsp; <i class="fas fa-video"></i> ${isHifz ? 'Ú˜Ø¨Û•Ø±Ú©Ø±Ù†' : 'Ú¤ÛŒØ¯ÛŒÛ†'}
                            </p>
                        </div>
                    </div>
                    <button onclick="${openAction}" style="background:var(--accent-secondary); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; box-shadow:0 5px 15px rgba(14,165,233,0.3);">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
                ${(isSeerah && hasPlan && !isLocked) ? `
                <div style="margin-top:10px;">
                     <textarea id="input-${lesson.id}" style="width:100%; min-height:60px; background:var(--bg-main); border:1px solid var(--border-color); color:var(--text-primary); padding:10px; border-radius:8px;" placeholder="ØªÛØ¨ÛŒÙ†ÛŒ..." ${isCompleted ? 'disabled' : ''}>${State.currentUser.notes[lesson.id] || ''}</textarea>
                     ${!isCompleted ? `<button class="btn-primary" style="margin-top:5px; width:100%; justify-content:center; padding:5px;" onclick="saveNoteAndComplete('${lesson.id}', ${lesson.points}, '${course.id}', ${idx})">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†</button>` : ''}
                </div>` : ''}
            </div>`;
        }).join('')}
        </div>
    </div>`;
}

function toggleLesson(id, points, courseId, index) {
    let course = null;
    appData.levels.forEach(l => { let c = l.courses.find(x => x.id === courseId); if(c) course = c; });

    if (index > 0) {
        if (!State.currentUser.progress[course.lessons[index-1].id]) {
            showToast("Ù†Ø§Ø¨Øª Ø¨Ú†ÛŒÛ• Ú¤Û ÙˆØ§Ù†Û•ÛŒÛ Ù‡Û•ØªØ§ ÛŒØ§ Ø¨Û•Ø±ÛŒ ÙˆÛ ØªÛ•Ù…Ø§Ù… Ù†Û•Ú©Û•ÛŒ!", "warning");
            return;
        }
    }
    
    // Toggle Logic
    if (State.currentUser.progress[id]) {
        // Undo
        if (index + 1 < course.lessons.length) {
            if (State.currentUser.progress[course.lessons[index+1].id]) {
                showToast("Ù†Û•Ø´ÛÛŒ Ú¤Û ÙˆØ§Ù†Û Ù‡Û•ÚµØ¨ÙˆÛ•Ø´ÛŒÙ†ÛŒ Ú†ÙˆÙ†Ú©ÛŒ ØªÛ• ÙˆØ§Ù†Û•ÛŒØ§ Ø¯ÙˆÛŒÚ¤Ø¯Ø§ Ø®Ù„Ø§Ø³ Ú©Ø±ÛŒÛ•.", "warning");
                return;
            }
        }
        delete State.currentUser.progress[id];
        State.currentUser.points -= points;
        
        if(course.type === 'hifz') {
            const juzNum = course.lessons[index].juzNum;
            if(!State.currentUser.hifz) State.currentUser.hifz = { quran: [] };
            const idxHifz = State.currentUser.hifz.quran.findIndex(x => x.juz === juzNum);
            if(idxHifz > -1) State.currentUser.hifz.quran.splice(idxHifz, 1);
        }

    } else {
        // Complete
        State.currentUser.progress[id] = true;
        State.currentUser.points += points;

        if(course.type === 'hifz') {
            const juzNum = course.lessons[index].juzNum;
            if(!State.currentUser.hifz) State.currentUser.hifz = { quran: [] };
            if(!State.currentUser.hifz.quran.find(x => x.juz === juzNum)) {
                State.currentUser.hifz.quran.push({ juz: juzNum, status: 'done' });
            }
        }
    }
    saveState();
    openCourse(courseId);
    renderLevels();
}

function saveNoteAndComplete(lessonId, points, courseId, index) {
    const text = document.getElementById(`input-${lessonId}`).value.trim();
    if(text.length < 5) { showToast("ØªÚ©Ø§ÛŒÛ• ØªÛØ¨ÛŒÙ†ÛŒÛ•Ú©Û Ø¨Ù†Ú¤ÛŒØ³Û•.", "warning"); return; }
    
    State.currentUser.notes[lessonId] = text;
    State.currentUser.progress[lessonId] = true;
    State.currentUser.points += points;
    saveState();
    openCourse(courseId);
    renderLevels();
}

/* --- 7. CONTENT VIEWER (UNIFIED PDF) --- */
function openLessonContent(courseId, lessonIdx) {
    let course = null;
    appData.levels.forEach(l => { let c = l.courses.find(x => x.id === courseId); if(c) course = c; });
    const lesson = course.lessons[lessonIdx];

    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    
    modalTitle.innerText = lesson.title;
    document.getElementById('modal-timer').style.display = 'none';
    const pdfUrl = course.pdf || "about:blank";

    modalContent.innerHTML = `
        <div class="lesson-viewer-grid">
            <div>
                ${lesson.video ? `
                <div class="video-wrapper">
                     <iframe src="${lesson.video}" title="Video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
                ` : `<div style="padding:40px; text-align:center; background:var(--bg-main); border:1px solid var(--border-color); border-radius:10px; margin-bottom:20px; color:var(--text-secondary);">Ú¤ÛŒØ¯ÛŒÛ† Ù†ÛŒÙ†Û•</div>`}
                
                <h4 style="margin-bottom:10px; color:var(--accent-secondary);"><i class="fas fa-align-right"></i> Ù…Û•ØªÙ†Û ÙˆØ§Ù†Û•ÛŒÛ</h4>
                <div class="matn-box">
                    ${lesson.text}
                </div>
            </div>
            
            <div>
                 <h4 style="margin-bottom:10px; color:var(--accent-secondary);"><i class="fas fa-file-pdf"></i> Ù¾Û•Ø±ØªÙˆÙˆÚ©Ø§ Ú©Û†Ø±Ø³ÛŒ (PDF)</h4>
                 <div class="pdf-wrapper">
                    <iframe src="${pdfUrl}" width="100%" height="100%" style="border:none;"></iframe>
                 </div>
                 <a href="${pdfUrl}" target="_blank" class="btn-outline" style="width:100%; justify-content:center; margin-top:10px;"><i class="fas fa-download"></i> Ø¯Ø§Ú¯Ø±ØªÙ† PDF</a>
            </div>
        </div>
        <div style="margin-top:20px; text-align:left;">
             <button class="btn-outline" onclick="openCourse('${courseId}')"> <i class="fas fa-arrow-right"></i> Ø²Ú¤Ú•ÛŒÙ† Ø¨Û† Ù„ÛŒØ³ØªÛ</button>
        </div>
    `;
    document.getElementById('main-modal').classList.add('open');
}

/* --- 8. LIBRARY RENDER --- */
function renderLibrary() {
    const container = document.getElementById('library-grid');
    if(!State.currentUser) {
        container.innerHTML = `
        <div style="text-align:center; padding:30px; grid-column:1/-1;">
            <i class="fas fa-lock" style="font-size:3rem; color:var(--text-secondary); margin-bottom:15px;"></i>
            <p style="margin-bottom:15px;">Ù¾ÛØ¯Ú¤ÛŒÛ• Ø¯Û•Ø³Ù¾ÛÚ©Û Ø¨Ú†ÛŒÛ• Ú˜ÙˆÙˆØ± Ø¨Û† Ø¯ÛŒØªÙ†Ø§ Ú¤ÛŒØ¯ÛŒÛ†ÛŒØ§Ù†.</p>
            <button class="btn-primary" onclick="switchView('profile', document.querySelectorAll('.nav-item')[2])">Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ±</button>
        </div>`;
        return;
    }
    
    // Determine highest level completed (simple logic)
    let userMaxLevel = 0;
    if(State.currentUser.unlockedLevels.includes(2)) userMaxLevel = 1;
    if(State.currentUser.unlockedLevels.includes(3)) userMaxLevel = 2;
    
    container.innerHTML = appData.library.map(item => {
        const isLocked = item.unlockLevel > userMaxLevel;
        return `
            <div class="library-card ${isLocked ? 'locked' : ''}">
                <div class="library-thumb">
                    ${isLocked ? '<i class="fas fa-lock"></i>' : `<i class="fas ${item.icon}"></i>`}
                </div>
                <div class="library-info">
                    <span class="lib-badge">${isLocked ? `Ø¦Ø§Ø³ØªÛ ${item.unlockLevel} Ù¾ÛØ¯Ú¤ÛŒÛ•` : 'Ú©Ø±Ø§ÙˆÛ•ÛŒÛ•'}</span>
                    <h3 style="font-size:1.1rem; margin-bottom:5px;">${item.title}</h3>
                    <p style="color:var(--text-secondary); font-size:0.9rem;">${item.instructor} â€¢ ${item.duration}</p>
                    ${!isLocked ? `<button class="btn-outline" style="width:100%; margin-top:15px; justify-content:center;">ØªÛ•Ù…Ø§Ø´Û•Ú©Ø±Ù†</button>` : ''}
                </div>
            </div>
        `;
    }).join('');
}

/* --- 9. PROFILE & TREE & HIFZ & AUTH VIEW --- */
function getTreeStage(percent) {
    // UPDATED LOGIC: Seed under soil for < 10%
    if (percent < 10) return { icon: "fa-seedling", color: "#8d6e63", scale: 0.8, isSeed: true }; // Seed   
    if (percent < 30) return { icon: "fa-seedling", color: "#a3e635", scale: 1.1, isSeed: false }; // Sprout 
    if (percent < 60) return { icon: "fa-tree", color: "#4ade80", scale: 1.0, isSeed: false }; // Small tree
    if (percent < 90) return { icon: "fa-tree", color: "#16a34a", scale: 1.3, isSeed: false }; // Big tree
    return { icon: "fa-apple-whole", color: "#fbbf24", scale: 1.2, isSeed: false }; // Fruit            
}

function renderProfileView() {
    const container = document.getElementById('view-profile');
    if(!State.currentUser) {
        renderAuthForms(container);
    } else {
        renderUserProfile(container);
    }
}

function renderUserProfile(container) {
    const percent = calculateTotalPercent();
    const stage = getTreeStage(percent);
    
    if(!State.currentUser.dailyTasks) {
        State.currentUser.dailyTasks = { date: new Date().toDateString(), tasks: { prayer: false, quran: false, dhikr: false, reading: false } };
    }
    const tasks = State.currentUser.dailyTasks.tasks;
    const d = State.currentUser.details || {};
    if(!State.currentUser.hifz) State.currentUser.hifz = { quran: [] };

    container.innerHTML = `
        <div style="padding:20px; animation: fadeIn 0.5s;">
            <!-- Tree Progress -->
            <div class="tree-container">
                <div class="tree-circle ${stage.isSeed ? 'seed-stage' : ''}" style="border-color:${stage.color}; ${!stage.isSeed ? `box-shadow: 0 0 30px ${stage.color}40` : ''};">
                    <i class="fas ${stage.icon} tree-icon" style="color:${stage.color}; transform:scale(${stage.scale});"></i>
                </div>
                <div style="color:var(--text-secondary); margin-bottom:15px;">Ú•ÛÚ˜Û•ÛŒØ§ Ú¯Ø´ØªÛŒ: <span style="color:var(--accent-primary); font-weight:bold;">%${percent}</span></div>
            </div>

            <div class="profile-header-insta" style="border-bottom:none; margin-bottom:10px;">
                <div class="profile-avatar-xl">
                    <img src="https://ui-avatars.com/api/?name=${State.currentUser.name}&background=0ea5e9&color=fff&bold=true" alt="Avatar">
                </div>
                <div style="flex:1;">
                    <div class="profile-stats-row">
                        <div class="stat-box">
                            <span class="stat-num">${State.currentUser.points}</span>
                            <span class="stat-label">Ø®Ø§Ù„</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-num">${State.currentUser.streak || 0}</span>
                            <span class="stat-label">Ø³ØªØ±ÛŒÙƒ</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-num">${State.currentUser.hifz.quran.filter(x => x.status === 'done').length}</span>
                            <span class="stat-label">Ø¬Ø²Ø¡</span>
                        </div>
                    </div>
                    <button class="btn-outline" style="padding:5px 20px; font-size:0.85rem; width:100%; justify-content:center;" onclick="openEditProfile()">
                        <i class="fas fa-edit"></i> Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ
                    </button>
                </div>
            </div>

            <!-- Daily Tasks -->
            <div style="margin-bottom:25px;">
                <h4 style="margin-bottom:10px; color:var(--text-primary);"><i class="fas fa-list-check"></i> Ú©Ø§Ø±ÛÙ† Ú•Û†Ú˜Ø§Ù†Û•</h4>
                <div class="task-card" onclick="toggleDailyTask('prayer')">
                    <span><i class="fas fa-pray" style="color:var(--accent-secondary); width:25px;"></i> Ù†Ú¤ÛÚ˜ÛÙ† ÙÛ•Ø±Ø²</span>
                    ${tasks.prayer ? '<i class="fas fa-check-circle" style="color:var(--success-color);"></i>' : '<i class="far fa-circle"></i>'}
                </div>
                <div class="task-card" onclick="toggleDailyTask('quran')">
                    <span><i class="fas fa-book-open" style="color:var(--accent-secondary); width:25px;"></i> Ø®ÙˆÛÙ†Ø¯Ù†Ø§ Ù‚ÙˆØ±Ø¦Ø§Ù†Û</span>
                    ${tasks.quran ? '<i class="fas fa-check-circle" style="color:var(--success-color);"></i>' : '<i class="far fa-circle"></i>'}
                </div>
            </div>

            <!-- Hifz Section -->
            <div class="hifz-container">
                 <h4 style="margin-bottom:10px; color:var(--text-primary); border-top:1px solid var(--border-color); padding-top:15px;">
                    <i class="fas fa-quran"></i> Ø¨Û•Ø´Û Ø­Û•ÙØ¸Ø§ Ù‚ÙˆØ±Ø¦Ø§Ù†Û
                 </h4>
                 <p style="font-size:0.85rem; color:var(--text-secondary);">Ø¦Û•Ú¤ Ø¨Û•Ø´Û• Ø¨ Ø´ÛÙˆÛ•ÛŒÛ•Ú©Û Ø¦ÙˆØªÙˆÙ…Ø§ØªÛŒÚ©ÛŒ Ø¯Ù‡ÛØªÛ• Ù¾Ú•Ú©Ø±Ù† Ø¯Û•Ù…Û ØªÛ† ÙˆØ§Ù†Û•ÛŒÛÙ† Ø­Û•ÙØ¸Û Ø¯Ù†Ø§Ú¤ Ø¦Ø§Ø³ØªØ§Ù† Ø¯Ø§ ØªÛ•Ù…Ø§Ù… Ø¯Ú©Û•ÛŒ.</p>
                 <div class="hifz-grid">
                    ${renderHifzGrid()}
                 </div>
            </div>

            <button onclick="logout()" class="btn-primary" style="margin-top:30px; width:100%; justify-content:center; background:transparent; border:1px solid var(--danger-color); color:var(--danger-color); box-shadow:none;">
                <i class="fas fa-sign-out-alt"></i> Ø¯Û•Ø±Ú©Û•ÙØªÙ†
            </button>
        </div>
    `;
}

function renderHifzGrid() {
    let html = '';
    const hifz = State.currentUser.hifz.quran || []; 
    
    for(let i=1; i<=30; i++) {
        const entry = hifz.find(x => x.juz === i);
        let statusClass = '';
        let icon = '';
        
        if(entry) {
            if(entry.status === 'done') { statusClass = 'completed'; icon = '<i class="fas fa-check"></i>'; }
        }
        
        html += `<div class="juz-box ${statusClass}">
            <span>${i}</span>
            ${icon}
        </div>`;
    }
    return html;
}

function toggleDailyTask(taskKey) {
    if(!State.currentUser.dailyTasks) return;
    State.currentUser.dailyTasks.tasks[taskKey] = !State.currentUser.dailyTasks.tasks[taskKey];
    if(State.currentUser.dailyTasks.tasks[taskKey]) State.currentUser.points += 2;
    else State.currentUser.points -= 2;
    saveState();
    renderProfileView(); // Re-render logic
}

/* NEW: Edit Profile Functions */
function openEditProfile() {
    const d = State.currentUser.details || {};
    const modalBody = document.getElementById('edit-profile-body');
    modalBody.innerHTML = `
        <form onsubmit="saveEditProfile(event)">
             <div class="form-group">
                <label class="form-label">Ù†Ø§Ú¤Û Ø³ÛŒØ§Ù†ÛŒ</label>
                <input type="text" id="edit-name" class="form-input" value="${State.currentUser.name}" required>
            </div>
             <div class="form-group">
                <label class="form-label">ØªÛŒÙ„ÛŒÚ¯Ø±Ø§Ù…</label>
                <input type="text" id="edit-telegram" class="form-input" value="${d.telegram || ''}">
            </div>
             <div class="row-2">
                 <div class="form-group">
                    <label class="form-label">Ù¾Ø§Ø±ÛØ²Ú¯Û•</label>
                    <select id="edit-province" class="form-input">
                        <option value="Ø¯Ù‡Û†Ú©" ${d.province === 'Ø¯Ù‡Û†Ú©' ? 'selected' : ''}>Ø¯Ù‡Û†Ú©</option>
                        <option value="Ù‡Û•ÙˆÙ„ÛØ±" ${d.province === 'Ù‡Û•ÙˆÙ„ÛØ±' ? 'selected' : ''}>Ù‡Û•ÙˆÙ„ÛØ±</option>
                        <option value="Ø³Ù„ÛÙ…Ø§Ù†ÛŒ" ${d.province === 'Ø³Ù„ÛÙ…Ø§Ù†ÛŒ' ? 'selected' : ''}>Ø³Ù„ÛÙ…Ø§Ù†ÛŒ</option>
                        <option value="Ú©Û•Ø±Ú©ÙˆÚ©" ${d.province === 'Ú©Û•Ø±Ú©ÙˆÚ©' ? 'selected' : ''}>Ú©Û•Ø±Ú©ÙˆÚ©</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label class="form-label">Ø¨Ø§Ú˜ÛØ±</label>
                    <input type="text" id="edit-city" class="form-input" value="${d.city || ''}">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Ù¾Ø§Ø³ÙˆÙˆØ±Ø¯ (Ø¨Û† Ú¯Û†Ú•ÛŒÙ†)</label>
                <input type="text" id="edit-pass" class="form-input" value="${State.currentUser.pass}">
            </div>
            <button type="submit" class="btn-primary" style="width:100%; justify-content:center;">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†Ø§ Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒØ§Ù†</button>
        </form>
    `;
    document.getElementById('edit-profile-modal').classList.add('open');
}

function saveEditProfile(e) {
    e.preventDefault();
    State.currentUser.name = document.getElementById('edit-name').value;
    State.currentUser.pass = document.getElementById('edit-pass').value;
    State.currentUser.details.telegram = document.getElementById('edit-telegram').value;
    State.currentUser.details.province = document.getElementById('edit-province').value;
    State.currentUser.details.city = document.getElementById('edit-city').value;
    saveState();
    document.getElementById('edit-profile-modal').classList.remove('open');
    renderProfileView(); 
    showToast("Ù¾Ú•Û†ÙØ§ÛŒÙ„ Ø¨ Ø³Û•Ø±Ú©Û•ÙØªÛŒØ§Ù†Û• Ù‡Ø§ØªÛ• Ù†ÙˆÛŒÚ©Ø±Ø¯Ù†.", "success");
}

function calculateTotalPercent() {
    if (!State.currentUser) return 0;
    let totalLessons = 0;
    let completedLessons = 0;
    appData.levels.forEach(level => {
        level.courses.forEach(course => {
            totalLessons += course.lessons.length;
            course.lessons.forEach(lesson => { if(State.currentUser.progress[lesson.id]) completedLessons++; });
        });
    });
    return totalLessons === 0 ? 0 : Math.floor((completedLessons / totalLessons) * 100);
}

function generateLevelCertificate(levelTitle) {
    const modalContent = document.getElementById('modal-content');
    const modalTitle = document.getElementById('modal-title');
    document.getElementById('modal-timer').style.display = 'none';
    modalTitle.innerText = "ÙˆÛ•Ø±Ú¯Ø±ØªÙ†Ø§ Ø¨Ú•ÙˆØ§Ù†Ø§Ù…Û";
    const userName = State.currentUser.name;
    const today = new Date().toLocaleDateString('ku-IQ');
    document.getElementById('main-modal').classList.add('open');
    modalContent.innerHTML = `
        <div id="print-area">
            <div id="certificate-view" style="display:block;">
                <i class="fas fa-kaaba" style="font-size:4rem; color:var(--accent-primary); margin-bottom:10px;"></i>
                <h1>Ø¨Ú•ÙˆØ§Ù†Ø§Ù…Û•ÛŒØ§ Ú•ÛØ²Ú¯Ø±ØªÙ†Û</h1>
                <p class="cert-subtitle">Ø¦Û•Ú¤ Ø¨Ú•ÙˆØ§Ù†Ø§Ù…Û• Ù¾ÛØ´Ú©ÛØ´Û• Ø¨Û† Ø¨Û•Ú•ÛØ²:</p>
                <div class="cert-name">${userName}</div>
                <p class="cert-subtitle">Ú˜Ø¨Û•Ø± ØªÛ•ÙˆØ§ÙˆÚ©Ø±Ù†Ø§ Ø³Û•Ø±Ú©Û•ÙØªÛŒØ§Ù†Û• ÛŒØ§:</p>
                <div class="cert-level">${levelTitle}</div>
                <p>Ù„ Ù¾Ù„Ø§ØªÙÛ†Ø±Ù…Ø§ Ø³Ø¨Ù„ Ø§Ù„Ø³Ù„Ø§Ù… Ø¨Û† Ø²Ø§Ù†Ø³ØªÛ Ø´Û•Ø±Ø¹ÛŒ</p>
                <div style="margin-top:40px; display:flex; justify-content:space-between; padding:0 30px; border-top:1px solid #ddd; padding-top:10px;">
                    <span>Ú•ÛÚ©Û•ÙˆØª: ${today}</span>
                    <span>ÙˆØ§Ú˜ÙˆÙˆ: Ø³Ø¨Ù„ Ø§Ù„Ø³Ù„Ø§Ù…</span>
                </div>
            </div>
        </div>
        <button class="btn-primary" onclick="window.print()" style="width:100%; margin-top:20px; justify-content:center;">
            <i class="fas fa-print"></i> Ú†Ø§Ù¾Ú©Ø±Ù† / PDF
        </button>
    `;
}

function renderAuthForms(container) {
    container.innerHTML = `
        <div style="padding:20px 10px;">
        <h2 style="text-align:center; margin-bottom:20px;">Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ± / ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†</h2>
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchAuthTab('login')">Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ±</div>
            <div class="auth-tab" onclick="switchAuthTab('register')">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù† (Ù†ÙˆÛ)</div>
        </div>
        <form id="login-form" onsubmit="loginUser(event)" style="animation:fadeIn 0.4s;">
            <div class="form-group">
                <label class="form-label">Ø¦ÛŒÙ…ÛÙ„ ÛŒØ§Ù† Ú˜Ù…Ø§Ø±Ø§ Ù…ÙˆØ¨Ø§ÛŒÙ„Û</label>
                <input type="text" id="login-id" class="form-input" required placeholder="0750...">
            </div>
            <div class="form-group">
                <label class="form-label">Ù¾Ø§Ø³ÙˆÙˆØ±Ø¯</label>
                <input type="password" id="login-pass" class="form-input" required placeholder="******">
            </div>
            <button type="submit" class="btn-primary" style="width:100%; justify-content:center;">Ø¨Ú†Û† Ú˜ÙˆÙˆØ±</button>
        </form>
        <form id="register-form" onsubmit="registerUser(event)" style="display:none; animation:fadeIn 0.4s;">
            <h4 class="form-section-title">Ù¡. Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛÙ† Ú©Û•Ø³ÛŒ</h4>
            <div class="form-group">
                <label class="form-label">Ù†Ø§Ú¤Û Ø³ÛŒØ§Ù†ÛŒ (ØªÛ•ÙˆØ§Ùˆ)</label>
                <input type="text" id="reg-name" class="form-input" required placeholder="Ù†Ø§Ú¤ - Ø¨Ø§Ø¨ - Ø¨Ø§Ù¾ÛŒØ±">
            </div>
            <div class="row-2">
                <div class="form-group">
                    <label class="form-label">Ø³Ø§ÚµØ§ Ú˜ Ø¯Ø§ÛŒÚ©Ø¨ÙˆÙˆÙ†Û</label>
                    <input type="number" id="reg-birth" class="form-input" required placeholder="2000" min="1950" max="2020">
                </div>
                 <div class="form-group">
                    <label class="form-label">Ú•Û•Ú¯Û•Ø²</label>
                    <select id="reg-gender" class="form-input" required>
                        <option value="male">Ù†ÛØ±</option>
                        <option value="female">Ù…Û</option>
                    </select>
                </div>
            </div>
             <div class="form-group">
                <label class="form-label">Ú˜Ù…Ø§Ø±Ø§ Ù…ÙˆØ¨Ø§ÛŒÙ„Û (ÙˆÛ•Ú© ID Ø¯Ù‡ÛØªÛ• Ø¨Ú©Ø§Ø±ÛŒÙ†Ø§Ù†)</label>
                <input type="tel" id="reg-contact" class="form-input" required placeholder="0750..." pattern="[0-9]{11}">
            </div>
             <div class="form-group">
                <label class="form-label">ØªÛŒÙ„ÛŒÚ¯Ø±Ø§Ù… (Ù†Ø§Ú¤ / Ú˜Ù…Ø§Ø±Û• / Ù„ÛŒÙ†Ú©)</label>
                <input type="text" id="reg-telegram" class="form-input" placeholder="@username ...">
            </div>
            <h4 class="form-section-title">Ù¢. Ø¬Ù‡Ù€ Ùˆ Ù†ÛŒØ´ØªÛ•Ø¬ÛØ¨ÙˆÙˆÙ†</h4>
            <div class="row-2">
                 <div class="form-group">
                    <label class="form-label">Ù¾Ø§Ø±ÛØ²Ú¯Û•</label>
                    <select id="reg-province" class="form-input" required>
                        <option value="Ø¯Ù‡Û†Ú©">Ø¯Ù‡Û†Ú©</option>
                        <option value="Ù‡Û•ÙˆÙ„ÛØ±">Ù‡Û•ÙˆÙ„ÛØ±</option>
                        <option value="Ø³Ù„ÛÙ…Ø§Ù†ÛŒ">Ø³Ù„ÛÙ…Ø§Ù†ÛŒ</option>
                        <option value="Ú©Û•Ø±Ú©ÙˆÚ©">Ú©Û•Ø±Ú©ÙˆÚ©</option>
                        <option value="Ù‡Û•ÚµÛ•Ø¨Ø¬Û•">Ù‡Û•ÚµÛ•Ø¨Ø¬Û•</option>
                        <option value="Ù†Û•ÛŒÙ†Û•ÙˆØ§">Ù†Û•ÛŒÙ†Û•ÙˆØ§</option>
                        <option value="Ø¯ÛŒ">Ø¯ÛŒ...</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label class="form-label">Ù‚Û•Ø²Ø§ / Ø¨Ø§Ú˜ÛØ±</label>
                    <input type="text" id="reg-city" class="form-input" required placeholder="Ù†Ù…ÙˆÙˆÙ†Û•: Ø¦Ø§Ú©Ø±Û">
                </div>
            </div>
            <h4 class="form-section-title">Ù£. Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛÙ† Ø²Ø§Ù†Ø³ØªÛŒ</h4>
             <div class="row-2">
                <div class="form-group">
                    <label class="form-label">Ø¦Ø§Ø³ØªÛ Ø®ÙˆØ§Ù†Ø¯Ù†Û</label>
                    <select id="reg-edu-level" class="form-input" required>
                        <option value="" disabled selected>Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•...</option>
                        <option value="sereke">Ø³Û•Ø±Û•ØªØ§ÛŒÛŒ</option>
                        <option value="navendi">Ù†Ø§ÙˆÛ•Ù†Ø¯ÛŒ</option>
                        <option value="amadeyi_w">Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛŒ (ÙˆÛÚ˜Û•ÛŒÛŒ)</option>
                        <option value="amadeyi_z">Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛŒ (Ø²Ø§Ù†Ø³ØªÛŒ)</option>
                        <option value="peymangeh">Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Û•Ù‡Ù€</option>
                        <option value="zanko">Ø²Ø§Ù†Ú©Û† (Ø¨Û•Ú©Ø§Ù„Û†Ø±ÛŒÛ†Ø³)</option>
                        <option value="master">Ù…Ø§Ø³ØªÛ•Ø±</option>
                        <option value="doctora">Ø¯Ú©ØªÛ†Ø±Ø§</option>
                        <option value="islamic">Ø®ÙˆÛÙ†Ø¯Ù†Ø§ Ø¦ÛŒØ³Ù„Ø§Ù…ÛŒ / Ø­ÙˆØ¬Ø±Û•</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label class="form-label">Ù¾ÛŒØ´Û•</label>
                    <select id="reg-role" class="form-input" required>
                        <option value="student">Ù‚ÙˆØªØ§Ø¨ÛŒ</option>
                        <option value="employee">ÙÛ•Ø±Ù…Ø§Ù†Ø¨Û•Ø±</option>
                        <option value="other">Ú©Ø§Ø³Ø¨</option>
                        <option value="none">Ø¨Û Ø¦ÛŒØ´</option>
                    </select>
                </div>
            </div>
            <div class="form-group" style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:15px;">
                <label class="form-label">Ù¾Ø§Ø³ÙˆÙˆØ±Ø¯ (ÙˆØ´Û•ÛŒØ§ Ù†Ù‡ÛÙ†ÛŒ)</label>
                <input type="password" id="reg-pass" class="form-input" required minlength="4" placeholder="******">
            </div>
            <button type="submit" class="btn-primary" style="width:100%; justify-content:center; margin-top:10px;">Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ù†Ø§ Ù‡Û•Ú˜Ù…Ø§Ø±Û</button>
        </form>
        </div>
    `;
}

function switchAuthTab(tab) {
    const tabs = document.querySelectorAll('.auth-tab');
    const loginForm = document.getElementById('login-form');
    const regForm = document.getElementById('register-form');
    if (tab === 'login') {
        tabs[0].classList.add('active'); tabs[1].classList.remove('active');
        loginForm.style.display = 'block'; regForm.style.display = 'none';
    } else {
        tabs[0].classList.remove('active'); tabs[1].classList.add('active');
        loginForm.style.display = 'none'; regForm.style.display = 'block';
    }
}

function registerUser(e) {
    e.preventDefault();
    const name = document.getElementById('reg-name').value;
    const birthYear = document.getElementById('reg-birth').value;
    const gender = document.getElementById('reg-gender').value;
    const contact = document.getElementById('reg-contact').value;
    const telegram = document.getElementById('reg-telegram').value;
    const province = document.getElementById('reg-province').value;
    const city = document.getElementById('reg-city').value;
    const eduSelect = document.getElementById('reg-edu-level');
    const eduLevel = eduSelect.options[eduSelect.selectedIndex].text;
    const roleSelect = document.getElementById('reg-role');
    const roleText = roleSelect.options[roleSelect.selectedIndex].text;
    const pass = document.getElementById('reg-pass').value;

    if(State.usersDB.some(u => u.contact === contact)) {
        showToast("Ø¦Û•Ú¤ Ú˜Ù…Ø§Ø±Û• ÛŒØ§Ù† Ø¦ÛŒÙ…ÛÙ„Û• Ø¨Û•Ø±ÛŒ Ù†ÙˆÚ©Û• Ù‡Ø§ØªÛŒÛ• ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†!", "warning");
        return;
    }

    const newUser = { 
        name, contact, pass, 
        details: { birthYear, gender, telegram, province, city, eduLevel, roleText },
        joined: Date.now(),
        lastLoginDate: new Date().toDateString(),
        streak: 1, points: 0, progress: {}, plans: {}, unlockedLevels: [1], notes: {}, hifz: { quran: [] },
        dailyTasks: { date: new Date().toDateString(), tasks: { prayer: false, quran: false, dhikr: false, reading: false } }
    };
    State.usersDB.push(newUser);
    State.currentUser = newUser;
    saveState();
    // Instead of closeModal, we re-render profile view
    renderProfileView();
    initApp();
    showToast("Ù¾ÛŒØ±Û†Ø²Û•! Ù‡Û•Ú˜Ù…Ø§Ø±Ø§ ØªÛ• Ù‡Ø§ØªÛ• Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ù†.", "success");
}

function loginUser(e) {
    e.preventDefault();
    const id = document.getElementById('login-id').value;
    const pass = document.getElementById('login-pass').value;
    const user = State.usersDB.find(u => u.contact === id && u.pass === pass);
    if(user) {
        State.currentUser = user;
        if(!State.currentUser.unlockedLevels) State.currentUser.unlockedLevels = [1];
        if(!State.currentUser.details) State.currentUser.details = {}; 
        if(!State.currentUser.hifz) State.currentUser.hifz = { quran: [] }; 
        saveState();
        renderProfileView(); // Re-render profile view
        initApp();
        showToast("Ø¨Û•Ø®ÛØ±Ù‡Ø§ØªÛŒ!", "success");
    } else {
        showToast("Ù†Ø§Ú¤Û Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±ÛŒ ÛŒØ§Ù† Ù¾Ø§Ø³ÙˆÙˆØ±Ø¯ Ø®Û•Ù„Û•ØªÛ•!", "danger");
    }
}

function logout() {
    if(confirm('Ø¯Û•Ø±Ú©Û•ÙØªÙ† Ú˜ Ø¨Û•Ø±Ù†Ø§Ù…Û•ÛŒØŸ')) {
        State.currentUser = null;
        localStorage.removeItem('sabilLastUser_v12');
        location.reload();
    }
}

function closeModal() { document.getElementById('main-modal').classList.remove('open'); }
function openTutorial() {
    document.getElementById('main-modal').classList.add('open');
    document.getElementById('modal-content').innerHTML = '<p style="text-align:center;">Ù„ÛØ±Û• Ú¤ÛŒØ¯ÛŒÛ†ÛŒØ§ ÙÛØ±Ú©Ø§Ø±ÛŒ Ø¯Û Ù‡ÛØªÛ• Ø¯Ø§Ù†Ø§Ù†...</p>';
}
</script>
</body>
</html>
