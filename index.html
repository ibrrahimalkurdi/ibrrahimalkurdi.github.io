<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>سبل السلام | ڕێڕەوا زانستێ شەرعی</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;500;700;800&display=swap');

/* --- THEME VARIABLES --- */
:root {
    --bg-main: #0f172a; 
    --bg-secondary: #1e293b; 
    --bg-glass: rgba(30, 41, 59, 0.95);
    --text-primary: #f8fafc; 
    --text-secondary: #94a3b8; 
    --accent-primary: #fbbf24; 
    --accent-glow: rgba(251, 191, 36, 0.4);
    --accent-secondary: #0ea5e9; 
    --border-color: #334155;
    --success-color: #10b981; 
    --danger-color: #ef4444; 
    --warning-color: #f59e0b;
    --font-body: 'Noto Naskh Arabic', sans-serif;
    --radius-xl: 24px;
    --radius-md: 16px;
    --radius-sm: 8px;
    --shadow-main: 0 10px 30px -10px rgba(0,0,0,0.5);
    --gradient-bg: radial-gradient(circle at 10% 10%, rgba(14, 165, 233, 0.05) 0%, transparent 40%),
                   radial-gradient(circle at 90% 90%, rgba(251, 191, 36, 0.05) 0%, transparent 40%);
}

[data-theme="light"] {
    --bg-main: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-glass: rgba(255, 255, 255, 0.95);
    --text-primary: #0f172a;
    --text-secondary: #64748b;
    --accent-primary: #d97706; 
    --accent-glow: rgba(217, 119, 6, 0.3);
    --accent-secondary: #0284c7; 
    --border-color: #e2e8f0;
    --shadow-main: 0 10px 30px -10px rgba(0,0,0,0.1);
    --gradient-bg: radial-gradient(circle at 10% 10%, rgba(2, 132, 199, 0.05) 0%, transparent 40%),
                   radial-gradient(circle at 90% 90%, rgba(217, 119, 6, 0.05) 0%, transparent 40%);
}

* { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
html { scroll-behavior: smooth; }
body { 
    font-family: var(--font-body); 
    background-color: var(--bg-main); 
    color: var(--text-primary); 
    line-height: 1.8; 
    overflow-x: hidden; 
    min-height: 100vh;
    background-image: var(--gradient-bg);
    transition: background-color 0.3s, color 0.3s;
}

/* Scrollbar */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-main); }
::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }

.container { width: 92%; max-width: 1200px; margin: auto; }

/* Loading Screen */
#loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-main); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.8s ease-out, visibility 0.8s; }
#loading-screen.fade-out { opacity: 0; visibility: hidden; }
.spinner { width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; box-shadow: 0 0 20px var(--accent-glow); }
@keyframes spin { to { transform: rotate(360deg); } }

/* Toast Notifications */
#toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
.toast { background: var(--bg-secondary); border-left: 5px solid var(--accent-primary); padding: 15px; border-radius: var(--radius-sm); box-shadow: 0 10px 30px rgba(0,0,0,0.3); color: var(--text-primary); opacity: 0; transform: translateY(-20px); transition: 0.4s; pointer-events: auto; display: flex; align-items: center; gap: 15px; }
.toast.show { opacity: 1; transform: translateY(0); }
.toast.warning { border-color: var(--warning-color); }
.toast.danger { border-color: var(--danger-color); }
.toast.success { border-color: var(--success-color); }
.toast-icon { font-size: 1.5rem; }

/* Header */
header { position: sticky; top: 0; width: 100%; padding: 15px 0; z-index: 1000; background: var(--bg-secondary); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-color); transition: 0.3s; }
.header-container { display: flex; justify-content: space-between; align-items: center; }
.logo { display: flex; align-items: center; gap: 12px; text-decoration: none; }
.logo-icon { font-size: 2.2rem; color: var(--accent-primary); filter: drop-shadow(0 0 8px var(--accent-glow)); transition: 0.3s; }
.logo:hover .logo-icon { transform: rotate(10deg); }
.logo-text { font-weight: 800; font-size: 1.6rem; color: var(--text-primary); letter-spacing: -0.5px; }
.header-actions { display: flex; align-items: center; gap: 15px; }
.points-display { font-size: 0.95rem; color: var(--accent-primary); background: rgba(251, 191, 36, 0.08); padding: 6px 14px; border-radius: 50px; border: 1px solid rgba(251, 191, 36, 0.2); display: flex; align-items: center; gap: 8px; font-weight: bold; transition: 0.3s; }

.icon-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-main); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; color: var(--text-secondary); position: relative; }
.icon-btn:hover { background: var(--accent-secondary); color: white; border-color: var(--accent-secondary); transform: scale(1.1); }
.notification-dot { position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: var(--danger-color); border-radius: 50%; border: 2px solid var(--bg-main); display: none; }
.notification-dot.active { display: block; }

/* Hero Section */
.hero { text-align: center; padding: 100px 20px 60px; position: relative; overflow: hidden; }
.hero::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; height: 600px; background: var(--accent-secondary); opacity: 0.05; filter: blur(100px); border-radius: 50%; z-index: -1; }
.hero h1 { font-size: 3.5rem; margin-bottom: 25px; background: linear-gradient(135deg, var(--text-primary) 20%, var(--accent-secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; letter-spacing: -1px; line-height: 1.2; }
.hero p { font-size: 1.2rem; color: var(--text-secondary); max-width: 700px; margin: 0 auto 30px; }

.btn-group { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 30px; }
.btn-primary { background: linear-gradient(90deg, var(--accent-primary), #f59e0b); color: #0f172a; padding: 14px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: 700; text-decoration: none; display: inline-flex; align-items: center; gap: 10px; transition: all 0.3s ease; border: none; cursor: pointer; box-shadow: 0 10px 25px rgba(251, 191, 36, 0.3); }
.btn-primary:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 15px 35px rgba(251, 191, 36, 0.5); }
.btn-outline { background: transparent; border: 2px solid var(--border-color); color: var(--text-primary); padding: 12px 30px; border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
.btn-outline:hover { border-color: var(--accent-secondary); color: var(--accent-secondary); background: rgba(14, 165, 233, 0.05); }

/* Levels & Timeline */
.timeline-container { padding: 40px 0 120px; position: relative; }
.level-card { background: var(--bg-glass); border: 1px solid var(--border-color); border-radius: var(--radius-xl); margin-bottom: 40px; overflow: hidden; position: relative; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
.level-card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.1); box-shadow: var(--shadow-main); }
.level-card.active { border-color: var(--accent-secondary); box-shadow: 0 0 20px rgba(14, 165, 233, 0.15); }
.level-card.locked { opacity: 0.7; filter: grayscale(1); border-style: dashed; }
.level-card.locked .level-header { cursor: not-allowed; }

.level-header { padding: 35px; display: flex; align-items: center; gap: 25px; cursor: pointer; background: linear-gradient(to left, rgba(255,255,255,0.02), transparent); }
.level-icon-box { width: 70px; height: 70px; background: var(--bg-secondary); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--accent-secondary); border: 1px solid var(--border-color); flex-shrink: 0; transition: 0.3s; position: relative; overflow: hidden; }
.level-card.active .level-icon-box { background: var(--accent-secondary); color: white; border-color: var(--accent-secondary); box-shadow: 0 0 20px rgba(14, 165, 233, 0.4); }

.level-content { max-height: 0; overflow: hidden; transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(0,0,0,0.1); }
.level-card.active .level-content { max-height: 6000px; }

/* Course Grid */
.courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; padding: 35px; border-top: 1px solid var(--border-color); }
.course-item { background: var(--bg-secondary); padding: 30px 25px; border-radius: var(--radius-md); border: 1px solid var(--border-color); text-align: center; transition: 0.3s; cursor: pointer; position: relative; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; }
.course-item::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--border-color); transition: 0.3s; }
.course-item:hover { transform: translateY(-7px); border-color: rgba(255,255,255,0.1); box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
.course-item:hover::before { background: var(--accent-secondary); }
.course-icon { font-size: 2.8rem; color: var(--accent-secondary); margin-bottom: 20px; display: block; transition: 0.3s; }
.course-item:hover .course-icon { transform: scale(1.1); color: var(--text-primary); text-shadow: 0 0 10px var(--accent-secondary); }

.progress-bar { height: 8px; background: var(--bg-main); margin-top: 20px; border-radius: 4px; overflow: hidden; width: 100%; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-secondary), #3b82f6); width: 0%; transition: width 0.8s ease-out; border-radius: 4px; }

/* Lesson List Styles */
.lesson-row { background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 20px; border-radius: var(--radius-sm); margin-bottom: 15px; transition: 0.3s; }
.lesson-row:hover { border-color: var(--accent-secondary); }
.lesson-row.completed { border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.05); }
.lesson-row.locked { opacity: 0.5; pointer-events: none; border-style: dashed; }

.checkbox-custom { width: 32px; height: 32px; border: 2px solid var(--border-color); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; flex-shrink: 0; background: var(--bg-main); color: transparent; }
.checkbox-custom.checked { background: var(--success-color); border-color: var(--success-color); color: white; transform: scale(1.1); box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
.checkbox-custom.disabled { cursor: not-allowed; opacity: 0.7; border-color: var(--border-color); background: var(--bg-main); }

/* Modals */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); z-index: 2000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
.modal-overlay.open { display: flex; opacity: 1; }
.modal-box { background: var(--bg-secondary); width: 95%; max-width: 900px; max-height: 95vh; overflow-y: auto; border-radius: var(--radius-xl); border: 1px solid var(--border-color); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); position: relative; animation: slideUp 0.4s ease-out; color: var(--text-primary); }
@keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary); position: sticky; top: 0; z-index: 10; }
.modal-body { padding: 30px; }
.modal-close { font-size: 1.6rem; color: var(--text-secondary); cursor: pointer; transition: 0.3s; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
.modal-close:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }

/* Unified Lesson Viewer */
.lesson-viewer-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
@media(min-width: 768px) {
    .lesson-viewer-grid { grid-template-columns: 2fr 1fr; }
}
.video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; background: #000; border-radius: var(--radius-sm); overflow: hidden; margin-bottom: 20px; border: 1px solid var(--border-color); }
.video-wrapper iframe, .video-wrapper video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
.pdf-wrapper { height: 400px; background: #f1f5f9; border-radius: var(--radius-sm); overflow: hidden; border: 1px solid var(--border-color); margin-bottom: 20px; }
.matn-box { background: var(--bg-main); padding: 20px; border-radius: var(--radius-sm); border: 1px solid var(--border-color); max-height: 400px; overflow-y: auto; line-height: 2; font-size: 1.1rem; text-align: justify; }

/* Auth Forms Extended */
.auth-tabs { display: flex; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); }
.auth-tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; color: var(--text-secondary); font-weight: bold; transition: 0.3s; position: relative; }
.auth-tab.active { color: var(--accent-primary); }
.auth-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background: var(--accent-primary); border-radius: 3px 3px 0 0; }
.form-group { margin-bottom: 15px; text-align: right; }
.form-label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500; }
.form-section-title { grid-column: 1 / -1; margin-top: 15px; margin-bottom: 10px; font-size: 1.1rem; color: var(--accent-secondary); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
.form-input { width: 100%; background: var(--bg-main); border: 2px solid var(--border-color); padding: 12px 15px; border-radius: var(--radius-sm); color: var(--text-primary); font-size: 0.95rem; transition: 0.3s; }
.form-input:focus { border-color: var(--accent-secondary); box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); }
.row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

/* Tree Profile & Tasks */
.tree-container { text-align: center; padding: 40px; background: linear-gradient(180deg, rgba(14, 165, 233, 0.05) 0%, transparent 100%); border-radius: var(--radius-md); border: 1px solid var(--border-color); margin-bottom: 25px; }
.tree-circle { width: 140px; height: 140px; background: var(--bg-secondary); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; border: 4px solid var(--accent-secondary); box-shadow: 0 0 30px rgba(14, 165, 233, 0.3); position: relative; transition: 0.5s; }
.tree-icon { font-size: 4.5rem; transition: 0.5s; }

.streak-card { background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), transparent); border: 1px solid rgba(249, 115, 22, 0.3); border-radius: var(--radius-md); padding: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
.streak-icon-box { width: 50px; height: 50px; background: rgba(249, 115, 22, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #f97316; }

.task-card { background: var(--bg-main); border: 1px solid var(--border-color); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; transition: 0.3s; cursor: pointer; }
.task-card:hover { border-color: var(--accent-secondary); }

/* Certificate */
.cert-btn { margin-top: 20px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 15px; border-radius: var(--radius-sm); font-weight: bold; font-size: 1.1rem; cursor: pointer; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3); }
.cert-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(16, 185, 129, 0.5); }

#certificate-view { text-align: center; padding: 40px; border: 15px double var(--accent-primary); background: #fff; color: #000; display: none; margin-top: 20px; position: relative; }
#certificate-view h1 { font-size: 2.5rem; color: var(--accent-primary); margin-bottom: 10px; font-family: 'Noto Naskh Arabic'; }
#certificate-view .cert-subtitle { font-size: 1.2rem; margin: 10px 0; color: #555; }
#certificate-view .cert-name { font-size: 2.2rem; font-weight: bold; border-bottom: 2px solid #000; display: inline-block; padding: 5px 40px; margin: 20px 0; color: #000; }
#certificate-view .cert-level { font-size: 1.8rem; color: var(--accent-secondary); margin: 20px 0; font-weight:bold; }

/* Responsive */
@media (max-width: 768px) {
    .hero h1 { font-size: 2.2rem; }
    .level-header { flex-direction: column; text-align: center; }
    .header-container { padding: 0 15px; }
    .logo-text { display: none; }
    .btn-group { flex-direction: column; width: 100%; }
    .btn-primary, .btn-outline { width: 100%; justify-content: center; }
    .row-2, .row-3 { grid-template-columns: 1fr; }
}

/* Print Styles */
@media print {
    body * { visibility: hidden; }
    #print-area, #print-area * { visibility: visible; }
    #print-area { position: absolute; left: 0; top: 0; width: 100%; height:100%; display:flex; align-items:center; justify-content:center; }
    .modal-box { box-shadow: none; border: none; background:white; }
    #certificate-view { width:100%; border-width:5px; display:block !important; }
}
</style>
</head>
<body>

<!-- Loader -->
<div id="loading-screen">
    <div class="spinner"></div>
    <h3 style="font-weight: 800; letter-spacing: 1px;">سبل السلام</h3>
    <p style="color: var(--text-secondary); font-size: 0.9rem;">باردکەت...</p>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Navbar -->
<header>
    <div class="container header-container">
        <a href="#" class="logo">
            <i class="fas fa-kaaba logo-icon"></i>
            <span class="logo-text">سبل السلام</span>
        </a>
        <div class="header-actions">
            <div class="points-display"><i class="fas fa-star"></i> <span id="user-points">0</span></div>
            
            <div class="icon-btn" onclick="toggleTheme()" title="گۆڕینا دۆخی (شەڤ/ڕۆژ)">
                <i class="fas fa-adjust"></i>
            </div>
            
            <div class="icon-btn" onclick="openNotifications()">
                <i class="fas fa-bell"></i>
                <div id="notif-dot" class="notification-dot"></div>
            </div>
            <div class="icon-btn" onclick="openProfileModal()">
                <i class="fas fa-user"></i>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="container">
    <div class="hero">
        <h1>گەشتا زانستێ شەرعی</h1>
        <p>پلاتفۆرمەکا ڕێکخستی و مودێرن بۆ فێربوونا بنەمایێن ئیسلامێ. سیستەمەکێ زیرەک بۆ فێربوون، پلان دانان، و چاڤدێرییا پێشکەفتنێ.</p>
        <div class="btn-group">
            <button class="btn-primary" onclick="document.getElementById('levels-container').scrollIntoView()">
‎                دەستپێکە <i class="fas fa-arrow-down"></i>
            </button>
            <button class="btn-outline" onclick="openTutorial()">
                <i class="fas fa-info-circle"></i> چەوا دێ بکار ئینی؟
            </button>
        </div>
    </div>

    <div id="levels-container" class="timeline-container">
        <!-- Levels injected via JS -->
    </div>
</main>

<!-- Main Modal (Courses/Tasks) -->
<div id="main-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <div style="display:flex; flex-direction:column; gap:5px; flex:1;">
                <h3 id="modal-title" style="font-size: 1.4rem;">ناڤونیشان</h3>
                <div id="modal-timer" style="display:none;"></div>
            </div>
            <i class="fas fa-times modal-close" onclick="closeModal()"></i>
        </div>
        <div id="modal-content" class="modal-body"></div>
    </div>
</div>

<!-- Unlock Modal -->
<div id="unlock-modal" class="modal-overlay" style="z-index: 2200;">
    <div class="modal-box" style="max-width: 400px; text-align:center; padding:30px;">
        <i class="fas fa-lock" style="font-size:3rem; color:var(--accent-primary); margin-bottom:20px;"></i>
        <h3>قفلێ ڤەکە</h3>
        <p style="color:var(--text-secondary); margin-bottom:20px;">تکایە کۆدێ (Passcode) داخل بکە:</p>
        <input type="text" id="unlock-code-input" class="form-input" style="text-align:center; font-size:1.5rem; letter-spacing:5px;" placeholder="____" maxlength="4">
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn-primary" style="width:100%; justify-content:center;" onclick="submitUnlockCode()">ڤەکرن</button>
            <button class="btn-outline" style="width:100%; justify-content:center;" onclick="document.getElementById('unlock-modal').classList.remove('open')">پاشگەزبوون</button>
        </div>
    </div>
</div>

<script>
/* --- 1. DATA STRUCTURE --- */
// Placeholder PDF (Single PDF per course)
const PDF_URL_DEMO = "https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf";

const appData = {
    levels: [
        {
            id: 1,
            title: "ئاستێ ئێکێ: بناغە",
            description: "زانستێن سەرەتایی یێن پێتڤی بۆ هەر موسلمانەکێ",
            icon: "fa-seedling",
            courses: [
                { 
                    id: "aqidah_1", title: "عەقیدە", subtitle: "الأصول الثلاثة", icon: "fa-cubes", type: "standard", 
                    duration: "٤ کاتژمێر", lessonCount: 3,
                    pdf: PDF_URL_DEMO, // Unified PDF for this course
                    lessons: [
                        { id: "aq1_1", title: "١. گرنگیا عەقیدێ", text: "ئەو زانستە یە یێ بەحسێ باوەریێ دکەت ب خودێ و پێغەمبەران. بنەمایێ ئایینی ل سەر ڤێ چەندێ ئاڤا دبیت.", video: "https://www.youtube.com/embed/dQw4w9WgXcQ", points: 10 },
                        { id: "aq1_2", title: "٢. بنەمایێ ئێکێ: ناسینا خودێ", text: "فَإِذَا قِيلَ لَكَ: مَنْ رَبُّكَ؟ فَقُلْ: رَبِّيَ اللَّهُ... واتە: ئەگەر ژ تە هاتە پرسیارکرن خودایێ تە کی یە؟ بێژە: خودایێ من ئەوە یێ پەرەردەیا من و هەموو جیهانیان کری.", video: "", points: 10 },
                        { id: "aq1_3", title: "٣. بنەمایێ دووێ: ناسینا ئیسلامێ", text: "الْمَرْتَبَةُ الثَّانِيَةُ: مَعْرِفَةُ دِينِ الْإِسْلَامِ بِالْأَدِلَّةِ... واتە: پلەیا دوویێ ئەوە مرۆڤ ئایینێ ئیسلامێ ب بەڵگەوە بنیاسیت.", video: "", points: 10 }
                    ] 
                },
                { 
                    id: "seerah_1", title: "سیرەت", subtitle: "پوختەیا ژیانا پێغەمبەری ﷺ", icon: "fa-moon", type: "seerah",
                    duration: "٣ کاتژمێر", lessonCount: 2,
                    pdf: PDF_URL_DEMO,
                    lessons: [
                        { id: "sr_1", title: "١. ڕەچەڵەک و ژ دایکبوون", text: "ژ دایک بوویە ل ساڵا فیلێ، ڕۆژا دووشەمبێ... ناڤێ وی: محمد کوڕێ عەبدوللا کوڕێ عەبدولموتەلیب...", video: "", points: 15 },
                        { id: "sr_2", title: "٢. ژیانا زارۆکینی", text: "ل دەف حەلیما سەعدیە مەزن بوو... سینگێ وی هاتە کەلێشکرن دەمێ ل دەف وێ.", video: "", points: 15 }
                    ] 
                }
            ]
        },
        {
            id: 2,
            title: "ئاستێ دووێ: پێشکەفتی",
            description: "قوولبوون د زانستێن شەرعی دا (پێدڤی ب کۆدێ یە)",
            icon: "fa-layer-group",
            courses: [
                 { 
                    id: "aqidah_2", title: "عەقیدە ٢", subtitle: "القواعد الأربعة", icon: "fa-book-quran", type: "standard", 
                    duration: "٦ کاتژمێر", lessonCount: 2,
                    pdf: PDF_URL_DEMO,
                    lessons: [
                        { id: "aq2_1", title: "١. قاعیدەیا ئێکێ", text: "کافرێن قورەیش دان ب تەوحیدا روبوبیەتێ ددنان، بەلێ ئەڤە نەبوو ئەگەرێ موسلمانبوونا وان.", video: "", points: 15 },
                        { id: "aq2_2", title: "٢. قاعیدەیا دووێ", text: "ئەوان دگۆت ئەم پەرستنێ دکەین دا ببنە واستە بۆ مە ل دەف خودێ.", video: "", points: 15 }
                    ]
                }
            ]
        },
        {
            id: 3,
            title: "ئاستێ سێیێ: تایبەتمەند",
            description: "زانستێن ورد (پێدڤیە ئاستێ ٢ تمام بکەی)",
            icon: "fa-graduation-cap",
            courses: [
                 { 
                    id: "hadith_1", title: "فەرموودە", subtitle: "الأربعون النووية", icon: "fa-scroll", type: "standard", 
                    duration: "١٠ کاتژمێر", lessonCount: 1,
                    pdf: PDF_URL_DEMO,
                    lessons: [
                        { id: "hd_1", title: "١. إنما الأعمال بالنيات", text: "واتە هەموو کارەک ب نیتێ یە... هەموو کارەکێ مرۆڤ دکەت ل دیڤ وێ نیتێ دهێتە هەژمارتن یا د دڵێ وی دا.", video: "", points: 20 }
                    ]
                }
            ]
        }
    ]
};

/* --- 2. STATE MANAGEMENT --- */
const State = {
    usersDB: JSON.parse(localStorage.getItem('sabilUsersDB_v10')) || [],
    currentUser: null, 
    pendingUnlockId: null
};

// Start Up
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => document.getElementById('loading-screen').classList.add('fade-out'), 1200);
    
    const savedTheme = localStorage.getItem('sabilTheme');
    if(savedTheme === 'light') document.body.setAttribute('data-theme', 'light');

    const lastUserContact = localStorage.getItem('sabilLastUser_v10');
    if (lastUserContact) {
        const user = State.usersDB.find(u => u.contact === lastUserContact);
        if (user) {
            State.currentUser = user;
            initApp();
            return;
        }
    }
    renderLevels();
});

function initApp() {
    checkStreak();
    renderLevels();
    updatePointsUI();
    checkNotifications(); // Runs logic for alerts (Plan/Tasks)
}

function saveState() {
    if(!State.currentUser) return;
    const idx = State.usersDB.findIndex(u => u.contact === State.currentUser.contact);
    if (idx !== -1) {
        State.usersDB[idx] = State.currentUser;
    } else {
        State.usersDB.push(State.currentUser);
    }
    
    localStorage.setItem('sabilUsersDB_v10', JSON.stringify(State.usersDB));
    localStorage.setItem('sabilLastUser_v10', State.currentUser.contact);
    updatePointsUI();
}

function updatePointsUI() {
    if (State.currentUser) {
        document.getElementById('user-points').innerText = State.currentUser.points;
    } else {
        document.getElementById('user-points').innerText = "0";
    }
}

function toggleTheme() {
    const current = document.body.getAttribute('data-theme');
    const newTheme = current === 'light' ? 'dark' : 'light';
    
    if(newTheme === 'light') document.body.setAttribute('data-theme', 'light');
    else document.body.removeAttribute('data-theme');
    
    localStorage.setItem('sabilTheme', newTheme);
}

/* --- 3. TOAST & ALERTS --- */
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'fa-info-circle';
    if(type === 'warning') icon = 'fa-exclamation-triangle';
    if(type === 'danger') icon = 'fa-times-circle';
    if(type === 'success') icon = 'fa-check-circle';

    toast.innerHTML = `<i class="fas ${icon} toast-icon"></i> <span>${message}</span>`;
    container.appendChild(toast);
    
    // Animate in
    requestAnimationFrame(() => toast.classList.add('show'));
    
    // Remove after 4s
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
    }, 4000);
}

function checkNotifications() {
    if (!State.currentUser) return;
    let hasAlert = false;

    // 1. Plan Progress Alerts (Behind Schedule)
    const now = Date.now();
    for (const [courseId, plan] of Object.entries(State.currentUser.plans)) {
        const diffDays = (now - plan.startDate) / (1000 * 60 * 60 * 24);
        
        // Find Course Data
        let course = null;
        appData.levels.forEach(l => { const c = l.courses.find(x => x.id === courseId); if(c) course = c; });
        
        if (course) {
            const completed = course.lessons.filter(l => State.currentUser.progress[l.id]).length;
            const total = course.lessons.length;
            
            // Expected progress based on time passed (linear)
            const expectedRatio = diffDays / plan.days; 
            const expectedLessons = Math.floor(expectedRatio * total);
            
            // If student is behind by more than 1 lesson and time is not up
            if (completed < expectedLessons && diffDays < plan.days) {
                hasAlert = true;
                setTimeout(() => showToast(`ئاگەهداری! تۆ یێ پاشکەفتی د پلانێ دا بۆ کۆرسێ: ${course.title}`, 'warning'), 1500);
            }
        }
        
        // Ending Soon Alert
        const remaining = plan.days - diffDays;
        if (remaining > 0 && remaining <= 1) {
            hasAlert = true;
        }
    }

    // 2. Daily Tasks Alert (If not done by Evening - simplified logic: check if tasks are empty)
    const tasks = State.currentUser.dailyTasks.tasks;
    const completedTasks = Object.values(tasks).filter(Boolean).length;
    if (completedTasks === 0) {
        setTimeout(() => showToast('بیرئینان: هێشتا تە کارێن ڕۆژانە ئەنجام نەداینە!', 'info'), 3000);
        hasAlert = true;
    }

    const dot = document.getElementById('notif-dot');
    if(hasAlert) dot.classList.add('active');
    else dot.classList.remove('active');
}

/* --- 4. STREAK LOGIC --- */
function checkStreak() {
    if(!State.currentUser) return;
    
    const today = new Date().toDateString();
    const lastLogin = State.currentUser.lastLoginDate;
    
    if (lastLogin !== today) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        
        if (lastLogin === yesterday.toDateString()) {
            State.currentUser.streak = (State.currentUser.streak || 0) + 1;
        } else {
            State.currentUser.streak = 1;
        }
        State.currentUser.lastLoginDate = today;
        State.currentUser.dailyTasks = {
            date: today,
            tasks: { prayer: false, quran: false, dhikr: false, reading: false }
        };
        saveState();
    }
}

/* --- 5. LOGIC: LEVELS & LOCKING --- */
function isLevelUnlocked(levelIndex) {
    if (levelIndex === 0) return true; 
    
    const prevLevel = appData.levels[levelIndex - 1];
    if (!State.currentUser) return false;

    let prevCompleted = true;
    for (let course of prevLevel.courses) {
        for (let lesson of course.lessons) {
            if (!State.currentUser.progress[lesson.id]) {
                prevCompleted = false;
                break;
            }
        }
    }
    if (!prevCompleted) return false; 

    if (appData.levels[levelIndex].id === 2) {
        return State.currentUser.unlockedLevels.includes(2);
    }
    return true; 
}

function checkLevelCompletion(level) {
    if(!State.currentUser) return false;
    let allDone = true;
    level.courses.forEach(c => {
        c.lessons.forEach(l => {
            if(!State.currentUser.progress[l.id]) allDone = false;
        });
    });
    return allDone;
}

function renderLevels() {
    const container = document.getElementById('levels-container');
    container.innerHTML = '';
    
    appData.levels.forEach((level, index) => {
        const unlocked = isLevelUnlocked(index);
        const levelComplete = checkLevelCompletion(level);
        
        const html = `
            <div class="level-card ${!unlocked ? 'locked' : ''}" id="level-${level.id}">
                <div class="level-header" onclick="toggleLevel(${level.id}, ${index}, ${unlocked})">
                    <div class="level-icon-box"><i class="fas ${level.icon}"></i></div>
                    <div class="level-info" style="flex:1;">
                        <h2 style="margin-bottom:5px;">${level.title}</h2>
                        <p style="color:var(--text-secondary);">${level.description}</p>
                    </div>
                    ${levelComplete ? 
                        `<button class="btn-primary" style="padding:8px 15px; font-size:0.9rem;" onclick="event.stopPropagation(); generateLevelCertificate('${level.title}')"><i class="fas fa-certificate"></i> بڕوانامە</button>` 
                        : (!unlocked ? '<i class="fas fa-lock" style="font-size:1.5rem; opacity:0.5;"></i>' : '<i class="fas fa-chevron-down" style="font-size:1.2rem; transition:0.3s;"></i>')
                    }
                </div>
                <div class="level-content">
                    <div class="courses-grid">
                        ${level.courses.map(course => {
                            let completedCount = 0;
                            let progressPercent = 0;
                            let plan = null;
                            
                            if (State.currentUser) {
                                completedCount = course.lessons.filter(l => State.currentUser.progress[l.id]).length;
                                progressPercent = Math.round((completedCount / course.lessons.length) * 100);
                                plan = State.currentUser.plans[course.id];
                            }
                            
                            return `
                                <div class="course-item" onclick="openCourse('${course.id}')">
                                    <div>
                                        <i class="fas ${course.icon} course-icon"></i>
                                        <h4 class="course-title">${course.title}</h4>
                                        <div class="course-subtitle">${course.subtitle}</div>
                                    </div>
                                    <div style="width:100%;">
                                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:var(--text-secondary); margin-bottom:5px;">
                                            <span>پلان: <b style="color:${plan ? 'var(--accent-primary)' : 'inherit'}">${plan ? plan.days + ' ڕۆژ' : 'نەهاتیە دانان'}</b></span>
                                            <span>%${progressPercent}</span>
                                        </div>
                                        <div class="progress-bar"><div class="progress-fill" style="width:${progressPercent}%"></div></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += html;
    });
}

function toggleLevel(id, index, isUnlocked) {
    if (!isUnlocked) {
        if (!State.currentUser) { 
            showToast("پێدڤیە دەسپێکێ تۆماربکەی یان بچیە ژوور.", "warning");
            openProfileModal(); 
            return; 
        }
        
        if(index > 0) {
            const prevLevel = appData.levels[index - 1];
            if(!checkLevelCompletion(prevLevel)) {
                showToast("پێدڤیە ئاستێ بەرێ ب تەمامی (١٠٠٪) خلاس بکەی!", "danger");
                return;
            }
        }

        if (id === 2 && !State.currentUser.unlockedLevels.includes(2)) {
            State.pendingUnlockId = id;
            document.getElementById('unlock-code-input').value = '';
            document.getElementById('unlock-modal').classList.add('open');
            document.getElementById('unlock-code-input').focus();
        }
        return;
    }

    const card = document.getElementById(`level-${id}`);
    card.classList.toggle('active');
    const icon = card.querySelector('.fa-chevron-down');
    if(icon) icon.style.transform = card.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0)';
}

function submitUnlockCode() {
    const code = document.getElementById('unlock-code-input').value;
    if (code === "2024") {
        State.currentUser.unlockedLevels.push(State.pendingUnlockId);
        saveState();
        renderLevels();
        document.getElementById('unlock-modal').classList.remove('open');
        showToast("پیرۆزە! ئاست ڤەبوو.", "success");
    } else {
        showToast("کۆد خەلەتە!", "danger");
    }
}

/* --- 6. LOGIC: COURSES & PLANS (STRICT 24H) --- */
function openCourse(courseId) {
    if(!State.currentUser) {
        openProfileModal();
        return;
    }

    let course = null;
    let levelIndex = -1;
    appData.levels.forEach((l, idx) => {
        const c = l.courses.find(x => x.id === courseId);
        if(c) { course = c; levelIndex = idx; }
    });

    if (!isLevelUnlocked(levelIndex)) {
        showToast("ئەڤ ئاستە هێشتا قفلە!", "warning");
        return;
    }

    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    modalTitle.innerText = course.title;
    
    const hasPlan = !!State.currentUser.plans[courseId];
    if(hasPlan) {
        renderTimer(courseId);
    } else {
        document.getElementById('modal-timer').style.display = 'none';
    }

    modalContent.innerHTML = renderLessonList(course, hasPlan);
    document.getElementById('main-modal').classList.add('open');
}

function renderPlanSelectionId(courseId) {
    let course = null;
    appData.levels.forEach(l => {
        let c = l.courses.find(x => x.id === courseId);
        if(c) course = c;
    });
    const modalContent = document.getElementById('modal-content');
    modalContent.innerHTML = `
        <div style="text-align:center; padding:20px 10px;">
            <h3 style="margin-bottom:10px;">دانانا پلانێ (ئیجباری)</h3>
            <p style="margin-bottom:20px; color:var(--text-secondary);">هەژمارا وانەیان: ${course.lessons.length}</p>
            <div style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap;">
                ${[1, 3, 7, 10].map(d => `
                    <div onclick="selectPlan('${course.id}', ${d})" 
                         style="background:var(--bg-main); border:2px solid var(--border-color); padding:20px; width:100px; border-radius:15px; cursor:pointer;">
                        <span style="font-size:2rem; font-weight:800; display:block; color:var(--accent-secondary);">${d}</span>
                        <span style="font-size:0.9rem; color:var(--text-secondary);">ڕۆژ</span>
                    </div>
                `).join('')}
            </div>
            <button class="btn-outline" onclick="openCourse('${course.id}')" style="margin-top:20px;">پاشگەزبوون</button>
        </div>
    `;
}

function selectPlan(courseId, days) {
    if(!confirm(`تە پلانێ ${days} ڕۆژی هەڵبژارد. ئەرێ تۆ پشتڕاستی؟`)) return;
    
    State.currentUser.plans[courseId] = { 
        days: days, 
        startDate: Date.now()
    };
    saveState();
    openCourse(courseId);
    renderLevels();
    showToast("پلان ب سەرکەفتیانە هاتە دانان", "success");
}

function changePlan(courseId) {
    const plan = State.currentUser.plans[courseId];
    const msPerDay = 24 * 60 * 60 * 1000;
    const timeDiff = Date.now() - plan.startDate;

    // Strict Rule: ONLY allowed within first 24 hours
    if (timeDiff > msPerDay) {
        showToast("بورن، دەمێ گۆڕینا پلانێ ب سەرڤەچوو (تەنێ ٢٤ دەمژمێرێن دەسپێکێ).", "danger");
        return;
    }

    if(confirm("ئەرێ تۆ پشتڕاستی دتەڤێت پلانێ بگۆڕی؟ (تەنێ ل دەسپێکێ ماف هەیە)")) {
        renderPlanSelectionId(courseId);
    }
}

function renderTimer(courseId) {
    const plan = State.currentUser.plans[courseId];
    if(!plan) return;
    
    const diffDays = (Date.now() - plan.startDate) / (1000 * 60 * 60 * 24); 
    const remainingDays = Math.ceil(plan.days - diffDays);
    const modalTimer = document.getElementById('modal-timer');
    
    let timerHTML = '';
    if (remainingDays > 0) {
        timerHTML = `<span style="font-size:0.9rem; color:var(--text-secondary);"><i class="fas fa-clock"></i> ماوە: <b style="color:var(--accent-primary)">${remainingDays} ڕۆژ</b></span>`;
    } else {
        timerHTML = `<span style="font-size:0.9rem; color:var(--danger-color); font-weight:bold;"><i class="fas fa-exclamation-triangle"></i> دەم ب سەرڤەچوو</span>`;
    }
    modalTimer.innerHTML = timerHTML;
    modalTimer.style.display = 'block';
}

function renderLessonList(course, hasPlan) {
    const isSeerah = course.type === 'seerah';
    let completedCount = 0;
    if(State.currentUser) {
        course.lessons.forEach(l => { if(State.currentUser.progress[l.id]) completedCount++; });
    }
    const isCourseCompleted = completedCount === course.lessons.length;
    
    // Check if change is allowed
    let changeAllowed = false;
    if (hasPlan) {
        const msPerDay = 24 * 60 * 60 * 1000;
        if (Date.now() - State.currentUser.plans[course.id].startDate < msPerDay) {
            changeAllowed = true;
        }
    }

    return `
    <div style="animation: fadeIn 0.5s;">
        ${!hasPlan ? `
            <div style="background:rgba(251, 191, 36, 0.1); border:1px solid var(--accent-primary); padding:15px; border-radius:10px; margin-bottom:20px; text-align:center;">
                <p style="margin-bottom:10px; color:var(--accent-primary);">هێشتا تە پلان دانەناتیە. دشێی لیستی ببینی، بەلێ بۆ تۆمارکرنا وانان پێدڤیە پلانێ دابنێی.</p>
                <button class="btn-primary" onclick="renderPlanSelectionId('${course.id}')" style="font-size:0.9rem; padding:8px 20px;">
                    <i class="fas fa-calendar-alt"></i> دانانا پلانێ
                </button>
            </div>
        ` : `
            <div style="text-align:left; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:0.85rem; color:var(--text-secondary); background:var(--bg-main); padding:5px 10px; border-radius:5px; border:1px solid var(--border-color);">
                     ${changeAllowed ? '<i class="fas fa-check-circle" style="color:var(--success-color)"></i> گۆڕین یا بەردەستە' : '<i class="fas fa-lock" style="color:var(--danger-color)"></i> گۆڕین هاتیە گرتن'}
                </span>
                <button onclick="changePlan('${course.id}')" style="background:transparent; border:none; color:${changeAllowed ? 'var(--text-primary)' : 'var(--text-secondary)'}; cursor:${changeAllowed ? 'pointer' : 'not-allowed'}; font-size:0.85rem; opacity:${changeAllowed ? 1 : 0.5}">
                    <i class="fas fa-edit"></i> گۆڕین
                </button>
            </div>
        `}

        ${isCourseCompleted && hasPlan ? `
            <div style="background:linear-gradient(90deg, #10b981, #059669); padding:15px; border-radius:10px; color:white; margin-bottom:20px; text-align:center;">
                <i class="fas fa-check-circle" style="font-size:1.5rem;"></i>
                <h4 style="margin-top:5px;">نایابە! تە ئەڤ کۆرسە تەواو کر.</h4>
            </div>
        ` : ''}

        <div style="display:flex; flex-direction:column; gap:12px;">
        ${course.lessons.map((lesson, idx) => {
            const isCompleted = State.currentUser && State.currentUser.progress[lesson.id];
            
            let isLocked = false;
            if(hasPlan && idx > 0) {
                if(!State.currentUser.progress[course.lessons[idx-1].id]) isLocked = true;
            }
            
            let checkboxAction = "";
            if (!hasPlan) {
                checkboxAction = `showToast('پێدڤیە دەسپێکێ پلانێ دابنێی!', 'warning');`;
            } else if (isLocked) {
                checkboxAction = "";
            } else if (isSeerah) {
                checkboxAction = `showToast('بۆ ڤی بابەتی، فەرە تێبینیان ل خوارێ بنڤیسی.', 'info')`;
            } else {
                checkboxAction = `toggleLesson('${lesson.id}', ${lesson.points}, '${course.id}', ${idx})`;
            }

            // Open Content Action
            let openAction = `openLessonContent('${course.id}', ${idx})`;

            return `
            <div class="lesson-row ${isCompleted ? 'completed' : ''} ${isLocked ? 'locked' : ''}">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:15px; margin-bottom:10px;">
                    <div style="display:flex; align-items:center; gap:15px; flex:1;">
                        <div class="checkbox-custom ${isCompleted ? 'checked' : ''} ${(!hasPlan || isLocked) ? 'disabled' : ''}" 
                            onclick="${checkboxAction}">
                            ${isCompleted ? '<i class="fas fa-check"></i>' : (isSeerah ? '<i class="fas fa-pen" style="font-size:0.8rem; opacity:0.5;"></i>' : '')}
                        </div>
                        <div style="cursor:pointer;" onclick="${openAction}">
                            <h4 style="font-weight:700; font-size:1.05rem;">${lesson.title}</h4>
                            <p style="font-size:0.85rem; color:var(--text-secondary); margin-top:3px;">
                                <i class="fas fa-book-open"></i> وانە &nbsp; <i class="fas fa-video"></i> ڤیدیۆ
                            </p>
                        </div>
                    </div>
                    <button onclick="${openAction}" style="background:var(--accent-secondary); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; box-shadow:0 5px 15px rgba(14,165,233,0.3);">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
                ${(isSeerah && hasPlan && !isLocked) ? `
                <div style="margin-top:10px;">
                     <textarea id="input-${lesson.id}" style="width:100%; min-height:60px; background:var(--bg-main); border:1px solid var(--border-color); color:var(--text-primary); padding:10px; border-radius:8px;" placeholder="تێبینی..." ${isCompleted ? 'disabled' : ''}>${State.currentUser.notes[lesson.id] || ''}</textarea>
                     ${!isCompleted ? `<button class="btn-primary" style="margin-top:5px; width:100%; justify-content:center; padding:5px;" onclick="saveNoteAndComplete('${lesson.id}', ${lesson.points}, '${course.id}', ${idx})">تۆمارکرن</button>` : ''}
                </div>` : ''}
            </div>`;
        }).join('')}
        </div>
    </div>`;
}

function toggleLesson(id, points, courseId, index) {
    let course = null;
    appData.levels.forEach(l => { let c = l.courses.find(x => x.id === courseId); if(c) course = c; });

    if (index > 0) {
        if (!State.currentUser.progress[course.lessons[index-1].id]) {
            showToast("نابت بچیە ڤێ وانەیێ هەتا یا بەری وێ تەمام نەکەی!", "warning");
            return;
        }
    }
    
    if (State.currentUser.progress[id]) {
        if (index + 1 < course.lessons.length) {
            if (State.currentUser.progress[course.lessons[index+1].id]) {
                showToast("نەشێی ڤێ وانێ هەڵبوەشینی چونکی تە وانەیا دویڤدا خلاس کریە.", "warning");
                return;
            }
        }
        delete State.currentUser.progress[id];
        State.currentUser.points -= points;
    } else {
        State.currentUser.progress[id] = true;
        State.currentUser.points += points;
    }
    saveState();
    openCourse(courseId);
    renderLevels();
}

function saveNoteAndComplete(lessonId, points, courseId, index) {
    const text = document.getElementById(`input-${lessonId}`).value.trim();
    if(text.length < 5) { showToast("تکایە تێبینیەکێ بنڤیسە.", "warning"); return; }
    
    State.currentUser.notes[lessonId] = text;
    State.currentUser.progress[lessonId] = true;
    State.currentUser.points += points;
    saveState();
    openCourse(courseId);
    renderLevels();
}

/* --- 7. CONTENT VIEWER (UNIFIED PDF) --- */
function openLessonContent(courseId, lessonIdx) {
    let course = null;
    appData.levels.forEach(l => { let c = l.courses.find(x => x.id === courseId); if(c) course = c; });
    const lesson = course.lessons[lessonIdx];

    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    
    modalTitle.innerText = lesson.title;
    document.getElementById('modal-timer').style.display = 'none';

    // Use Course PDF (Unified), fallback if missing
    const pdfUrl = course.pdf || "about:blank";

    // Build the Content
    modalContent.innerHTML = `
        <div class="lesson-viewer-grid">
            <div>
                ${lesson.video ? `
                <div class="video-wrapper">
                     <iframe src="${lesson.video}" title="Video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
                ` : `<div style="padding:40px; text-align:center; background:var(--bg-main); border:1px solid var(--border-color); border-radius:10px; margin-bottom:20px; color:var(--text-secondary);">ڤیدیۆ نینە</div>`}
                
                <h4 style="margin-bottom:10px; color:var(--accent-secondary);"><i class="fas fa-align-right"></i> مەتنێ وانەیێ</h4>
                <div class="matn-box">
                    ${lesson.text}
                </div>
            </div>
            
            <div>
                 <h4 style="margin-bottom:10px; color:var(--accent-secondary);"><i class="fas fa-file-pdf"></i> پەرتووکا کۆرسی (PDF)</h4>
                 <div class="pdf-wrapper">
                    <iframe src="${pdfUrl}" width="100%" height="100%" style="border:none;"></iframe>
                 </div>
                 <a href="${pdfUrl}" target="_blank" class="btn-outline" style="width:100%; justify-content:center; margin-top:10px;"><i class="fas fa-download"></i> داگرتن PDF</a>
            </div>
        </div>
        <div style="margin-top:20px; text-align:left;">
             <button class="btn-outline" onclick="openCourse('${courseId}')"> <i class="fas fa-arrow-right"></i> زڤڕین بۆ لیستێ</button>
        </div>
    `;
    
    document.getElementById('main-modal').classList.add('open');
}

function generateLevelCertificate(levelTitle) {
    const modalContent = document.getElementById('modal-content');
    const modalTitle = document.getElementById('modal-title');
    document.getElementById('modal-timer').style.display = 'none';
    modalTitle.innerText = "وەرگرتنا بڕوانامێ";
    
    const userName = State.currentUser.name;
    const today = new Date().toLocaleDateString('ku-IQ');
    
    document.getElementById('main-modal').classList.add('open');
    modalContent.innerHTML = `
        <div id="print-area">
            <div id="certificate-view" style="display:block;">
                <i class="fas fa-kaaba" style="font-size:4rem; color:var(--accent-primary); margin-bottom:10px;"></i>
                <h1>بڕوانامەیا ڕێزگرتنێ</h1>
                <p class="cert-subtitle">ئەڤ بڕوانامە پێشکێشە بۆ بەڕێز:</p>
                <div class="cert-name">${userName}</div>
                <p class="cert-subtitle">ژبەر تەواوکرنا سەرکەفتیانە یا:</p>
                <div class="cert-level">${levelTitle}</div>
                <p>ل پلاتفۆرما سبل السلام بۆ زانستێ شەرعی</p>
                <div style="margin-top:40px; display:flex; justify-content:space-between; padding:0 30px; border-top:1px solid #ddd; padding-top:10px;">
                    <span>ڕێکەوت: ${today}</span>
                    <span>واژوو: سبل السلام</span>
                </div>
            </div>
        </div>
        <button class="btn-primary" onclick="window.print()" style="width:100%; margin-top:20px; justify-content:center;">
            <i class="fas fa-print"></i> چاپکرن / PDF
        </button>
    `;
}

/* --- 8. PROFILE, TASKS & NOTIFICATIONS --- */
function openNotifications() { 
    if(!State.currentUser) { openProfileModal(); return; }
    let msgs = [];
    
    // Generate Messages based on Plan
    for (const [courseId, plan] of Object.entries(State.currentUser.plans)) {
        const diffDays = (Date.now() - plan.startDate) / (1000 * 60 * 60 * 24); 
        const remaining = Math.ceil(plan.days - diffDays);
        if(remaining < 3 && remaining >= 0) msgs.push(`ماوەیا کۆرسێ <b>${courseId}</b> تەنێ ${remaining} ڕۆژ ماینە.`);
        if(remaining < 0) msgs.push(`دەمێ کۆرسێ <b>${courseId}</b> ب سەرڤەچوویە.`);
    }

    document.getElementById('main-modal').classList.add('open');
    const modalContent = document.getElementById('modal-content');
    const modalTitle = document.getElementById('modal-title');
    modalTitle.innerText = "ئاگەهدارکرن";
    document.getElementById('modal-timer').style.display = 'none';
    if(msgs.length === 0) modalContent.innerHTML = '<p style="text-align:center; color:var(--text-secondary);">چ ئاگەهدارکرن نینن.</p>';
    else modalContent.innerHTML = msgs.map(m => `<div style="padding:10px; border-bottom:1px solid var(--border-color);">${m}</div>`).join('');
}

function toggleDailyTask(taskKey) {
    if(!State.currentUser.dailyTasks) return;
    State.currentUser.dailyTasks.tasks[taskKey] = !State.currentUser.dailyTasks.tasks[taskKey];
    if(State.currentUser.dailyTasks.tasks[taskKey]) State.currentUser.points += 2;
    else State.currentUser.points -= 2;
    saveState();
    openProfileModal(); 
}

function getTreeStage(percent) {
    if (percent < 5) return { icon: "fa-seedling", color: "#854d0e" };   
    if (percent < 25) return { icon: "fa-seedling", color: "#a3e635" };  
    if (percent < 50) return { icon: "fa-leaf", color: "#4ade80" };  
    if (percent < 80) return { icon: "fa-tree", color: "#16a34a" };  
    return { icon: "fa-tree", color: "#fbbf24" };                    
}

function renderUserProfile(titleElem, contentElem) {
    const percent = calculateTotalPercent();
    const stage = getTreeStage(percent);
    
    if(!State.currentUser.dailyTasks) {
        State.currentUser.dailyTasks = { date: new Date().toDateString(), tasks: { prayer: false, quran: false, dhikr: false, reading: false } };
    }
    const tasks = State.currentUser.dailyTasks.tasks;
    const d = State.currentUser.details || {};

    titleElem.innerText = "پڕۆفایلێ من";
    contentElem.innerHTML = `
        <div style="animation: fadeIn 0.5s;">
            <div class="tree-container">
                <div class="tree-circle" style="border-color:${stage.color}; box-shadow: 0 0 30px ${stage.color}40;">
                    <i class="fas ${stage.icon} tree-icon" style="color:${stage.color};"></i>
                </div>
                <div style="color:var(--text-secondary); margin-bottom:15px;">ڕێژەیا گشتی: <span style="color:var(--accent-primary); font-weight:bold;">%${percent}</span></div>
            </div>
            
            <div class="streak-card">
                <div class="streak-icon-box"><i class="fas fa-fire"></i></div>
                <div>
                    <div style="font-weight:bold; font-size:1.1rem; color:var(--text-primary);">ستریك: ${State.currentUser.streak || 0} ڕۆژ</div>
                    <div style="font-size:0.85rem; color:var(--text-secondary);">بەردەوام بە!</div>
                </div>
            </div>

            <div style="margin-bottom:25px;">
                <h4 style="margin-bottom:10px; color:var(--text-primary);"><i class="fas fa-list-check"></i> کارێن ڕۆژانە</h4>
                <div class="task-card" onclick="toggleDailyTask('prayer')">
                    <span><i class="fas fa-pray" style="color:var(--accent-secondary); width:25px;"></i> نڤێژێن فەرز</span>
                    ${tasks.prayer ? '<i class="fas fa-check-circle" style="color:var(--success-color);"></i>' : '<i class="far fa-circle"></i>'}
                </div>
                <div class="task-card" onclick="toggleDailyTask('quran')">
                    <span><i class="fas fa-book-open" style="color:var(--accent-secondary); width:25px;"></i> خوێندنا قورئانێ</span>
                    ${tasks.quran ? '<i class="fas fa-check-circle" style="color:var(--success-color);"></i>' : '<i class="far fa-circle"></i>'}
                </div>
            </div>

            <div style="background:var(--bg-secondary); padding:20px; border-radius:var(--radius-md); border:1px solid var(--border-color);">
                <h3 style="margin-bottom:15px; border-bottom:1px solid var(--border-color); padding-bottom:10px;">${State.currentUser.name}</h3>
                <div style="font-size:0.9rem; color:var(--text-secondary); display:grid; gap:10px;">
                    <div class="row-2">
                        <p><i class="fas fa-id-card"></i> ${State.currentUser.contact}</p>
                        <p><i class="fab fa-telegram"></i> ${d.telegram || '-'}</p>
                    </div>
                    <div class="row-2">
                        <p><i class="fas fa-map-marker-alt"></i> ${d.province} - ${d.city}</p>
                        <p><i class="fas fa-graduation-cap"></i> ${d.eduLevel || '-'}</p>
                    </div>
                </div>
            </div>

            <button onclick="logout()" class="btn-primary" style="margin-top:30px; width:100%; justify-content:center; background:transparent; border:1px solid var(--danger-color); color:var(--danger-color); box-shadow:none;">
                <i class="fas fa-sign-out-alt"></i> دەرکەفتن
            </button>
        </div>
    `;
}

function calculateTotalPercent() {
    if (!State.currentUser) return 0;
    let totalLessons = 0;
    let completedLessons = 0;
    appData.levels.forEach(level => {
        level.courses.forEach(course => {
            totalLessons += course.lessons.length;
            course.lessons.forEach(lesson => { if(State.currentUser.progress[lesson.id]) completedLessons++; });
        });
    });
    return totalLessons === 0 ? 0 : Math.floor((completedLessons / totalLessons) * 100);
}

function renderAuthForms(titleElem, contentElem) {
    titleElem.innerText = "چوونە ژوور / تۆمارکرن";
    contentElem.innerHTML = `
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchAuthTab('login')">چوونە ژوور</div>
            <div class="auth-tab" onclick="switchAuthTab('register')">تۆمارکرن (نوێ)</div>
        </div>

        <form id="login-form" onsubmit="loginUser(event)" style="animation:fadeIn 0.4s;">
            <div class="form-group">
                <label class="form-label">ئیمێل یان ژمارا موبایلێ</label>
                <input type="text" id="login-id" class="form-input" required placeholder="0750...">
            </div>
            <div class="form-group">
                <label class="form-label">پاسوورد</label>
                <input type="password" id="login-pass" class="form-input" required placeholder="******">
            </div>
            <button type="submit" class="btn-primary" style="width:100%; justify-content:center;">بچۆ ژوور</button>
        </form>

        <form id="register-form" onsubmit="registerUser(event)" style="display:none; animation:fadeIn 0.4s;">
            
            <h4 class="form-section-title">١. زانیاریێن کەسی</h4>
            <div class="form-group">
                <label class="form-label">ناڤێ سیانی (تەواو)</label>
                <input type="text" id="reg-name" class="form-input" required placeholder="ناڤ - باب - باپیر">
            </div>
            <div class="row-2">
                <div class="form-group">
                    <label class="form-label">ساڵا ژ دایکبوونێ</label>
                    <input type="number" id="reg-birth" class="form-input" required placeholder="2000" min="1950" max="2020">
                </div>
                 <div class="form-group">
                    <label class="form-label">ڕەگەز</label>
                    <select id="reg-gender" class="form-input" required>
                        <option value="male">نێر</option>
                        <option value="female">مێ</option>
                    </select>
                </div>
            </div>
             <div class="form-group">
                <label class="form-label">ژمارا موبایلێ (وەک ID دهێتە بکارینان)</label>
                <input type="tel" id="reg-contact" class="form-input" required placeholder="0750..." pattern="[0-9]{11}">
            </div>
             <div class="form-group">
                <label class="form-label">تیلیگرام (ناڤ / ژمارە / لینک)</label>
                <input type="text" id="reg-telegram" class="form-input" placeholder="@username ...">
            </div>

            <h4 class="form-section-title">٢. جهـ و نیشتەجێبوون</h4>
            <div class="row-2">
                 <div class="form-group">
                    <label class="form-label">پارێزگە</label>
                    <select id="reg-province" class="form-input" required>
                        <option value="دهۆک">دهۆک</option>
                        <option value="هەولێر">هەولێر</option>
                        <option value="سلێمانی">سلێمانی</option>
                        <option value="کەرکوک">کەرکوک</option>
                        <option value="هەڵەبجە">هەڵەبجە</option>
                        <option value="نەینەوا">نەینەوا</option>
                        <option value="دی">دی...</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label class="form-label">قەزا / باژێر</label>
                    <input type="text" id="reg-city" class="form-input" required placeholder="نموونە: ئاکرێ">
                </div>
            </div>

            <h4 class="form-section-title">٣. زانیاریێن زانستی</h4>
             <div class="row-2">
                <div class="form-group">
                    <label class="form-label">ئاستێ خواندنێ</label>
                    <select id="reg-edu-level" class="form-input" required>
                        <option value="" disabled selected>هەڵبژێرە...</option>
                        <option value="sereke">سەرەتایی</option>
                        <option value="navendi">ناوەندی</option>
                        <option value="amadeyi_w">ئامادەیی (وێژەیی)</option>
                        <option value="amadeyi_z">ئامادەیی (زانستی)</option>
                        <option value="peymangeh">پەیمانگەهـ</option>
                        <option value="zanko">زانکۆ (بەکالۆریۆس)</option>
                        <option value="master">ماستەر</option>
                        <option value="doctora">دکتۆرا</option>
                        <option value="islamic">خوێندنا ئیسلامی / حوجرە</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label class="form-label">پیشە</label>
                    <select id="reg-role" class="form-input" required>
                        <option value="student">قوتابی</option>
                        <option value="employee">فەرمانبەر</option>
                        <option value="other">کاسب</option>
                        <option value="none">بێ ئیش</option>
                    </select>
                </div>
            </div>

            <div class="form-group" style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:15px;">
                <label class="form-label">پاسوورد (وشەیا نهێنی)</label>
                <input type="password" id="reg-pass" class="form-input" required minlength="4" placeholder="******">
            </div>
            <button type="submit" class="btn-primary" style="width:100%; justify-content:center; margin-top:10px;">دروستکرنا هەژمارێ</button>
        </form>
    `;
}

function switchAuthTab(tab) {
    const tabs = document.querySelectorAll('.auth-tab');
    const loginForm = document.getElementById('login-form');
    const regForm = document.getElementById('register-form');
    if (tab === 'login') {
        tabs[0].classList.add('active'); tabs[1].classList.remove('active');
        loginForm.style.display = 'block'; regForm.style.display = 'none';
    } else {
        tabs[0].classList.remove('active'); tabs[1].classList.add('active');
        loginForm.style.display = 'none'; regForm.style.display = 'block';
    }
}

function registerUser(e) {
    e.preventDefault();
    // Getting values
    const name = document.getElementById('reg-name').value;
    const birthYear = document.getElementById('reg-birth').value;
    const gender = document.getElementById('reg-gender').value;
    const contact = document.getElementById('reg-contact').value;
    const telegram = document.getElementById('reg-telegram').value;
    const province = document.getElementById('reg-province').value;
    const city = document.getElementById('reg-city').value;
    
    const eduSelect = document.getElementById('reg-edu-level');
    const eduLevel = eduSelect.options[eduSelect.selectedIndex].text;
    
    const roleSelect = document.getElementById('reg-role');
    const roleText = roleSelect.options[roleSelect.selectedIndex].text;
    const pass = document.getElementById('reg-pass').value;

    if(State.usersDB.some(u => u.contact === contact)) {
        showToast("ئەڤ ژمارە یان ئیمێلە بەری نوکە هاتیە تۆمارکرن!", "warning");
        return;
    }

    const newUser = { 
        name, contact, pass, 
        details: { 
            birthYear, gender, telegram, province, city, eduLevel, roleText 
        },
        joined: Date.now(),
        lastLoginDate: new Date().toDateString(),
        streak: 1,
        points: 0,
        progress: {}, 
        plans: {},
        unlockedLevels: [1],
        notes: {},
        dailyTasks: { date: new Date().toDateString(), tasks: { prayer: false, quran: false, dhikr: false, reading: false } }
    };
    
    State.usersDB.push(newUser);
    State.currentUser = newUser;
    saveState();
    closeModal();
    initApp();
    showToast("پیرۆزە! هەژمارا تە هاتە دروستکرن.", "success");
}

function loginUser(e) {
    e.preventDefault();
    const id = document.getElementById('login-id').value;
    const pass = document.getElementById('login-pass').value;
    const user = State.usersDB.find(u => u.contact === id && u.pass === pass);

    if(user) {
        State.currentUser = user;
        if(!State.currentUser.unlockedLevels) State.currentUser.unlockedLevels = [1];
        if(!State.currentUser.details) State.currentUser.details = {}; 
        saveState();
        closeModal();
        initApp();
        showToast("بەخێرهاتی!", "success");
    } else {
        showToast("ناڤێ بەکارهێنەری یان پاسوورد خەلەتە!", "danger");
    }
}

function logout() {
    if(confirm('دەرکەفتن ژ بەرنامەی؟')) {
        State.currentUser = null;
        localStorage.removeItem('sabilLastUser_v10');
        location.reload();
    }
}

function openProfileModal() {
    const modalContent = document.getElementById('modal-content');
    const modalTitle = document.getElementById('modal-title');
    document.getElementById('modal-timer').style.display = 'none';
    document.getElementById('main-modal').classList.add('open');

    if (State.currentUser) {
        renderUserProfile(modalTitle, modalContent);
    } else {
        renderAuthForms(modalTitle, modalContent);
    }
}

function closeModal() { document.getElementById('main-modal').classList.remove('open'); }
function openTutorial() {
    document.getElementById('main-modal').classList.add('open');
    document.getElementById('modal-content').innerHTML = '<p style="text-align:center;">لێرە ڤیدیۆیا فێرکاری دێ هێتە دانان...</p>';
}
</script>
</body>
    </html>
