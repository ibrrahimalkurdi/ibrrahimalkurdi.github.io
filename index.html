<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Û•Ø±Ù†Ø§Ù…Û Ø®ÙˆØ§Ù†Ø¯Ù†Ø§ Ù…Ù† (Ù¾ÛØ´Ú©Û•ÙØªÛŒ)</title>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Charting Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rudaw&display=swap');

        :root {
            --bg-color: #f8fafc;
            --card-bg-color: #ffffff;
            --text-color: #0f172a;
            --text-color-light: #64748b;
            --header-bg-color: #ffffff;
            --border-color: #e2e8f0;
            --accent-color: #3b82f6;
            --accent-color-dark: #2563eb;
            --accent-color-light: #eff6ff;
            --progress-bar-success-color: #10b981;
            --button-danger-bg: #ef4444;
            --button-edit-bg: #f59e0b;
            --font-main: 'Rudaw', sans-serif;
            --shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.08), 0 2px 8px -4px rgba(0, 0, 0, 0.05);
        }

        body.dark-mode {
            --bg-color: #020617;
            --card-bg-color: #0f172a;
            --text-color: #e2e8f0;
            --text-color-light: #94a3b8;
            --header-bg-color: #0f172a;
            --border-color: #1e293b;
            --accent-color: #60a5fa;
            --accent-color-dark: #3b82f6;
            --accent-color-light: #1e293b;
            --progress-bar-success-color: #34d399;
            --button-danger-bg: #f87171;
            --button-edit-bg: #fbbf24;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; padding: 1rem; }
        .container { 
            width: 100%; 
            max-width: 800px;
            margin: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 1.5rem;
        }
        .card { background-color: var(--card-bg-color); border-radius: 1rem; box-shadow: var(--shadow); border: 1px solid var(--border-color); padding: 1.5rem; transition: background-color 0.3s, border-color 0.3s; }
        .header-card { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; }
        .header-title h1 { font-size: 1.75rem; } .header-title p { font-size: 0.9rem; color: var(--text-color-light); }
        .header-controls { display: flex; align-items: center; gap: 0.75rem; }
        .icon-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-color-light); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s, color 0.2s, transform 0.2s; }
        .icon-btn svg { width: 20px; height: 20px; stroke-width: 2; }
        .icon-btn:hover { background-color: var(--accent-color); color: white; transform: scale(1.1) rotate(5deg); }
        #theme-toggle-icon::after { content: 'â˜€ï¸'; } body.dark-mode #theme-toggle-icon::after { content: 'ğŸŒ™'; }
        .controls-card { display: flex; justify-content: space-between; align-items: center; }
        .day-navigation { display: flex; gap: 0.5rem; }
        .nav-btn { background-color: var(--accent-color); color: white; border: none; font-family: var(--font-main); height: 40px; padding: 0 1.25rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.9rem; transition: background-color 0.2s, transform 0.2s; }
        .nav-btn:hover { background-color: var(--accent-color-dark); transform: translateY(-2px); }
        .nav-btn.arrow { width: 45px; font-size: 1.1rem; }
        #add-book-section { background-color: var(--accent-color-light); border-left: 5px solid var(--accent-color); transition: all 0.5s ease; overflow: hidden; }
        #add-book-section.hidden { max-height: 0; padding: 0 1.5rem; opacity: 0; border: none; }
        #add-book-section:not(.hidden) { max-height: 800px; padding: 1.5rem; opacity: 1; }
        #add-book-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        #add-book-form input { padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background-color: var(--card-bg-color); color: var(--text-color); font-family: var(--font-main); font-size: 0.9rem; transition: border-color 0.2s, box-shadow 0.2s; }
        #add-book-form input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-color-light); }
        .form-full-width { grid-column: 1 / -1; } .day-selection { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 0.5rem;}
        .day-selection label { display: flex; align-items: center; gap: 0.3rem; background-color: var(--card-bg-color); padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s, border-color 0.2s; font-size: 0.9rem; }
        .day-selection input:checked + span { color: var(--accent-color-dark); font-weight: bold; }
        .day-header { margin-bottom: 1.25rem; } .day-header h2 { font-size: 1.5rem; color: var(--accent-color); margin-bottom: 0.25rem; } .day-header p { font-size: 0.9rem; color: var(--text-color-light); }
        .progress-container { margin-bottom: 1rem; } .progress-label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-color-light); }
        .progress { height: 10px; background-color: var(--border-color); border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--accent-color); width: 0%; transition: width 0.5s ease; border-radius: 5px; }
        .progress-bar.success { background-color: var(--progress-bar-success-color) !important; }
        .tasks-table { width: 100%; border-collapse: collapse; } .tasks-table tr { border-bottom: 1px solid var(--border-color); } .tasks-table tr:last-child { border-bottom: none; }
        .tasks-table td { padding: 1rem 0.5rem; vertical-align: middle; }
        .task-container { display: flex; align-items: center; gap: 1rem; } .task-container input[type="checkbox"] { display: none; }
        .task-container label { cursor: pointer; display: flex; align-items: center; gap: 0.75rem; }
        .task-container .custom-checkbox { width: 20px; height: 20px; border: 2px solid var(--border-color); border-radius: 5px; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s, border-color 0.2s; }
        .task-container .custom-checkbox svg { width: 14px; height: 14px; color: white; transform: scale(0); transition: transform 0.2s; }
        .task-container input[type="checkbox"]:checked + label .custom-checkbox { background-color: var(--accent-color); border-color: var(--accent-color); }
        .task-container input[type="checkbox"]:checked + label .custom-checkbox svg { transform: scale(1); }
        .task-subject { font-weight: bold; font-size: 0.95rem;} .task-description { color: var(--text-color-light); font-size: 0.9rem; }
        .task-type-badge { font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 0.5rem; font-weight: bold; }
        .task-type-badge.memorize { background-color: var(--accent-color-light); color: var(--accent-color-dark); }
        .task-type-badge.review { background-color: #e0f2fe; color: #075985; }
        #overall-progress-container, #achievements-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.25rem; }
        .subject-card { padding: 1.25rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .subject-header { display: flex; justify-content: space-between; align-items: center; }
        .subject-label { font-weight: bold; font-size: 1rem; } .subject-controls { display: flex; gap: 0.5rem; }
        .subject-controls .icon-btn { width: 32px; height: 32px; background-color: var(--bg-color); }
        .subject-controls .icon-btn svg { width: 16px; height: 16px; }
        .subject-controls .icon-btn.delete:hover { background-color: var(--button-danger-bg); }
        .subject-controls .icon-btn.edit:hover { background-color: var(--button-edit-bg); }
        .progress-inputs { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; }
        .subject-card input[type="number"] { width: 55px; padding: 0.4rem; border-radius: 0.375rem; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); text-align: center; }
        .subject-completion-info { font-size: 0.75rem; color: var(--text-color-light); margin-top: 0.5rem; border-top: 1px solid var(--border-color); padding-top: 0.5rem; }
        .timer-controls { display: flex; align-items: center; gap: 0.5rem; }
        .timer-btn { background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .timer-btn svg { width: 16px; height: 16px; } .timer-btn:hover { background-color: var(--accent-color-light); }
        .timer-display { font-size: 0.85rem; color: var(--text-color-light); min-width: 55px; text-align: left; }
        #time-reports { display: flex; justify-content: space-around; text-align: center; }
        #time-reports div p { font-weight: bold; font-size: 1.25rem; color: var(--accent-color); }
        #time-reports div span { font-size: 0.85rem; color: var(--text-color-light); }
        .achievement-item { display: flex; align-items: center; gap: 1rem; background-color: var(--bg-color); padding: 0.75rem; border-radius: 0.5rem; }
        .achievement-item svg { color: var(--progress-bar-success-color); }
        .hidden { display: none !important; }
        #quote-of-the-day { text-align: center; } #quote-of-the-day blockquote { font-size: 1rem; font-style: italic; }
        #quote-of-the-day footer { margin-top: 0.5rem; font-size: 0.9rem; color: var(--accent-color); }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 1000; display: flex; justify-content: center; align-items: center; transition: opacity 0.3s; }
        .spinner { width: 50px; height: 50px; border-radius: 50%; border: 8px solid var(--border-color); border-right-color: var(--accent-color); animation: spinner-d3gkfh 1s infinite linear; }
        @keyframes spinner-d3gkfh { to { transform: rotate(1turn); } }
        
        #contact-us-card { text-align: center; }
        .contact-links-container { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-top: 1rem; }
        .contact-link { display: inline-flex; align-items: center; justify-content: center; gap: 0.75rem; text-decoration: none; background-color: #2AABEE; color: white; padding: 0.65rem 1.25rem; border-radius: 0.5rem; font-family: var(--font-main); transition: background-color 0.2s, transform 0.2s; width: 250px; }
        .contact-link:hover { transform: translateY(-2px); }
        .contact-link.telegram:hover { background-color: #1798D5; }
        .contact-link.instagram { background: #d6249f; background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%,#d6249f 60%,#285AEB 90%); }
        .contact-link.instagram:hover { opacity: 0.9; }
        .contact-link svg { width: 22px; height: 22px; fill: white; }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loader"><div class="spinner"></div></div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 999; display: flex; justify-content: center; align-items: center; padding: 1rem;">
        <div class="card" style="width: 100%; max-width: 400px;">
            <h2 id="auth-title" style="text-align: center;">Ø¯Ø§Ø®Ù„Ø¨ÙˆÙˆÙ†</h2>
            <form id="auth-form" style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
                <input type="email" id="auth-email" placeholder="Ø¦ÛŒÙ…ÛÙ„" required style="font-size: 1rem;">
                <input type="password" id="auth-password" placeholder="Ú˜Ù…Ø§Ø±Ø§ Ù†Ù‡ÛÙ†ÛŒ" required style="font-size: 1rem;">
                <p id="auth-error" style="color: #ef4444; font-size: 0.9rem; text-align: center; min-height: 1.2em;"></p>
                <button type="submit" id="auth-submit-btn" class="nav-btn">Ø¯Ø§Ø®Ù„Ø¨ÙˆÙˆÙ†</button>
                <p style="text-align: center; font-size: 0.9rem;" id="auth-switch-p">
                    Ø­Ø³Ø§Ø¨Û ØªÛ• Ù†ÛŒÙ†Û•ØŸ <a href="#" id="switch-to-signup" style="color: var(--accent-color);">Ø¦ÛÚ©Û Ù†ÙˆÙˆ Ú†ÛÚ©Û•</a>
                </p>
                <a href="#" id="close-modal-btn" style="text-align: center; color: var(--text-color-light); margin-top: 0.5rem; text-decoration: none;">Ù¾Ø§Ø´Ú©Û•Ú¤ØªÙ†</a>
            </form>
        </div>
    </div>

    <div class="container" id="app-container">
        
        <header class="card header-card">
            <div class="header-title">
                <h1>Ø¨Û•Ø±Ù†Ø§Ù…Û Ø®ÙˆØ§Ù†Ø¯Ù†Ø§ Ù…Ù†</h1>
                <p id="current-date-display"></p>
            </div>
            <div class="header-controls">
                <button id="theme-toggle" class="icon-btn" title="Ú¯ÙˆÙ‡Ø§Ø±ØªÙ†Ø§ Ø´ÛÙˆØ§Ø²ÛŒ"><span id="theme-toggle-icon"></span></button>
                <button id="user-profile-btn" class="icon-btn" title="Ù¾Ø±ÙˆÙØ§ÛŒÙ„Û Ù…Ù†"></button>
            </div>
        </header>

        <main id="main-content">
            <div class="card controls-card">
                <div class="day-navigation">
                    <button id="prev-day-btn" class="nav-btn arrow" title="Ø±Û†Ú˜Ø§ Ø¨Û†Ø±ÛŒ">â†’ </button>
                    <button id="next-day-btn" class="nav-btn arrow" title="Ø±Û†Ú˜Ø§ Ø¨Ù‡ÛØª">â†</button>
                </div>
                <button id="toggle-add-book-btn" class="nav-btn" title="Ù¾Û•Ø±ØªÙˆÙˆÚ©Û•Ú©Ø§ Ù†ÙˆÙˆ Ø²ÛØ¯Û• Ø¨Ú©Û•">+ Ø²ÛØ¯Û•Ú©Ø±Ù†Ø§ Ù¾Û•Ø±ØªÙˆÙˆÚ©Û</button>
            </div>

            <div id="add-book-section" class="card hidden">
                <h2 id="form-title">Ù¾Û•Ø±ØªÙˆÙˆÚ©Û•Ú©Ø§ Ù†ÙˆÙˆ Ø²ÛØ¯Û• Ø¨Ú©Û•</h2>
                <form id="add-book-form">
                    <input type="hidden" id="editing-book-id">
                    <input type="text" id="new-book-name" placeholder="Ù†Ø§Ú¤Û Ù¾Û•Ø±ØªÙˆÙˆÚ©Û" required class="form-full-width">
                    <input type="number" id="new-book-total" placeholder="Ú©Û†Ù…Ø§ Ú¯Ø´ØªÛŒ (Ù„Ø§Ù¾Û•Ø±)" required>
                    <input type="number" id="new-book-weeks" placeholder="Ù…Ø§ÙˆÛ Ø¨ Ø­Û•ÙØªÛŒØ§Ù†" required>
                    <div class="form-full-width">
                        <p><strong>Ø±Û†Ú˜ÛÙ† Ú˜Ø¨Û•Ø±Ú©Ø±Ù†Û:</strong></p>
                        <div class="day-selection" id="memorize-days"></div>
                    </div>
                    <div class="form-full-width">
                        <p><strong>Ø±Û†Ú˜ÛÙ† Ù¾ÛØ¯Ø§Ú†ÙˆÙˆÙ†Û:</strong> (Ø¨Û† Ù†Ù…ÙˆÙˆÙ†Û•ØŒ Ù‡Û•Ø± Ø±Û†Ú˜Ø§ Ø¦Û•ÛŒÙ†ÛŒ Ù¾ÛØ¯Ø§Ú†ÙˆÙˆÙ† Ù„Ø³Û•Ø± ÙˆØ§Ù† Ø¨Ø§Ø¨Û•ØªØ§Ù† Ø¨Ú©Û• ÛŒÛÙ† ØªÛ• Ø¯ ÙˆÛ Ø­Û•ÙØªÛŒÛ Ø¯Ø§ Ø®ÙˆØ§Ù†Ø¯ÛŒÙ†)</p>
                        <div class="day-selection" id="review-days"></div>
                    </div>
                    <button type="submit" id="add-book-btn" class="nav-btn form-full-width">Ù¾Û•Ø±ØªÙˆÙˆÚ©Û Ø²ÛØ¯Û• Ø¨Ú©Û•</button>
                </form>
            </div>
            
            <div id="daily-schedule" class="card"></div>
            
            <div class="card">
                <h2>Ø¦Ø§Ù…Ø§Ø±ÛÙ† Ø¯Û•Ù…ÛŒ (ÛŒÛÙ† Ù†Ú¾Ø§)</h2>
                <div id="time-reports">
                    <div><p id="daily-time">00:00:00</p><span>Ø±Û†Ú˜Ø§Ù†Û•</span></div>
                    <div><p id="weekly-time">00:00:00</p><span>Ø­Û•ÙØªÛŒØ§Ù†Û•</span></div>
                    <div><p id="monthly-time">00:00:00</p><span>Ù‡Û•ÛŒÚ¤Ø§Ù†Û•</span></div>
                </div>
            </div>

            <div class="card">
                <h2>Ù¾ÛØ´Ú©Û•ÙØªÙ†Ø§ Ú¯Ø´ØªÛŒ</h2>
                <div id="overall-progress-container"></div>
            </div>
            
            <div id="achievements-card" class="card hidden">
                <h2>Ù¾Û•Ø±ØªÙˆÙˆÚ©ÛÙ† ØªÙ…Ø§Ù…Ú©Ø±ÛŒÙ†</h2>
                <div id="achievements-container"></div>
            </div>

            <div class="card">
                <h2>Ø¦Ø§Ù…Ø§Ø±ÛÙ† Ù¾ÛØ´Ú©Û•ÙØªÙ†Û</h2>
                <div style="height: 300px;"><canvas id="progressChart"></canvas></div>
            </div>
            
            <div id="quote-of-the-day" class="card">
                <blockquote id="quote-text"></blockquote>
                <footer id="quote-author"></footer>
            </div>
            
            <div class="card" id="contact-us-card">
                <h2>Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ø¨ Ù…Û• Ø¨Ú©Û•</h2>
                <p>Ø¨Û† Ù‡Û•Ø± Ú©ÛØ´Û•ÛŒÛ•Ú©Û ÛŒØ§Ù† Ù¾ÛØ´Ù†ÛŒØ§Ø±Û•Ú©Û, Ø¯Ú¯Û•Ù„ Ù…Û• Ø¨Ø§Ø®Ú¤Û•.</p>
                <div class="contact-links-container">
                    <a href="https://t.me/IslamProject" target="_blank" class="contact-link telegram">
                        <svg viewBox="0 0 24 24"><path d="M22 2L11 13L2 9L4 20L22 2Z M22 2L15 22L11 13L22 2Z"></path></svg>
                        <span>Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ú©Ø±Ù† Ø¨ Ø±ÛÛŒØ§ ØªÛŒÙ„ÛŒÚ¯Ø±Ø§Ù…ÛŒ</span>
                    </a>
                    <a href="https://instagram.com/IslamProject" target="_blank" class="contact-link instagram">
                        <svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.584-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.011-3.584.069-4.85c.149-3.225 1.664-4.771 4.919-4.919 1.266-.058 1.644-.07 4.85-.07zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.667.072 4.947c.2 4.358 2.618 6.78 6.98 6.98 1.281.059 1.689.073 4.948.073s3.667-.014 4.947-.072c4.358-.2 6.78-2.618 6.98-6.98.059-1.281.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.2-4.358-2.618-6.78-6.98-6.98-1.281-.059-1.689-.073-4.948-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44 1.441-.645 1.441-1.44-.645-1.44-1.441-1.44z"></path></svg>
                        <span>Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ú©Ø±Ù† Ø¨ Ø±ÛÛŒØ§ Ø¦ÛŒÙ†Ø³ØªÚ¯Ø±Ø§Ù…ÛŒ</span>
                    </a>
                </div>
                <p style="margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-color-light);">Ø¨Û•Ø±Ù‡Û•Ù…Û Ù¾Ú•Û†Ú˜Û•ÛŒ Ø¦ÛŒØ³Ù„Ø§Ù…</p>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- STATE VARIABLES ---
        let allTasks = []; let overallSubjects = []; let progressHistory = [];
        let viewDate = new Date(); let chartInstance = null; let timerIntervals = {};
        let currentUser = null;
        
        // --- ICONS ---
        const CHECK_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
        const EDIT_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>`;
        const DELETE_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`;
        const PLAY_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`;
        const PAUSE_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`;
        const TROPHY_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M9 12H4a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h5"/><path d="M15 12h5a2 2 0 0 1 2 2v3c0 1.1-.9 2-2 2h-5"/><path d="M12 15V2.25A2.25 2.25 0 0 0 9.75 0h-3.5A2.25 2.25 0 0 0 4 2.25V15"/><path d="M12 15V2.25A2.25 2.25 0 0 1 14.25 0h3.5A2.25 2.25 0 0 1 20 2.25V15"/></svg>`;
        const USER_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`;
        const LOGOUT_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`;

        // --- CONSTANTS ---
        const DAY_NAMES = ["Ø¦ÛÚ© Ø´Û•Ù…Ø¨ÛŒ", "Ø¯ÙˆÙˆØ´Û•Ù…Ø¨ÛŒ", "Ø³Û Ø´Û•Ù…Ø¨ÛŒ", "Ú†Ø§Ø±Ø´Û•Ù…Ø¨ÛŒ", "Ù¾ÛÙ†Ø¬ Ø´Û•Ù…Ø¨ÛŒ", "Ø¦Û•ÛŒÙ†ÛŒ", "Ø´Û•Ù…Ø¨ÛŒ"];

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyC1D4aXKVIQndRGSZnAa5A_4b42VN8MX6s",
			  authDomain: "mala-jalil.firebaseapp.com",
			  projectId: "mala-jalil",
			  storageBucket: "mala-jalil.firebasestorage.app",
			  messagingSenderId: "934631314678",
			  appId: "1:934631314678:web:839ae0bda0a193eca408d7",
			  measurementId: "G-PZ9D19KX7B"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- AUTH & UI FUNCTIONS ---
        function showLoader() { document.getElementById('loader').classList.remove('hidden'); document.getElementById('loader').style.opacity = '1'; }
        function hideLoader() { document.getElementById('loader').style.opacity = '0'; setTimeout(() => document.getElementById('loader').classList.add('hidden'), 300); }

        function setupAuthListeners() {
            auth.onAuthStateChanged(user => {
                Object.values(timerIntervals).forEach(clearInterval);
                timerIntervals = {};

                if (user) {
                    currentUser = user;
                    document.getElementById('user-profile-btn').innerHTML = LOGOUT_ICON;
                    document.getElementById('user-profile-btn').title = "Ø¯Û•Ø±Ú©Û•ÙØªÙ†";
                    loadStateFromFirestore();
                } else {
                    currentUser = null;
                    document.getElementById('user-profile-btn').innerHTML = USER_ICON;
                    document.getElementById('user-profile-btn').title = "Ø¯Ø§Ø®Ù„Ø¨ÙˆÙˆÙ†";
                    loadStateFromLocalStorage();
                }
            });
        }
        
        function handleAuthFormSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const isSignUp = document.getElementById('auth-title').textContent.includes("Ù†ÙˆÙˆ");
            const errorP = document.getElementById('auth-error');
            errorP.textContent = '';

            const action = isSignUp 
                ? auth.createUserWithEmailAndPassword(email, password)
                : auth.signInWithEmailAndPassword(email, password);
            
            action
                .then(() => {
                    document.getElementById('auth-modal').classList.add('hidden');
                    document.getElementById('auth-form').reset();
                })
                .catch(() => { 
                    errorP.textContent = "Ø¦ÛŒÙ…ÛÙ„ ÛŒØ§Ù† Ú˜Ù…Ø§Ø±Ø§ Ù†Ù‡ÛÙ†ÛŒ ÛŒØ§ Ø¯Ø±ÙˆØ³Øª Ù†ÛŒÙ†Û•.";
                });
        }

        function signOutUser() {
            auth.signOut().catch(error => console.error("Sign out error", error));
        }

        // --- STORAGE FUNCTIONS ---
        function saveData() {
            if (currentUser) {
                saveStateToFirestore();
            } else {
                saveStateToLocalStorage();
            }
        }

        let saveTimeout;
        function saveStateToFirestore() {
            if (!currentUser) return;
            
            const tasksToSave = allTasks.map(t => ({ ...t, isTimerRunning: false }));

            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                const dataToSave = {
                    allTasks: tasksToSave,
                    overallSubjects,
                    progressHistory,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                try {
                    await db.collection('userSchedules').doc(currentUser.uid).set(dataToSave, { merge: true });
                } catch (error) {
                    console.error("Error saving data to Firestore: ", error);
                }
            }, 1500);
        }

        async function loadStateFromFirestore() {
            if (!currentUser) return;
            const docRef = db.collection('userSchedules').doc(currentUser.uid);
            try {
                const doc = await docRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    allTasks = data.allTasks || [];
                    allTasks.forEach(t => { t.elapsedTime = t.elapsedTime || 0; t.isTimerRunning = false; });
                    overallSubjects = data.overallSubjects || [];
                    progressHistory = data.progressHistory || [];
                } else {
                    allTasks = []; overallSubjects = []; progressHistory = [];
                }
            } catch (error) {
                console.error("Error loading data from Firestore: ", error);
                allTasks = []; overallSubjects = []; progressHistory = [];
            }
            renderAll();
            hideLoader();
        }

        function saveStateToLocalStorage() {
            try {
                const tasksToSave = allTasks.map(t => ({ ...t, isTimerRunning: false }));
                localStorage.setItem('studySchedule_srs_local', JSON.stringify({ allTasks: tasksToSave, overallSubjects, progressHistory }));
            } catch (e) {
                console.error("Error saving to localStorage", e);
            }
        }

        function loadStateFromLocalStorage() {
            const savedState = JSON.parse(localStorage.getItem('studySchedule_srs_local'));
            if (savedState) {
                allTasks = savedState.allTasks || [];
                allTasks.forEach(t => { t.elapsedTime = t.elapsedTime || 0; t.isTimerRunning = false; });
                overallSubjects = savedState.overallSubjects || [];
                progressHistory = savedState.progressHistory || [];
            } else {
                allTasks = []; overallSubjects = []; progressHistory = [];
            }
            renderAll();
            hideLoader(); //  <-- Ú¯ÙˆÙ‡Ø§Ø±ØªÙ†Ø§ Ú¯Ø±Ù†Ú¯ 1: Ú†Ø§Ø±Û•Ø³Û•Ø±Ú©Ø±Ù†Ø§ Ú©ÛØ´Û•ÛŒØ§ Ø¨Ø§Ø±Ú©Ø±Ù†Û
        }

        // --- HELPER FUNCTIONS ---
        function toISODateString(date) { return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0]; }
        
        function toNumericDateString(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function formatRemainingTime(days) {
            if (days < 0) return "(Ø¯Û•Ù… Ø¨Û†Ø±ÛŒÛ•)";
            if (days === 0) return "(Ø¯Û•Ù…Û ÙˆÛ Ø¦Û•Ú¤Ø±Û†ÛŒÛ•)";
            
            const months = Math.floor(days / 30);
            const weeks = Math.floor((days % 30) / 7);
            const remainingDays = days % 7;

            let parts = [];
            if (months > 0) parts.push(`${months} Ù‡Û•ÛŒÚ¤`);
            if (weeks > 0) parts.push(`${weeks} Ø­Û•ÙØªÛŒ`);
            if (remainingDays > 0) parts.push(`${remainingDays} Ø±Û†Ú˜`);

            return `(Ù…Ø§ÛŒÛ•: ${parts.join(' Ùˆ ')})`;
        }
        
        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderCurrentDayView();
            renderProgressAndAchievements();
            renderTimeReports();
            renderProgressChart();
        }

        function renderCurrentDayView() {
            const todayStr = toISODateString(viewDate);
            const dayOfWeek = DAY_NAMES[viewDate.getDay()];
            const tasksForToday = allTasks.filter(task => task.date === todayStr);
            const timeForThisDay = tasksForToday.reduce((sum, t) => sum + (t.elapsedTime || 0), 0);

            let tasksHtml;
            if (currentUser) {
                tasksHtml = tasksForToday.length > 0 ? tasksForToday.map(task => `
                    <tr>
                        <td>
                            <div class="task-container">
                                <input type="checkbox" id="task-${task.id}" data-task-id="${task.id}" ${task.isComplete ? 'checked' : ''}>
                                <label for="task-${task.id}">
                                    <span class="custom-checkbox">${CHECK_ICON}</span>
                                    <span class="task-subject">${task.bookName}</span>
                                </label>
                            </div>
                        </td>
                        <td class="task-description">${task.description}</td>
                        <td><span class="task-type-badge ${task.type}">${task.type === 'memorize' ? 'Ú˜Ø¨Û•Ø±Ú©Ø±Ù†' : 'Ù¾ÛØ¯Ø§Ú†ÙˆÙˆÙ†'}</span></td>
                        <td>
                            <div class="timer-controls">
                                <button class="timer-btn" data-task-id="${task.id}" title="Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ù†/Ø±Ø§ÙˆÛ•Ø³ØªØ§Ù†Ø¯Ù†">${task.isTimerRunning ? PAUSE_ICON : PLAY_ICON}</button>
                                <span class="timer-display" id="timer-${task.id}">${formatTime(task.elapsedTime || 0)}</span>
                            </div>
                        </td>
                    </tr>`).join('') : `<tr><td colspan="4" style="text-align:center; padding: 1.5rem;">Ù‡ÛŒÚ† Ú©Ø§Ø±Û•Ú© Ø¨Û† Ø¦Û•Ú¤Ø±Û† Ù†ÛŒÙ†Û•.</td></tr>`;
            } else {
                 tasksHtml = `<tr><td colspan="4" style="text-align:center; padding: 2.5rem;">Ø¨Û† Ø¯ÛŒØªÙ†Ø§ Ú©Ø§Ø±ÛÙ† Ø®Û† Ùˆ Ù¾Ø§Ø±Ø§Ø³ØªÙ†Ø§ Ù¾ÛØ´Ú©Û•ÙØªÙ†Û, ØªÚ©Ø§ÛŒÛ• Ø¯Ø§Ø®Ù„ Ø¨Ø¨Û•.</td></tr>`;
            }

            const completed = tasksForToday.filter(t => t.isComplete).length;
            const percentage = tasksForToday.length > 0 ? Math.round((completed / tasksForToday.length) * 100) : 0;
            
            document.getElementById('daily-schedule').innerHTML = `
                <div class="day-header">
                    <h2>${dayOfWeek}</h2>
                    <p>Ø¯Û•Ù…Ø§ Ø®ÙˆØ§Ù†Ø¯Ù†Ø§ Ú¤Û Ø±Û†Ú˜Û: ${formatTime(timeForThisDay)}</p>
                </div>
                <div class="progress-container">
                    <div class="progress-label">Ù¾ÛØ´Ú©Û•ÙØªÙ†Ø§ Ø¦Û•Ú¤Ø±Û†: ${completed}/${tasksForToday.length}</div>
                    <div class="progress"><div class="progress-bar ${percentage === 100 ? 'success' : ''}" style="width: ${percentage}%;"></div></div>
                </div>
                <table class="tasks-table"><tbody>${tasksHtml}</tbody></table>`;
            document.getElementById('current-date-display').textContent = toNumericDateString(viewDate);
        }
        
        function renderProgressAndAchievements() {
            const progressContainer = document.getElementById('overall-progress-container');
            const achievementsContainer = document.getElementById('achievements-container');
            const achievementsCard = document.getElementById('achievements-card');
            
            progressContainer.innerHTML = '';
            achievementsContainer.innerHTML = '';
            let completedCount = 0;

            if (!currentUser) {
                progressContainer.innerHTML = '<p style="text-align:center; width:100%;">Ø¨Û† Ø¯ÛŒØªÙ†Ø§ Ù¾ÛØ´Ú©Û•ÙØªÙ†Ø§ Ú¯Ø´ØªÛŒ, ØªÚ©Ø§ÛŒÛ• Ø¯Ø§Ø®Ù„ Ø¨Ø¨Û•.</p>';
                achievementsCard.classList.add('hidden');
                return;
            }

            overallSubjects.forEach(subject => {
                const percentage = subject.total > 0 ? Math.min(100, (subject.current / subject.total) * 100) : 0;
                
                const lastTask = allTasks.filter(t => t.bookId === subject.id && t.type === 'memorize').sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                let completionHTML = '';
                if (lastTask) {
                    const completionDate = new Date(lastTask.date);
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const remainingDays = Math.ceil((completionDate - today) / (1000 * 60 * 60 * 24));
                    const completionDateStr = toNumericDateString(completionDate);
                    const completionMessage = formatRemainingTime(remainingDays);
                    
                    completionHTML = `<div class="subject-completion-info"><span>Ø±Û†Ú˜Ø§ ØªÙ…Ø§Ù…Ø¨ÙˆÙˆÙ†Û: ${completionDateStr} ${percentage < 100 ? completionMessage : '(ØªÙ…Ø§Ù… Ø¨ÙˆÙˆÛŒÛ•)'}</span></div>`;
                }

                if (percentage >= 100) {
                    completedCount++;
                    achievementsContainer.innerHTML += `<div class="achievement-item">${TROPHY_ICON}<span>${subject.name}</span></div>`;
                } else {
                    progressContainer.innerHTML += `
                        <div class="card subject-card">
                            <div class="subject-header">
                                <span class="subject-label">${subject.name}</span>
                                <div class="subject-controls">
                                    <button class="icon-btn edit edit-book-btn" data-book-id="${subject.id}" title="Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ">${EDIT_ICON}</button>
                                    <button class="icon-btn delete delete-book-btn" data-book-id="${subject.id}" title="Ú˜ÛØ¨Ø±Ù†">${DELETE_ICON}</button>
                                </div>
                            </div>
                            <div class="progress-inputs">
                                <span>ØªÙ…Ø§Ù… Ú©Ø±ÛŒÙ†Û•:</span>
                                <input type="number" class="subject-progress-current" data-book-id="${subject.id}" value="${subject.current}" min="0">
                                <span>Ú˜ Ú©Û†Ù…Ø§:</span><span>${subject.total}</span>
                            </div>
                            <div class="progress"><div class="progress-bar" style="width: ${percentage}%;"></div></div>
                            ${completionHTML}
                        </div>`;
                }
            });

            achievementsCard.classList.toggle('hidden', completedCount === 0);
        }
        
        function renderTimeReports() {
            const now = new Date();
            const todayStr = toISODateString(now);
            const dailySeconds = allTasks.filter(t => t.date === todayStr).reduce((sum, t) => sum + (t.elapsedTime || 0), 0);
            
            const startOfWeek = new Date(now);
            startOfWeek.setDate(startOfWeek.getDate() - now.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            const weeklySeconds = allTasks.filter(t => t.date >= toISODateString(startOfWeek) && t.date <= toISODateString(endOfWeek))
                                     .reduce((sum, t) => sum + (t.elapsedTime || 0), 0);
            
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const monthlySeconds = allTasks.filter(t => t.date >= toISODateString(startOfMonth) && t.date <= toISODateString(endOfMonth))
                                       .reduce((sum, t) => sum + (t.elapsedTime || 0), 0);

            document.getElementById('daily-time').textContent = formatTime(dailySeconds);
            document.getElementById('weekly-time').textContent = formatTime(weeklySeconds);
            document.getElementById('monthly-time').textContent = formatTime(monthlySeconds);
        }

        function renderProgressChart() { /* ... unchanged ... */ }
        
        // --- EVENT HANDLERS ---
        function setupEventListeners() {
            document.getElementById('add-book-form').addEventListener('submit', handleAddOrEditBook);
            document.body.addEventListener('click', handleBodyClick);
            document.body.addEventListener('change', handleBodyChange);
            document.body.addEventListener('input', handleBodyInput);
            document.getElementById('auth-form').addEventListener('submit', handleAuthFormSubmit);
        }

        function handleBodyClick(e) {
            const closest = selector => e.target.closest(selector);
            const target = closest('#theme-toggle, #next-day-btn, #prev-day-btn, #toggle-add-book-btn, .delete-book-btn, .edit-book-btn, .timer-btn, #user-profile-btn, #close-modal-btn, #switch-to-signup, #switch-to-login');
            if (!target) return;

            switch(target.id) {
                case 'theme-toggle':
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                    break;
                case 'next-day-btn':
                    viewDate.setDate(viewDate.getDate() + 1);
                    renderAll();
                    break;
                case 'prev-day-btn':
                    viewDate.setDate(viewDate.getDate() - 1);
                    renderAll();
                    break;
                case 'toggle-add-book-btn':
                    resetForm();
                    document.getElementById('add-book-section').classList.toggle('hidden');
                    break;
                case 'user-profile-btn':
                    if (currentUser) {
                        if (confirm("ØªÙˆ Ù¾Ø´ØªØ±Ø§Ø³ØªÛŒ Ø¯Ø®ÙˆØ§Ø²ÛŒ Ú˜ Ø­Ø³Ø§Ø¨Ø§ Ø®Û† Ø¯Û•Ø±Ú©Û•Ú¤ÛŒØŸ")) signOutUser();
                    } else {
                        document.getElementById('auth-modal').classList.remove('hidden');
                    }
                    break;
                case 'close-modal-btn':
                    e.preventDefault();
                    document.getElementById('auth-modal').classList.add('hidden');
                    break;
                case 'switch-to-signup':
                case 'switch-to-login':
                     e.preventDefault();
                     const isLogin = target.id === 'switch-to-login';
                     document.getElementById('auth-title').textContent = isLogin ? "Ø¯Ø§Ø®Ù„Ø¨ÙˆÙˆÙ†" : "Ø­Ø³Ø§Ø¨Û•Ú©Ø§ Ù†ÙˆÙˆ Ú†ÛÚ©Û•";
                     document.getElementById('auth-submit-btn').textContent = isLogin ? "Ø¯Ø§Ø®Ù„Ø¨ÙˆÙˆÙ†" : "Ú†ÛÚ©Ø±Ù†";
                     document.getElementById('auth-switch-p').innerHTML = isLogin 
                        ? `Ø­Ø³Ø§Ø¨Û ØªÛ• Ù†ÛŒÙ†Û•ØŸ <a href="#" id="switch-to-signup" style="color: var(--accent-color);">Ø¦ÛÚ©Û Ù†ÙˆÙˆ Ú†ÛÚ©Û•</a>`
                        : `Ø­Ø³Ø§Ø¨Û ØªÛ• Ù‡Û•ÛŒÛ•ØŸ <a href="#" id="switch-to-login" style="color: var(--accent-color);">Ø¯Ø§Ø®Ù„ Ø¨Ø¨Û•</a>`;
                     document.getElementById('auth-error').textContent = '';
                     break;
                default:
                    if (target.matches('.delete-book-btn')) deleteBook(target.dataset.bookId);
                    else if (target.matches('.edit-book-btn')) openEditForm(target.dataset.bookId);
                    else if (target.matches('.timer-btn')) toggleTimer(target.dataset.taskId);
            }
        }

        function handleBodyChange(e) {
            if (e.target.matches('input[type="checkbox"][data-task-id]')) {
                const task = allTasks.find(t => t.id == e.target.dataset.taskId);
                if (!task) return;
                task.isComplete = e.target.checked;
                const subject = overallSubjects.find(s => s.id === task.bookId);
                if (subject && task.type === 'memorize') { // Only update progress for memorization tasks
                    const unitValue = parseInt(task.units);
                    subject.current = Math.max(0, task.isComplete ? subject.current + unitValue : subject.current - unitValue);
                }
                renderAll(); saveData();
            }
        }
        
        function handleBodyInput(e) {
            if (e.target.matches('.subject-progress-current')) {
                const bookId = e.target.dataset.bookId;
                const subject = overallSubjects.find(s => s.id === bookId);
                if (subject) { subject.current = parseInt(e.target.value) || 0; renderAll(); saveData(); }
            }
        }
        
        function toggleTimer(taskId) {
            const task = allTasks.find(t => t.id == taskId);
            if (!task) return;

            task.isTimerRunning = !task.isTimerRunning;
            
            const timerBtn = document.querySelector(`.timer-btn[data-task-id='${taskId}']`);
            if (timerBtn) timerBtn.innerHTML = task.isTimerRunning ? PAUSE_ICON : PLAY_ICON;

            if (task.isTimerRunning) {
                timerIntervals[taskId] = setInterval(() => {
                    task.elapsedTime = (task.elapsedTime || 0) + 1;
                    document.getElementById(`timer-${taskId}`).textContent = formatTime(task.elapsedTime);

                    if (task.elapsedTime % 15 === 0) { saveData(); }
                }, 1000);
            } else {
                clearInterval(timerIntervals[taskId]);
                delete timerIntervals[taskId];
                renderTimeReports();
                saveData();
            }
        }
        
        // --- CORE LOGIC FUNCTIONS ---
        function handleAddOrEditBook(e) {
            e.preventDefault();
            const name = document.getElementById('new-book-name').value.trim();
            const total = parseInt(document.getElementById('new-book-total').value);
            const weeks = parseInt(document.getElementById('new-book-weeks').value);
            const memorizeDays = Array.from(document.querySelectorAll('#memorize-days input:checked')).map(cb => parseInt(cb.value));
            const reviewDays = Array.from(document.querySelectorAll('#review-days input:checked')).map(cb => parseInt(cb.value));
            const editingBookId = document.getElementById('editing-book-id').value;

            if (!name || isNaN(total) || total <= 0 || isNaN(weeks) || weeks <= 0 || memorizeDays.length === 0) {
                alert("ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÛŒ Ø®Ø§Ù†Û•ÛŒØ§Ù† Ø¨ Ø¯Ø±ÙˆØ³ØªÛŒ Ù¾Ú• Ø¨Ú©Û• Ùˆ Ù„ Ú©ÛÙ… Ø±Û†Ú˜Û•Ú©Û Ø¨Û† Ú˜Ø¨Û•Ø±Ú©Ø±Ù†Û Ø¯Û•Ø³ØªÙ†ÛŒØ´Ø§Ù† Ø¨Ú©Û•."); return;
            }
            
            if (editingBookId) {
                allTasks = allTasks.filter(task => task.bookId !== editingBookId);
                overallSubjects = overallSubjects.filter(subject => subject.id !== editingBookId);
            }

            const bookId = editingBookId || name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase() + Date.now();
            
            let tempDate = new Date();
            let totalSessions = 0;
            for (let i = 0; i < weeks * 7; i++) {
                if (memorizeDays.includes(tempDate.getDay())) {
                    totalSessions++;
                }
                tempDate.setDate(tempDate.getDate() + 1);
            }

            if (totalSessions === 0) { 
                alert("Ù‡ÛŒÚ† Ø±Û†Ú˜Û•Ú©Ø§ Ú˜Ø¨Û•Ø±Ú©Ø±Ù†Û Ø¯ Ù…Ø§ÙˆÛ Ø¯Û•Ø³ØªÙ†ÛŒØ´Ø§Ù†Ú©Ø±ÛŒ Ø¯Ø§ Ù†Û•Ù‡Ø§ØªÛ• Ø¯ÛŒØªÙ†!");
                return;
             }

            const basePagesPerSession = Math.floor(total / totalSessions);
            let extraPages = total % totalSessions;

            let currentDate = new Date();
            for (let i = 0; i < weeks * 7; i++) {
                // Add Memorization Task
                if (memorizeDays.includes(currentDate.getDay())) {
                    let pagesForThisSession = basePagesPerSession;
                    if (extraPages > 0) {
                        pagesForThisSession++;
                        extraPages--;
                    }
                    
                    if (pagesForThisSession > 0) {
                        allTasks.push({
                            id: Date.now() + i, bookId, bookName: name, date: toISODateString(currentDate),
                            type: 'memorize', description: `Ú˜Ø¨Û•Ø±Ú©Ø±Ù†Ø§ ${pagesForThisSession} Ù„Ø§Ù¾Û•Ø±`,
                            units: pagesForThisSession, isComplete: false, elapsedTime: 0, isTimerRunning: false
                        });
                    }
                }
                
                // Add Review Task
                if (reviewDays.includes(currentDate.getDay())) {
                     allTasks.push({
                        id: Date.now() + i + 500000, // Offset ID to avoid collision
                        bookId, bookName: name, date: toISODateString(currentDate),
                        type: 'review', description: `Ù¾ÛØ¯Ø§Ú†ÙˆÙˆÙ†Ø§ Ø¨Ø§Ø¨Û•ØªÛÙ† Ú¤Û Ø­Û•ÙØªÛŒÛ`,
                        units: 0, isComplete: false, elapsedTime: 0, isTimerRunning: false
                    });
                }

                currentDate.setDate(currentDate.getDate() + 1);
            }

            overallSubjects.push({ id: bookId, name, total, current: 0 });
            resetForm();
            document.getElementById('add-book-section').classList.add('hidden');
            renderAll(); saveData();
        }

        function deleteBook(bookId) {
            if (confirm("ØªÙˆ Ù¾Ø´ØªØ±Ø§Ø³ØªÛŒ Ø¯Ø®ÙˆØ§Ø²ÛŒ Ú¤ÛŒ Ø¨Ø§Ø¨Û•ØªÛŒ Ùˆ Ù‡Û•Ù…ÛŒ Ú©Ø§Ø±ÛÙ† Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒØ¯Ø§Ø± Ù¾ÛÚ¤Û• Ú˜Û Ø¨Ø¨Û•ÛŒØŸ")) {
                allTasks = allTasks.filter(task => task.bookId !== bookId);
                overallSubjects = overallSubjects.filter(subject => subject.id !== bookId);
                renderAll();
                saveData();
            }
        }
        
        function openEditForm(bookId) {
            const subject = overallSubjects.find(s => s.id === bookId);
            if (!subject) return;

            document.getElementById('form-title').textContent = "Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒÚ©Ø±Ù†Ø§ Ù¾Û•Ø±ØªÙˆÙˆÚ©Û";
            document.getElementById('add-book-btn').textContent = "Ú¯ÙˆÙ‡Ø§Ø±ØªÙ†Ø§Ù† Ø¨Ù¾Ø§Ø±ÛØ²Û•";
            
            document.getElementById('editing-book-id').value = subject.id;
            document.getElementById('new-book-name').value = subject.name;
            document.getElementById('new-book-total').value = subject.total;
            document.getElementById('new-book-weeks').value = ''; // User should re-enter weeks
            
            document.querySelectorAll('#memorize-days input:checked').forEach(cb => cb.checked = false);
            document.querySelectorAll('#review-days input:checked').forEach(cb => cb.checked = false);
            document.getElementById('add-book-section').classList.remove('hidden');
        }

        function resetForm() {
            document.getElementById('form-title').textContent = "Ù¾Û•Ø±ØªÙˆÙˆÚ©Û•Ú©Ø§ Ù†ÙˆÙˆ Ø²ÛØ¯Û• Ø¨Ú©Û•";
            document.getElementById('add-book-btn').textContent = "Ù¾Û•Ø±ØªÙˆÙˆÚ©Û Ø²ÛØ¯Û• Ø¨Ú©Û•";
            document.getElementById('add-book-form').reset();
            document.getElementById('editing-book-id').value = '';
        }
        
        // --- APP INITIALIZATION ---
        function initApp() {
            showLoader();
            // Ú¯ÙˆÙ‡Ø§Ø±ØªÙ†Ø§ Ú¯Ø±Ù†Ú¯ 2: Ø¯Ø§Ù†Ø§Ù†Ø§ Ø´ÛÙˆØ§Ø²Û ØªØ§Ø±ÛŒ ÙˆÛ•Ú© Ø¨Ù†Û•Ø±Û•Øª
            if (localStorage.getItem('theme') !== 'light') {
                document.body.classList.add('dark-mode');
            }

            const quotes = [{ text: "Ø²Ø§Ù†Ø³Øª Ù†ÙˆØ±Û•ØŒ Ùˆ Ù†ÙˆØ±Ø§ Ø®ÙˆØ¯Û Ù†Ø§Ø¯Ø±ÛØªÛ• Ú¯ÙˆÙ†Û•Ù‡Ú©Ø§Ø±Û•Ú©ÛŒ.", author: "Ø¦ÛŒÙ…Ø§Ù…Û Ø´Ø§ÙØ¹ÛŒ" }, { text: "ÛŒÛ Ú˜ Ø¨Û† Ø²Ø§Ù†Ø³ØªÛ Ø¯Û•Ø±Ú©Û•Ú¤ÛŒØªØŒ Ø¦Û•Ùˆ Ø¯ Ø±ÛÚ©Ø§ Ø®ÙˆØ¯Û Ø¯Ø§ÛŒÛ• Ø­Û•ØªØ§ Ø¨Ø²Ú¤Ø±ÛŒØª.", author: "Ù¾ÛØºÛ•Ù…Ø¨Û•Ø± Ù…Ø­Ù…Ø¯ (ï·º)" }, { text: "Ø³Û•Ø¨Ø± Ú©Ù„ÛŒÙ„Ø§ Ø³Û•Ø±Ú©Û•ÙØªÙ†Û ÛŒÛ•.", author: "Ú¯ÙˆØªÙ†Û•Ú©Ø§ Ø¨ Ù†Ø§Ú¤ Ùˆ Ø¯Û•Ù†Ú¯" }];
            const today = new Date(); const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 864e5);
            const quote = quotes[dayOfYear % quotes.length];
            document.getElementById('quote-text').textContent = `"${quote.text}"`; document.getElementById('quote-author').textContent = `â€” ${quote.author}`;
            
            const memorizeContainer = document.getElementById('memorize-days');
            memorizeContainer.innerHTML = DAY_NAMES.map((day, index) => `<label><input type="checkbox" name="memorize" value="${index}"><span>${day}</span></label>`).join('');
            
            const reviewContainer = document.getElementById('review-days');
            reviewContainer.innerHTML = DAY_NAMES.map((day, index) => `<label><input type="checkbox" name="review" value="${index}"><span>${day}</span></label>`).join('');

            setupEventListeners();
            setupAuthListeners();
        }

        initApp();
    });
    </script>
</body>
</html>
